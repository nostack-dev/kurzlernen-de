<!-- 
  Servicetracker App (Final)
  Ziel: Nachweis und Qualitätssicherung von Reinigungs- oder Wartungsarbeiten mittels QR-Code, Standort und Fotobeweis.
  Layout: Mobile First Design für optimale Nutzung auf Smartphones.
-->
<!DOCTYPE html>
<html lang="de" data-theme="cmyk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Servicetracker</title>
    <!-- Tailwind CSS und DaisyUI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.css" rel="stylesheet" type="text/css" />
    <!-- Google Font Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        /* Style for loading state */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .loading .loading-overlay {
            display: flex;
        }
        /* Sicherstellen, dass der Scannerbereich auf mobilen Geräten den Platz für den Stream bietet */
        #reader video {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-2 sm:p-4">

<!-- Hauptanwendung Container -->
<div id="app-container" class="w-full max-w-sm sm:max-w-lg bg-white shadow-2xl rounded-xl p-4 md:p-8 relative">

    <header class="text-center mb-6">
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Servicetracker</h1>
        <p class="text-sm text-gray-500">Für <span id="worker-display">Ihre Putz- und Reinigungskraft</span></p>
    </header>

    <!-- UI-Zustände -->
    <div id="login-screen" class="app-state">
        <h2 class="text-xl font-semibold mb-4 text-center">Login</h2>
        <div class="card bg-base-100 shadow-md p-4 sm:p-6">
            <label class="form-control w-full mb-4">
                <div class="label"><span class="label-text">Benutzername (Optional)</span></div>
                <input type="text" id="username-input" placeholder="Name der Kraft" class="input input-bordered w-full" />
            </label>
            <button onclick="simulateLoginAndInit()" class="btn btn-primary w-full text-lg">Einloggen & Starten</button>
            <p class="text-xs text-center mt-4 text-gray-400">Anonyme Anmeldung für persistente Daten.</p>
        </div>
    </div>

    <div id="scan-screen" class="app-state hidden">
        <h2 class="text-xl font-semibold mb-4 text-center">1. QR-Code Scannen</h2>
        <p class="text-center text-gray-600 mb-4 text-sm">Bitte scannen Sie den QR-Code des zu reinigenden Bereichs.</p>
        <!-- Scanner-Bereich: Optimized for mobile vertical view -->
        <div id="reader" class="w-full aspect-square max-h-[400px] mx-auto rounded-lg overflow-hidden border-2 border-primary shadow-inner mb-4"></div>
        <button id="scan-btn" onclick="startScanner()" class="btn btn-success w-full text-lg">Scanner Starten</button>
        <p class="text-center text-xs text-error mt-2">Kamera-Zugriff ist zwingend erforderlich.</p>
    </div>

    <div id="location-check-screen" class="app-state hidden text-center">
        <h2 class="text-xl font-semibold mb-4">2. Standortprüfung</h2>
        <div class="alert alert-info shadow-lg mb-4 text-sm">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <span>Wir benötigen Ihren aktuellen Standort zur Validierung.</span>
        </div>
        <button id="location-btn" onclick="checkLocation()" class="btn btn-warning w-full text-lg">Standort Abfragen</button>
        <p class="text-sm mt-2 text-error">Standortfreigabe ist zwingend erforderlich.</p>
    </div>

    <div id="capture-photos-screen" class="app-state hidden">
        <h2 class="text-xl font-semibold mb-4 text-center">3. Fotobeweise</h2>
        <div id="job-info" class="mb-4 p-3 rounded-lg bg-base-200 text-sm">
            <p class="font-bold">Auftrag:</p>
            <p id="info-text"></p>
        </div>

        <div id="photo-grid" class="grid grid-cols-2 gap-3">
            <!-- Platzhalter für 4 Fotos, 2 Spalten auf allen Geräten -->
        </div>

        <p id="photo-status" class="text-center text-sm mt-4"></p>
        <button onclick="submitJob()" class="btn btn-primary w-full mt-6 text-lg" id="submit-btn" disabled>
            Abschließen & Senden
        </button>
    </div>
    
    <div id="success-screen" class="app-state hidden text-center">
        <div class="card bg-green-100 border-green-500 border p-6 shadow-xl">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-16 h-16 text-green-500 mx-auto mb-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
            <h2 class="text-2xl font-bold text-green-700 mb-2">Arbeit Abgeschlossen!</h2>
            <p class="text-gray-700">Der Nachweis wurde erfolgreich übermittelt.</p>
            <p class="text-xs mt-4 text-gray-500">Transaktion ID: <span id="transaction-id"></span></p>
        </div>
        <button onclick="resetApp()" class="btn btn-ghost mt-6">Neue Aufgabe starten</button>
    </div>

    <!-- Modaler Dialog für Fehlermeldungen -->
    <dialog id="error_modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg text-error">Fehler!</h3>
            <p id="error-message" class="py-4 text-gray-700"></p>
            <div class="modal-action">
                <form method="dialog"><button class="btn">Schließen</button></form>
            </div>
        </div>
    </dialog>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <span class="loading loading-spinner loading-lg text-primary"></span>
    </div>

</div>

<!-- Firebase SDKs -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, collection, addDoc, Timestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Globale Variablen (MANDATORISCH)
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'servicetracker-app'; 
    
    // WICHTIG: Firebase Config wird nur benötigt, wenn Sie Daten speichern wollen.
    const FIREBASE_CONFIG_PLACEHOLDER = {};

    const firebaseConfig = typeof __firebase_config !== 'undefined' ? 
        (typeof __firebase_config === 'string' ? JSON.parse(__firebase_config) : __firebase_config) : 
        FIREBASE_CONFIG_PLACEHOLDER;
    
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    
    // Globale Variablen für Firebase und Zustand
    let app, db, auth;
    let userId = null;
    let isAuthReady = false;

    // Zustand der Anwendung
    window.appState = {
        building: null,
        area: null,
        scanTime: null,
        latitude: null,
        longitude: null,
        photos: [], // Speichert Base64-Strings der 4 Fotos
        username: 'Unbekannte Kraft',
        isLoggedIn: false
    };
    
    // **********************************************
    // FIX 1: changeState Funktion wird global (window.) definiert,
    // damit sie aus dem Modul-Skript (initFirebase) aufgerufen werden kann.
    // **********************************************
    window.changeState = function(newStateId) {
        document.querySelectorAll('.app-state').forEach(el => el.classList.add('hidden'));
        document.getElementById(newStateId).classList.remove('hidden');
        document.getElementById('app-container').classList.remove('loading'); // Lade-Indikator entfernen
    }


    // Firebase Initialisierung und Authentifizierung
    async function initFirebase() {
        
        // **ROBUSTHEIT-CHECK:** Prüfen, ob eine gültige Konfiguration existiert.
        if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.apiKey) {
            console.warn("Firebase-Konfiguration fehlt. Die App kann keine Daten speichern, fährt aber mit QR-Scan/Geolocation fort.");
            
            // Da wir keine DB haben, simulieren wir den sofortigen Login-Erfolg
            userId = 'anonymous-local';
            window.appState.isLoggedIn = true;
            isAuthReady = true;
            window.changeState('scan-screen');
            return;
        }

        try {
            setLogLevel('debug'); // Wichtig für Logs

            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            // Auth-Zustandsänderung überwachen
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    window.appState.isLoggedIn = true;
                    console.log("Benutzer angemeldet. UID:", userId);
                    isAuthReady = true;
                    
                    document.getElementById('worker-display').textContent = window.appState.username;

                    // Korrigierte Logik: Zustand auf QR-Scan wechseln, falls Login erfolgreich war
                    if (document.getElementById('app-container').classList.contains('loading')) {
                        window.changeState('scan-screen');
                    }
                } else {
                    userId = null;
                    window.appState.isLoggedIn = false;
                    isAuthReady = true; // Auth-Check abgeschlossen, auch wenn anonym
                    console.log("Kein Benutzer angemeldet. Versuche anonyme Anmeldung.");
                }
            });

            // Anmeldeversuch mit Custom Token oder anonym
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
                console.log("Erfolgreich mit Custom Token angemeldet.");
            } else {
                await signInAnonymously(auth);
                console.log("Erfolgreich anonym angemeldet.");
            }

        } catch (error) {
            console.error("Firebase Initialisierungsfehler:", error);
            window.showError(`Initialisierungsfehler: ${error.message}. (Prüfen Sie Ihre Firebase-Konfiguration)`);
            document.getElementById('app-container').classList.remove('loading');
        }
    }

    window.simulateLoginAndInit = function() {
        const usernameInput = document.getElementById('username-input').value.trim();
        if (usernameInput) {
            window.appState.username = usernameInput;
        }
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('app-container').classList.add('loading'); // Lade-Indikator
        document.getElementById('worker-display').textContent = window.appState.username; // Display username immediately
        initFirebase();
    }
    
    window.authReady = function() {
        // Ist die Authentifizierung bereit ODER haben wir den Local-Modus gewählt?
        return isAuthReady && userId;
    }

    window.db = db; // Firestore für globale Funktionen zugänglich machen
</script>

<!-- QR Code Scanner Bibliothek -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>

<script>
    // Globale Hilfsfunktionen und Zustand
    let html5QrCode = null;
    let isScannerRunning = false; // Neuer Status-Flag

    // **********************************************
    // FIX 2: showError Funktion wird global (window.) definiert. 
    // ACHTUNG: changeState wurde in den Modul-Script-Block verschoben!
    // **********************************************
    window.showError = function(message) {
        const modal = document.getElementById('error_modal');
        document.getElementById('error-message').innerText = message;
        modal.showModal();
    }

    // --- 1. QR Code Scan ---

    // NEU: Erzwingt die native Berechtigungsanfrage und startet dann den Scanner
    async function tryGetCameraPermissionAndStartScanner() {
        const scanBtn = document.getElementById('scan-btn');
        scanBtn.disabled = true;
        scanBtn.innerText = 'Kamera wird initialisiert...';

        try {
            // 1. Versuche, native Kamera-Berechtigung zu erhalten (erzwingt das Pop-up)
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            
            // Wenn erfolgreich, Stream sofort stoppen, da der QR-Scanner ihn selbst starten wird
            stream.getTracks().forEach(track => track.stop()); 
            
            console.log("Kamera-Berechtigung erfolgreich erhalten.");

            // 2. Jetzt starte den Html5Qrcode Scanner, der jetzt die Berechtigung hat.
            const readerDiv = document.getElementById("reader");
            readerDiv.innerHTML = ''; // Vorherigen Inhalt bereinigen

            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("reader");
            }
            
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            await html5QrCode.start(
                { facingMode: "environment" }, 
                config,
                (decodedText, decodedResult) => { onScanSuccess(decodedText); },
                (errorMessage) => { /* Fehler während des Scannens ignorieren */ }
            );

            isScannerRunning = true;
            scanBtn.innerText = 'Scanner Läuft...';
            scanBtn.disabled = false; // Re-aktiviere, falls Stopp notwendig
            console.log("Scanner erfolgreich gestartet.");

        } catch (err) {
            isScannerRunning = false;
            scanBtn.innerText = 'Scanner Starten';
            scanBtn.disabled = false;
            
            // Detaillierte Fehlerbehandlung
            if (err.name === 'NotAllowedError' || String(err).includes("Permission denied")) {
                window.showError("Kamerafehler: Kamerazugriff wurde VERWEIGERT oder BLOCKIERT. Bitte stellen Sie sicher, dass Sie die Berechtigung erteilt haben und die Seite über HTTPS läuft.");
            } else if (err.name === 'NotReadableError') {
                 window.showError("Kamerafehler: Die Kamera ist zurzeit von einer anderen App belegt oder nicht verfügbar.");
            } else {
                window.showError(`Kamerafehler: ${err.message}. Ein unerwarteter Fehler ist aufgetreten.`);
            }
            console.error("Kamera Startfehler (native oder html5-qrcode):", err);
        }
    }

    window.startScanner = async function() {
        if (!window.authReady()) {
             window.showError("Authentifizierung läuft noch. Bitte warten Sie einen Moment.");
             return;
        }
        
        if (isScannerRunning) {
            console.log("Scanner läuft bereits.");
            return;
        }
        
        window.changeState('scan-screen');
        await tryGetCameraPermissionAndStartScanner();
    }

    async function onScanSuccess(decodedText) {
        try {
            if (html5QrCode && isScannerRunning) {
                 // Vor dem Stoppen überprüfen, ob der Scanner läuft, um Fehler zu vermeiden
                 await html5QrCode.stop().catch(e => console.warn("Fehler beim Stoppen des Scanners ignoriert:", e));
                 isScannerRunning = false;
            }
            document.getElementById('scan-btn').innerText = 'Scanner Starten';
            document.getElementById('scan-btn').disabled = false;
            
            window.appState.scanTime = new Date();

            // QR-Code-Inhalt parsen
            const url = new URL(decodedText);
            const building = url.searchParams.get('building');
            const area = url.searchParams.get('area');

            if (building && area) {
                window.appState.building = decodeURIComponent(building);
                window.appState.area = decodeURIComponent(area);
                window.changeState('location-check-screen');
            } else {
                window.showError("Ungültiger QR-Code-Inhalt. Es fehlen 'building' oder 'area' Parameter in der URL.");
                window.changeState('scan-screen'); // Zurück zum Scannen
            }

        } catch (error) {
            console.error("Fehler nach Scan-Stopp oder URL-Parsing:", error);
            window.showError(`Fehler: Der gescannte Code ist keine gültige URL für diese App. (${error.message})`);
            window.changeState('scan-screen'); // Zurück zum Scannen
        }
    }

    // --- 2. Standortprüfung ---

    window.checkLocation = function() {
        if (!navigator.geolocation) {
            window.showError("Geolocation wird von Ihrem Gerät/Browser nicht unterstützt.");
            return;
        }

        document.getElementById('location-btn').disabled = true;
        document.getElementById('location-btn').innerText = 'Standort wird abgerufen...';

        navigator.geolocation.getCurrentPosition(
            (position) => {
                // Erfolgreiche Standortabfrage
                window.appState.latitude = position.coords.latitude;
                window.appState.longitude = position.coords.longitude;
                console.log(`Standort erfasst: Lat ${window.appState.latitude}, Lon ${window.appState.longitude}`);
                
                // Fortsetzen zur Fotoaufnahme
                setupPhotoCapture();
                
                // FIX: Leichte Verzögerung einbauen, um Rendering-Konflikte zu vermeiden
                setTimeout(() => {
                    window.changeState('capture-photos-screen');
                }, 50);

            },
            (error) => {
                // Fehler bei Standortabfrage (z.B. Benutzer verweigert)
                document.getElementById('location-btn').disabled = false;
                document.getElementById('location-btn').innerText = 'Standort Abfragen';

                let errorMessage = "Standortabfrage fehlgeschlagen. Bitte stellen Sie sicher, dass GPS aktiviert ist und Sie der App die Berechtigung erteilt haben.";
                if (error.code === error.PERMISSION_DENIED) {
                    errorMessage = "Standortzugriff verweigert. Sie müssen den Standort freigeben, um fortzufahren.";
                }

                window.showError(errorMessage);
                console.error("Geolocation Fehler:", error);
            },
            {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            }
        );
    }

    // --- 3. Fotobeweise ---

    function setupPhotoCapture() {
        const infoText = document.getElementById('info-text');
        infoText.innerHTML = `Gebäude: <span class="font-semibold">${window.appState.building}</span><br>Bereich: <span class="font-semibold text-primary">${window.appState.area}</span>`;
        
        const photoGrid = document.getElementById('photo-grid');
        photoGrid.innerHTML = '';
        window.appState.photos = []; // Reset Fotos

        for (let i = 0; i < 4; i++) {
            const photoSlot = document.createElement('div');
            photoSlot.className = 'flex flex-col items-center p-2 border rounded-lg bg-base-100 shadow-sm';
            photoSlot.innerHTML = `
                <img id="preview-${i}" class="w-full h-20 object-cover rounded-md mb-2 bg-gray-200" src="https://placehold.co/100x80/cccccc/333333?text=Foto+${i+1}" onerror="this.onerror=null;this.src='https://placehold.co/100x80/cccccc/333333?text=Foto+${i+1}';" alt="Foto ${i+1} Vorschau">
                <input type="file" accept="image/*" capture="environment" id="file-input-${i}" class="file-input file-input-xs file-input-bordered w-full" onchange="handlePhotoCapture(event, ${i})">
            `;
            photoGrid.appendChild(photoSlot);
        }
        updatePhotoStatus();
    }

    window.handlePhotoCapture = function(event, index) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const base64Image = e.target.result;
                document.getElementById(`preview-${index}`).src = base64Image;
                // Sicherstellen, dass das Array an der richtigen Stelle befüllt wird
                window.appState.photos[index] = base64Image; 
                updatePhotoStatus();
            };
            reader.readAsDataURL(file);
        } else {
            // Wenn das Foto entfernt wird, den Slot auf null setzen
            window.appState.photos[index] = null;
            document.getElementById(`preview-${index}`).src = `https://placehold.co/100x80/cccccc/333333?text=Foto+${index+1}`;
            updatePhotoStatus();
        }
    }

    function updatePhotoStatus() {
        const takenPhotos = window.appState.photos.filter(p => p !== null && p !== undefined).length;
        document.getElementById('photo-status').innerText = `Fotos aufgenommen: ${takenPhotos} von 4`;
        
        const submitBtn = document.getElementById('submit-btn');
        if (takenPhotos === 4) {
            submitBtn.disabled = false;
            submitBtn.classList.remove('btn-disabled');
        } else {
            submitBtn.disabled = true;
            submitBtn.classList.add('btn-disabled');
        }
    }

    // --- 4. Abschluss und Übermittlung ---

    window.submitJob = async function() {
        // Prüfen, ob genau 4 Fotos vorhanden sind (da Filter nicht ausreicht, muss die Länge 4 sein und kein null enthalten)
        if (window.appState.photos.length !== 4 || window.appState.photos.some(p => p === null || p === undefined) || !window.authReady()) {
            window.showError("Fehler: Nicht alle 4 Fotos vorhanden oder Benutzer nicht angemeldet.");
            return;
        }

        const submitBtn = document.getElementById('submit-btn');
        submitBtn.disabled = true;
        submitBtn.innerText = 'Wird übermittelt...';
        
        try {
            // Das Base64-Array (mit den 4 Fotos) wird in einem Firestore-Dokument gespeichert.
            const jobData = {
                userId: userId,
                workerName: window.appState.username,
                building: window.appState.building,
                area: window.appState.area,
                scanTime: Timestamp.fromDate(window.appState.scanTime),
                submissionTime: Timestamp.now(),
                location: {
                    latitude: window.appState.latitude,
                    longitude: window.appState.longitude,
                },
                photos: window.appState.photos // Base64-Strings der 4 Fotos
            };

            const jobsCollectionRef = collection(db, `artifacts/${appId}/public/data/jobs`);
            const docRef = await addDoc(jobsCollectionRef, jobData);

            console.log("Dokument erfolgreich mit ID geschrieben:", docRef.id);
            document.getElementById('transaction-id').innerText = docRef.id;
            window.changeState('success-screen');

        } catch (e) {
            console.error("Fehler beim Hinzufügen des Dokuments: ", e);
            submitBtn.disabled = false;
            submitBtn.innerText = 'Abschließen & Senden';
            window.showError(`Fehler beim Speichern des Nachweises: ${e.message}. Bitte versuchen Sie es erneut.`);
        }
    }

    window.resetApp = function() {
        // Behält Login-Daten bei, setzt aber alle Job-relevanten States zurück
        window.appState.building = null;
        window.appState.area = null;
        window.appState.scanTime = null;
        window.appState.latitude = null;
        window.appState.longitude = null;
        window.appState.photos = [];
        
        document.getElementById('transaction-id').innerText = '';
        document.getElementById('submit-btn').classList.add('btn-disabled');
        document.getElementById('submit-btn').disabled = true;
        document.getElementById('submit-btn').innerText = 'Abschließen & Senden';
        window.changeState('scan-screen');
        // Stellt sicher, dass der Scanner neu gestartet wird, wenn er in den Scan-Screen wechselt
        // startScanner() wird nicht automatisch aufgerufen, Benutzer muss klicken.
    }

    // Initialen Zustand setzen (Zeigt zuerst den Login)
    window.onload = function() {
        document.getElementById('app-container').classList.remove('loading');
        window.changeState('login-screen');
    };
</script>

</body>
</html>
