<!-- 
  Servicetracker App (Version 13 - Finale Produktion)
  Projektidee von Christian Heinrich Hohlfeld.
  Ziel: Nachweis und Qualitätssicherung von Reinigungsarbeiten. Datenabgabe via ZIP Download.
  Fokus: Resiliente UX, Material Design, ZIP Export und robuste Kamera-Logik (jsQR).
  Fix: Behebt den "Failed to construct 'URL'" Fehler.
-->
<!DOCTYPE html>
<html lang="de" data-theme="emerald">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Servicetracker V13</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.css" rel="stylesheet" type="text/css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .loading .loading-overlay { display: flex; }
        
        /* Layout für Video und Canvas (jsQR) - Sicherstellen, dass das Video im Container zentriert ist */
        #qr-video, #qr-canvas {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        #reader-container {
            position: relative;
            width: 100%; 
            aspect-ratio: 1 / 1;
            max-height: 400px;
            margin: auto;
            border-radius: 0.75rem; 
            overflow: hidden;
            border: 3px solid theme('colors.primary'); 
            box-shadow: 0 8px 15px -3px rgba(0, 0, 0, 0.2);
        }
    </style>
    <!-- Stabile QR-Code Bibliothek: jsQR -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.0.4/dist/jsQR.min.js"></script>
    <!-- Neue Bibliothek: JSZip für ZIP-Archiverstellung -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-2 sm:p-4">

<!-- Hauptanwendung Container -->
<div id="app-container" class="w-full max-w-xs sm:max-w-md bg-white shadow-2xl rounded-xl p-6 md:p-8 relative border border-gray-200">

    <header class="text-center mb-6">
        <h1 class="text-2xl font-extrabold text-gray-800">Servicetracker</h1>
        <p class="text-sm text-gray-500">Angemeldet als: <span id="worker-display" class="font-semibold text-primary">Unbekannte Kraft</span></p>
    </header>

    <!-- Inline Error Banner (ersetzt das Modal) -->
    <div id="inline-error-banner" class="alert alert-error shadow-lg p-3 text-sm mb-6 hidden border-red-400 bg-red-50">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6 text-error" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
        <span id="error-message" class="text-gray-700"></span>
        <button class="btn btn-ghost btn-sm" onclick="document.getElementById('inline-error-banner').classList.add('hidden')">Schließen</button>
    </div>

    <!-- UI-Zustände -->
    
    <div id="login-screen" class="app-state">
        <h2 class="text-xl font-semibold mb-4 text-center text-primary">Anmeldung</h2>
        <div class="card bg-gray-100 shadow-md p-5 rounded-lg border border-gray-200">
            <label class="form-control w-full mb-6">
                <div class="label"><span class="label-text text-sm font-medium">Name der Reinigungskraft</span></div>
                <input type="text" id="username-input" placeholder="Name eingeben" class="input input-bordered w-full input-sm bg-white" />
            </label>
            <button onclick="simulateLoginAndInit()" class="btn btn-primary w-full text-base font-bold shadow-lg">Einloggen & Starten</button>
            <p class="text-xs text-center mt-3 text-gray-400">Lokale Speicherung des Namens.</p>
        </div>
    </div>

    <div id="scan-screen" class="app-state hidden">
        <h2 class="text-xl font-semibold mb-4 text-center text-secondary">1. QR-Code Scannen</h2>
        <p class="text-center text-gray-600 mb-4 text-sm">Bitte halten Sie den QR-Code in die Kamera.</p>
        
        <div id="reader-container" class="shadow-xl">
            <video id="qr-video" playsinline></video>
            <canvas id="qr-canvas" style="display: none;"></canvas>
            <div id="loading-message" class="absolute inset-0 flex flex-col justify-center items-center bg-gray-900 bg-opacity-90 text-white text-sm">
                <span class="loading loading-spinner loading-lg text-white mb-2"></span>
                Kamera wird gestartet...
            </div>
        </div>

        <button id="scan-btn" onclick="startScanner()" class="btn btn-secondary w-full text-base font-bold mt-4 shadow-lg">Scanner Starten</button>
        <p class="text-center text-xs text-error mt-2">Kamera-Zugriff ist zwingend erforderlich.</p>
    </div>

    <div id="location-check-screen" class="app-state hidden text-center">
        <h2 class="text-xl font-semibold mb-4 text-warning">2. Standortprüfung</h2>
        <div class="alert alert-warning shadow-lg mb-6 text-sm flex flex-col items-center border-yellow-400 bg-yellow-50">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6 mb-2 text-warning"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <span class="text-center text-gray-700">Wir benötigen Ihren aktuellen Standort zur Validierung des Reinigungsortes.</span>
        </div>
        <button id="location-btn" onclick="checkLocation()" class="btn btn-warning w-full text-base font-bold shadow-lg">Standort Abfragen</button>
        <p class="text-sm mt-3 text-error" id="location-error-message">Standortfreigabe ist zwingend erforderlich.</p>
    </div>

    <div id="capture-photos-screen" class="app-state hidden">
        <h2 class="text-xl font-semibold mb-4 text-success text-center">3. Fotobeweise</h2>
        <div id="job-info" class="mb-4 p-3 rounded-lg bg-base-200 text-sm border border-gray-200">
            <p class="font-bold mb-1">Auftrag:</p>
            <p id="info-text" class="text-gray-700"></p>
        </div>

        <div id="photo-grid" class="grid grid-cols-2 gap-4">
            <!-- Platzhalter für 4 Fotos -->
        </div>

        <p id="photo-status" class="text-center text-sm mt-4 font-medium"></p>
        <button onclick="submitJob()" class="btn btn-primary w-full mt-6 text-base font-bold shadow-lg" id="submit-btn" disabled>
            Abschließen & ZIP-Datei Erstellen
        </button>
        <div class="alert alert-info mt-4 p-3 text-xs border-blue-400 bg-blue-50">
             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-4 h-4 text-blue-500"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
             <span class="text-gray-700">Die ZIP-Datei enthält alle Fotos und Metadaten.</span>
        </div>
    </div>
    
    <div id="success-screen" class="app-state hidden text-center">
        <div class="card bg-success/10 border-success border p-6 shadow-xl rounded-xl">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-16 h-16 text-success mx-auto mb-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
            <h2 class="text-2xl font-bold text-success mb-2">Arbeit Abgeschlossen!</h2>
            <p class="text-gray-700">Der Nachweis wurde als **ZIP-Datei** heruntergeladen.</p>
            <p class="text-xs mt-4 text-gray-500">Transaktion ID: <span id="transaction-id">N/A</span></p>
        </div>
        <button onclick="resetApp()" class="btn btn-ghost mt-6 text-base">Neue Aufgabe starten</button>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <span class="loading loading-spinner loading-lg text-primary"></span>
    </div>

</div>

<!-- GESAMTE LOGIK STARTET HIER -->
<script>
    // Globale Zustands- und Hardware-Variablen
    let videoStream = null;
    let video = document.getElementById('qr-video');
    let canvas = document.getElementById('qr-canvas');
    let canvasCtx = canvas.getContext("2d");
    let animationFrameId = null; 
    let isScannerRunning = false;
    
    window.appState = {
        building: null, area: null, address: null, 
        scanTime: null, latitude: null, longitude: null, 
        photos: [], username: 'Unbekannte Kraft', isLoggedIn: false
    };
    
    // Hilfsfunktionen (global verfügbar)
    window.showError = function(message) {
        document.getElementById('error-message').innerText = message;
        document.getElementById('inline-error-banner').classList.remove('hidden');
    }

    window.changeState = function(newStateId) {
        document.getElementById('inline-error-banner').classList.add('hidden'); // Fehler bei Statuswechsel ausblenden
        document.querySelectorAll('.app-state').forEach(el => el.classList.add('hidden'));
        document.getElementById(newStateId).classList.remove('hidden');
        document.getElementById('app-container').classList.remove('loading');
    }
    
    // Hilfsfunktion zum Konvertieren von Base64 zu ArrayBuffer/Binary (für JSZip)
    function base64ToUint8Array(base64) {
        const base64WithoutHeader = base64.split(',')[1];
        const binaryString = atob(base64WithoutHeader);
        const len = binaryString.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
            bytes[i] = binaryString.charCodeAt(i);
        }
        return bytes;
    }

    // --- 0. Login (ohne Firebase) ---

    window.simulateLoginAndInit = function() {
        const usernameInput = document.getElementById('username-input').value.trim();
        const storedName = localStorage.getItem('workerName');

        if (usernameInput) {
            window.appState.username = usernameInput;
            localStorage.setItem('workerName', usernameInput);
        } else if (storedName) {
             window.appState.username = storedName;
        } else {
             window.appState.username = 'Gast'; // Fallback
        }
        
        window.appState.isLoggedIn = true; 
        
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('worker-display').textContent = window.appState.username;
        window.changeState('scan-screen');
    }

    // --- 1. QR Code Scan (jsQR Implementierung) ---

    function stopScanner() {
        if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
        }
        if (videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
            videoStream = null;
            video.srcObject = null;
        }
        isScannerRunning = false;
        document.getElementById('loading-message').style.display = 'flex';
        document.getElementById('scan-btn').innerText = 'Scanner Starten';
        document.getElementById('scan-btn').disabled = false;
    }

    function tick() {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            document.getElementById('loading-message').style.display = 'none';

            canvas.height = video.videoHeight;
            canvas.width = video.videoWidth;
            canvasCtx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const imageData = canvasCtx.getImageData(0, 0, canvas.width, canvas.height);
            
            const code = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: "dontInvert",
            });

            if (code) {
                stopScanner();
                onScanSuccess(code.data);
                return;
            }
        }
        animationFrameId = requestAnimationFrame(tick);
    }
    
    window.startScanner = async function() {
        if (!window.appState.isLoggedIn) {
             window.showError("Bitte zuerst einloggen.");
             return;
        }
        
        if (isScannerRunning) {
            return;
        }
        
        const scanBtn = document.getElementById('scan-btn');
        scanBtn.disabled = true;
        scanBtn.innerText = 'Kamera wird initialisiert...';
        document.getElementById('loading-message').style.display = 'flex';
        window.changeState('scan-screen');

        try {
            videoStream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment' } 
            });
            
            video.srcObject = videoStream;
            video.setAttribute("playsinline", true);
            await video.play(); 

            isScannerRunning = true;
            scanBtn.innerText = 'Scanner Läuft...';
            scanBtn.disabled = false;
            
            animationFrameId = requestAnimationFrame(tick);

        } catch (err) {
            stopScanner();
            
            if (String(err).includes("jsQR is not defined")) {
                 window.showError("Schwerwiegender Fehler: Die jsQR-Bibliothek konnte nicht geladen werden.");
            } else if (err.name === 'NotAllowedError' || String(err).includes("Permission denied")) {
                window.showError("Kamerafehler: Kamerazugriff wurde verweigert. Die Seite MUSS über HTTPS laufen.");
            } else {
                window.showError(`Kamerafehler: ${err.message}.`);
            }
            console.error("Kamera Startfehler (jsQR):", err);
        }
    }

    function onScanSuccess(decodedText) {
        document.getElementById('scan-btn').innerText = 'Scanner Starten';
        document.getElementById('scan-btn').disabled = false;
        
        try {
            // FIX: Prüfen, ob der Text existiert und plausibel ist, bevor URL konstruiert wird.
            if (!decodedText || (!decodedText.startsWith('http://') && !decodedText.startsWith('https://'))) {
                throw new Error("Gescannter Text ist keine gültige URL.");
            }

            window.appState.scanTime = new Date();
            const url = new URL(decodedText);
            
            // Parsen der 3 Query-Parameter: building, area, address
            const building = url.searchParams.get('building');
            const area = url.searchParams.get('area');
            const address = url.searchParams.get('address'); 

            if (building && area && address) {
                window.appState.building = decodeURIComponent(building);
                window.appState.area = decodeURIComponent(area);
                window.appState.address = decodeURIComponent(address); 
                
                window.changeState('location-check-screen');
                // Geolocation-Fehlermeldung bei Zustandswchsel zurücksetzen
                document.getElementById('location-error-message').textContent = 'Standortfreigabe ist zwingend erforderlich.';
                document.getElementById('location-btn').disabled = false;
            } else {
                window.showError("Ungültiger QR-Code-Inhalt. Es fehlen 'building', 'area' oder 'address' Parameter in der URL.");
                window.changeState('scan-screen');
            }

        } catch (error) {
            console.error("Fehler nach Scan-Stopp oder URL-Parsing:", error);
            window.showError(`Fehler: Der gescannte Code ist keine gültige App-URL. (${error.message})`);
            window.changeState('scan-screen');
        }
    }

    // --- 2. Standortprüfung und Fotos (RESILIENZ FIX) ---

    window.checkLocation = function() {
        const locationBtn = document.getElementById('location-btn');
        const locationErrorMsg = document.getElementById('location-error-message');
        
        if (!navigator.geolocation) {
            window.showError("Geolocation wird von Ihrem Gerät/Browser nicht unterstützt.");
            return;
        }

        locationBtn.disabled = true;
        locationBtn.innerText = 'Standort wird abgerufen...';

        navigator.geolocation.getCurrentPosition(
            (position) => {
                // ERFOLG
                window.appState.latitude = position.coords.latitude;
                window.appState.longitude = position.coords.longitude;
                setupPhotoCapture();
                setTimeout(() => {
                    window.changeState('capture-photos-screen');
                }, 50);

            },
            (error) => {
                // FEHLER (Verweigerung oder Timeout)
                locationBtn.innerText = 'Standort Abfragen';
                
                let errorMessageText;

                if (error.code === error.PERMISSION_DENIED) {
                    // WICHTIG: PERMANENTE SPERRE
                    locationBtn.disabled = true; // Button permanent sperren
                    errorMessageText = "Standortzugriff VERWEIGERT. Bitte ändern Sie die Berechtigung in Ihren Browser-/Geräteeinstellungen, um fortzufahren.";
                    window.showError("Berechtigungsfehler: " + errorMessageText);
                } else {
                    // Temporäre Fehler (Timeout/unbekannt)
                    locationBtn.disabled = false; // Wiederholtes Klicken erlauben
                    errorMessageText = "Standortabfrage fehlgeschlagen. Bitte versuchen Sie es erneut (Prüfen Sie GPS-Signal).";
                    window.showError(errorMessageText);
                }
                
                locationErrorMsg.textContent = errorMessageText;
            },
            { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
        );
    }

    function setupPhotoCapture() {
        const infoText = document.getElementById('info-text');
        infoText.innerHTML = `
            Gebäude: <span class="font-semibold">${window.appState.building}</span><br>
            Bereich: <span class="font-semibold text-primary">${window.appState.area}</span><br>
            Adresse: <span class="font-semibold text-gray-600">${window.appState.address}</span>
        `; 
        
        const photoGrid = document.getElementById('photo-grid');
        photoGrid.innerHTML = '';
        window.appState.photos = [];

        for (let i = 0; i < 4; i++) {
            const photoSlot = document.createElement('div');
            photoSlot.className = 'flex flex-col items-center p-2 border border-gray-200 rounded-lg bg-base-100 shadow-sm transition-all hover:shadow-md';
            photoSlot.innerHTML = `
                <img id="preview-${i}" class="w-full h-20 object-cover rounded-md mb-2 bg-gray-200" src="https://placehold.co/100x80/cccccc/333333?text=Foto+${i+1}" onerror="this.onerror=null;this.src='https://placehold.co/100x80/cccccc/333333?text=Foto+${i+1}';" alt="Foto ${i+1} Vorschau">
                <input type="file" accept="image/*" capture="environment" id="file-input-${i}" class="file-input file-input-xs file-input-bordered w-full" onchange="handlePhotoCapture(event, ${i})">
            `;
            photoGrid.appendChild(photoSlot);
        }
        updatePhotoStatus();
    }

    window.handlePhotoCapture = function(event, index) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById(`preview-${index}`).src = e.target.result;
                window.appState.photos[index] = e.target.result; 
                updatePhotoStatus();
            };
            reader.readAsDataURL(file);
        } else {
            window.appState.photos[index] = null;
            document.getElementById(`preview-${index}`).src = `https://placehold.co/100x80/cccccc/333333?text=Foto+${index+1}`;
            updatePhotoStatus();
        }
    }

    function updatePhotoStatus() {
        const takenPhotos = window.appState.photos.filter(p => p !== null && p !== undefined).length;
        document.getElementById('photo-status').innerText = `Fotos aufgenommen: ${takenPhotos} von 4`;
        
        const submitBtn = document.getElementById('submit-btn');
        if (takenPhotos === 4) {
            submitBtn.disabled = false;
            submitBtn.classList.remove('btn-disabled');
        } else {
            submitBtn.disabled = true;
            submitBtn.classList.add('btn-disabled');
        }
    }

    // --- 4. Abschluss und ZIP Download ---

    window.submitJob = async function() {
        if (window.appState.photos.length !== 4 || window.appState.photos.some(p => p === null || p === undefined)) {
            window.showError("Fehler: Nicht alle 4 Fotos vorhanden.");
            return;
        }

        const submitBtn = document.getElementById('submit-btn');
        submitBtn.disabled = true;
        submitBtn.innerText = 'Erstelle ZIP-Datei...';
        
        try {
            const zip = new JSZip();
            
            // 1. Metadaten erstellen
            const jobData = {
                transactionId: `TX-${Date.now()}-${Math.random().toString(36).substring(2, 6).toUpperCase()}`,
                workerName: window.appState.username,
                building: window.appState.building,
                area: window.appState.area,
                address: window.appState.address, 
                scanTime: window.appState.scanTime.toISOString(),
                submissionTime: new Date().toISOString(),
                location: {
                    latitude: window.appState.latitude,
                    longitude: window.appState.longitude,
                },
                photoCount: 4 
            };
            
            // Füge Metadaten als JSON-Datei hinzu
            zip.file("metadata.json", JSON.stringify(jobData, null, 2));
            
            // 2. Fotos zur ZIP-Datei hinzufügen
            window.appState.photos.forEach((base64Image, index) => {
                // Extrahieren des Bildtyps (z.B. image/png -> png)
                const match = base64Image.match(/^data:image\/(\w+);base64,/);
                const extension = match ? match[1] : 'png';
                const photoName = `foto_${index + 1}.${extension}`;
                
                const binaryData = base64ToUint8Array(base64Image); 
                zip.file(photoName, binaryData, { binary: true });
            });

            // 3. ZIP-Datei generieren
            const content = await zip.generateAsync({ type: "blob" });

            // 4. Download auslösen
            const sanitizedBuilding = jobData.building.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 15);
            const filename = `Protokoll_${sanitizedBuilding}_${jobData.submissionTime.substring(0, 10)}.zip`;
            
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", URL.createObjectURL(content));
            downloadAnchorNode.setAttribute("download", filename);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            
            document.getElementById('transaction-id').innerText = jobData.transactionId;
            submitBtn.innerText = 'ZIP-Datei Heruntergeladen';
            window.changeState('success-screen');
            
            downloadAnchorNode.remove();
            URL.revokeObjectURL(content);


        } catch (e) {
            console.error("Fehler beim Erstellen/Download der ZIP-Datei: ", e);
            submitBtn.disabled = false;
            submitBtn.innerText = 'Abschließen & ZIP-Datei Erstellen';
            window.showError(`Fehler beim ZIP-Download: ${e.message}.`);
        }
    }

    window.resetApp = function() {
        stopScanner();
        
        window.appState.building = null; window.appState.area = null; window.appState.address = null; 
        window.appState.scanTime = null; window.appState.latitude = null; window.appState.longitude = null; window.appState.photos = [];
        
        const txIdEl = document.getElementById('transaction-id');
        if (txIdEl) txIdEl.innerText = 'N/A';
        
        document.getElementById('submit-btn').classList.add('btn-disabled');
        document.getElementById('submit-btn').disabled = true;
        document.getElementById('submit-btn').innerText = 'Abschließen & ZIP-Datei Erstellen';
        
        // Geolocation Meldung zurücksetzen und Button aktivieren
        document.getElementById('location-error-message').textContent = 'Standortfreigabe ist zwingend erforderlich.';
        document.getElementById('location-btn').disabled = false;
        
        window.changeState('scan-screen');
    }

    window.onload = function() {
        const storedName = localStorage.getItem('workerName');
        if (storedName) {
            document.getElementById('worker-display').textContent = storedName;
            window.appState.username = storedName;
            document.getElementById('username-input').value = storedName; // Name im Input befüllen
        }

        document.getElementById('app-container').classList.remove('loading');
        window.changeState('login-screen');
    };
</script>
</body>
</html>
