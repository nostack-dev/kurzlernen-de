<!-- 
  Servicetracker App (Version 5 - KEIN BACKEND - JSON EXPORT)
  Ziel: Nachweis und Qualitätssicherung von Reinigungsarbeiten. Datenabgabe erfolgt via JSON Download.
  Projektidee von Christian Heinrich Hohlfeld.
  Layout: Mobile First Design für optimale Nutzung auf Smartphones.
-->
<!DOCTYPE html>
<html lang="de" data-theme="cmyk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Servicetracker V5 (JSON Export)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.css" rel="stylesheet" type="text/css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .loading .loading-overlay { display: flex; }
        #reader video { width: 100% !important; height: 100% !important; object-fit: cover; }
    </style>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-2 sm:p-4">

<!-- Hauptanwendung Container -->
<div id="app-container" class="w-full max-w-sm sm:max-w-lg bg-white shadow-2xl rounded-xl p-4 md:p-8 relative">

    <header class="text-center mb-6">
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Servicetracker V5</h1>
        <p class="text-sm text-gray-500">Angemeldet als: <span id="worker-display">Unbekannte Kraft</span></p>
    </header>

    <!-- UI-Zustände -->
    <div id="login-screen" class="app-state">
        <h2 class="text-xl font-semibold mb-4 text-center">Login (Lokal)</h2>
        <div class="card bg-base-100 shadow-md p-4 sm:p-6">
            <label class="form-control w-full mb-4">
                <div class="label"><span class="label-text">Benutzername (Optional, lokal gespeichert)</span></div>
                <input type="text" id="username-input" placeholder="Name der Kraft" class="input input-bordered w-full" />
            </label>
            <button onclick="simulateLoginAndInit()" class="btn btn-primary w-full text-lg">Einloggen & Starten</button>
            <p class="text-xs text-center mt-4 text-gray-400">Speichert nur den Namen im Browser.</p>
        </div>
    </div>

    <div id="scan-screen" class="app-state hidden">
        <h2 class="text-xl font-semibold mb-4 text-center">1. QR-Code Scannen</h2>
        <p class="text-center text-gray-600 mb-4 text-sm">Bitte scannen Sie den QR-Code des zu reinigenden Bereichs.</p>
        <div id="reader" class="w-full aspect-square max-h-[400px] mx-auto rounded-lg overflow-hidden border-2 border-primary shadow-inner mb-4"></div>
        <button id="scan-btn" onclick="startScanner()" class="btn btn-success w-full text-lg">Scanner Starten</button>
        <p class="text-center text-xs text-error mt-2">Kamera-Zugriff ist zwingend erforderlich.</p>
    </div>

    <div id="location-check-screen" class="app-state hidden text-center">
        <h2 class="text-xl font-semibold mb-4">2. Standortprüfung</h2>
        <div class="alert alert-info shadow-lg mb-4 text-sm">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <span>Wir benötigen Ihren aktuellen Standort zur Validierung.</span>
        </div>
        <button id="location-btn" onclick="checkLocation()" class="btn btn-warning w-full text-lg">Standort Abfragen</button>
        <p class="text-sm mt-2 text-error">Standortfreigabe ist zwingend erforderlich.</p>
    </div>

    <div id="capture-photos-screen" class="app-state hidden">
        <h2 class="text-xl font-semibold mb-4 text-center">3. Fotobeweise</h2>
        <div id="job-info" class="mb-4 p-3 rounded-lg bg-base-200 text-sm">
            <p class="font-bold">Auftrag:</p>
            <p id="info-text"></p>
        </div>

        <div id="photo-grid" class="grid grid-cols-2 gap-3">
            <!-- Platzhalter für 4 Fotos -->
        </div>

        <p id="photo-status" class="text-center text-sm mt-4"></p>
        <button onclick="submitJob()" class="btn btn-primary w-full mt-6 text-lg" id="submit-btn" disabled>
            Abschließen & JSON Herunterladen
        </button>
        <div class="alert alert-warning mt-4 text-xs">Achtung: Die Datei muss manuell an den Vorgesetzten gesendet werden.</div>
    </div>
    
    <div id="success-screen" class="app-state hidden text-center">
        <div class="card bg-green-100 border-green-500 border p-6 shadow-xl">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-16 h-16 text-green-500 mx-auto mb-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
            <h2 class="text-2xl font-bold text-green-700 mb-2">Arbeit Abgeschlossen!</h2>
            <p class="text-gray-700">Der Nachweis wurde als **JSON-Datei** heruntergeladen.</p>
            <p class="text-xs mt-4 text-gray-500">Bitte senden Sie die Datei manuell weiter.</p>
        </div>
        <button onclick="resetApp()" class="btn btn-ghost mt-6">Neue Aufgabe starten</button>
    </div>

    <!-- Modaler Dialog für Fehlermeldungen -->
    <dialog id="error_modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg text-error">Fehler!</h3>
            <p id="error-message" class="py-4 text-gray-700"></p>
            <div class="modal-action">
                <form method="dialog"><button class="btn">Schließen</button></form>
            </div>
        </div>
    </dialog>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <span class="loading loading-spinner loading-lg text-primary"></span>
    </div>

</div>

<!-- GESAMTE LOGIK STARTET HIER -->
<script>
    // Globale Hilfsfunktionen und Zustand
    let html5QrCode = null;
    let isScannerRunning = false;
    
    window.appState = {
        building: null, area: null, scanTime: null, latitude: null, longitude: null, 
        photos: [], username: 'Unbekannte Kraft', isLoggedIn: false
    };
    
    // Hilfsfunktionen (global verfügbar)
    window.showError = function(message) {
        const modal = document.getElementById('error_modal');
        document.getElementById('error-message').innerText = message;
        modal.showModal();
    }

    window.changeState = function(newStateId) {
        document.querySelectorAll('.app-state').forEach(el => el.classList.add('hidden'));
        document.getElementById(newStateId).classList.remove('hidden');
        document.getElementById('app-container').classList.remove('loading');
    }

    // --- 0. Login (ohne Firebase) ---

    window.simulateLoginAndInit = function() {
        const usernameInput = document.getElementById('username-input').value.trim();
        const storedName = localStorage.getItem('workerName');

        if (usernameInput) {
            window.appState.username = usernameInput;
            localStorage.setItem('workerName', usernameInput);
        } else if (storedName) {
             window.appState.username = storedName;
        }
        
        // Da es keinen echten Login gibt, wird die Authentifizierung sofort als "bereit" markiert
        window.appState.isLoggedIn = true; 
        
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('worker-display').textContent = window.appState.username;
        window.changeState('scan-screen');
    }

    // --- 1. QR Code Scan ---
    
    async function tryGetCameraPermissionAndStartScanner() {
        const scanBtn = document.getElementById('scan-btn');
        scanBtn.disabled = true;
        scanBtn.innerText = 'Kamera wird initialisiert...';
        
        try {
            // 1. Versuche, native Kamera-Berechtigung zu erhalten (erzwingt das Pop-up)
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            stream.getTracks().forEach(track => track.stop()); 
            
            const readerDiv = document.getElementById("reader");
            readerDiv.innerHTML = ''; 

            if (!html5QrCode) {
                // FIX: Korrekte Schreibweise der globalen Klasse
                html5QrCode = new HTML5Qrcode("reader");
            }
            
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            await html5QrCode.start(
                { facingMode: "environment" }, 
                config,
                (decodedText, decodedResult) => { onScanSuccess(decodedText); },
                (errorMessage) => { /* Fehler während des Scannens ignorieren */ }
            );

            isScannerRunning = true;
            scanBtn.innerText = 'Scanner Läuft...';
            scanBtn.disabled = false;

        } catch (err) {
            isScannerRunning = false;
            scanBtn.innerText = 'Scanner Starten';
            scanBtn.disabled = false;
            
            if (String(err).includes("HTML5Qrcode is not defined") || String(err).includes("ReferenceError: HTML5Qrcode is not defined")) {
                window.showError("Schwerwiegender Fehler: Die QR-Code-Bibliothek konnte nicht geladen werden. Bitte Cache leeren oder Internetverbindung prüfen.");
            } else if (err.name === 'NotAllowedError' || String(err).includes("Permission denied")) {
                window.showError("Kamerafehler: Kamerazugriff wurde verweigert. Bitte stellen Sie sicher, dass Sie die Berechtigung erteilt haben und die Seite über HTTPS läuft.");
            } else {
                window.showError(`Kamerafehler: ${err.message}. Ein unerwarteter Fehler ist aufgetreten.`);
            }
            console.error("Kamera Startfehler (final):", err);
        }
    }

    window.startScanner = async function() {
        if (!window.appState.isLoggedIn) {
             window.showError("Bitte zuerst einloggen.");
             return;
        }
        
        if (isScannerRunning) {
            return;
        }
        
        window.changeState('scan-screen');
        await tryGetCameraPermissionAndStartScanner();
    }

    async function onScanSuccess(decodedText) {
        if (html5QrCode && isScannerRunning) {
            await html5QrCode.stop().catch(e => console.warn("Fehler beim Stoppen des Scanners ignoriert:", e));
            isScannerRunning = false;
        }
        document.getElementById('scan-btn').innerText = 'Scanner Starten';
        document.getElementById('scan-btn').disabled = false;
        
        try {
            window.appState.scanTime = new Date();
            const url = new URL(decodedText);
            
            // NEU: Building und Area werden direkt aus der URL gezogen (KEIN LOOKUP)
            const building = url.searchParams.get('building');
            const area = url.searchParams.get('area');

            if (building && area) {
                window.appState.building = decodeURIComponent(building);
                window.appState.area = decodeURIComponent(area);
                window.changeState('location-check-screen');
            } else {
                window.showError("Ungültiger QR-Code-Inhalt. Es fehlen 'building' oder 'area' Parameter in der URL.");
                window.changeState('scan-screen');
            }

        } catch (error) {
            console.error("Fehler nach Scan-Stopp oder URL-Parsing:", error);
            window.showError(`Fehler: Der gescannte Code ist keine gültige App-URL. (${error.message})`);
            window.changeState('scan-screen');
        }
    }

    // --- 2. Standortprüfung und Fotos ---

    window.checkLocation = function() {
        if (!navigator.geolocation) {
            window.showError("Geolocation wird von Ihrem Gerät/Browser nicht unterstützt.");
            return;
        }

        document.getElementById('location-btn').disabled = true;
        document.getElementById('location-btn').innerText = 'Standort wird abgerufen...';

        navigator.geolocation.getCurrentPosition(
            (position) => {
                window.appState.latitude = position.coords.latitude;
                window.appState.longitude = position.coords.longitude;
                setupPhotoCapture();
                setTimeout(() => {
                    window.changeState('capture-photos-screen');
                }, 50);

            },
            (error) => {
                document.getElementById('location-btn').disabled = false;
                document.getElementById('location-btn').innerText = 'Standort Abfragen';
                let errorMessage = "Standortabfrage fehlgeschlagen. Bitte stellen Sie sicher, dass Sie die Berechtigung erteilt haben.";
                if (error.code === error.PERMISSION_DENIED) {
                    errorMessage = "Standortzugriff verweigert. Sie müssen den Standort freigeben, um fortzufahren.";
                }
                window.showError(errorMessage);
            },
            { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
        );
    }

    function setupPhotoCapture() {
        const infoText = document.getElementById('info-text');
        infoText.innerHTML = `Gebäude: <span class="font-semibold">${window.appState.building}</span><br>Bereich: <span class="font-semibold text-primary">${window.appState.area}</span>`;
        
        const photoGrid = document.getElementById('photo-grid');
        photoGrid.innerHTML = '';
        window.appState.photos = [];

        for (let i = 0; i < 4; i++) {
            const photoSlot = document.createElement('div');
            photoSlot.className = 'flex flex-col items-center p-2 border rounded-lg bg-base-100 shadow-sm';
            photoSlot.innerHTML = `
                <img id="preview-${i}" class="w-full h-20 object-cover rounded-md mb-2 bg-gray-200" src="https://placehold.co/100x80/cccccc/333333?text=Foto+${i+1}" onerror="this.onerror=null;this.src='https://placehold.co/100x80/cccccc/333333?text=Foto+${i+1}';" alt="Foto ${i+1} Vorschau">
                <input type="file" accept="image/*" capture="environment" id="file-input-${i}" class="file-input file-input-xs file-input-bordered w-full" onchange="handlePhotoCapture(event, ${i})">
            `;
            photoGrid.appendChild(photoSlot);
        }
        updatePhotoStatus();
    }

    window.handlePhotoCapture = function(event, index) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById(`preview-${index}`).src = e.target.result;
                window.appState.photos[index] = e.target.result; 
                updatePhotoStatus();
            };
            reader.readAsDataURL(file);
        } else {
            window.appState.photos[index] = null;
            document.getElementById(`preview-${index}`).src = `https://placehold.co/100x80/cccccc/333333?text=Foto+${index+1}`;
            updatePhotoStatus();
        }
    }

    function updatePhotoStatus() {
        const takenPhotos = window.appState.photos.filter(p => p !== null && p !== undefined).length;
        document.getElementById('photo-status').innerText = `Fotos aufgenommen: ${takenPhotos} von 4`;
        
        const submitBtn = document.getElementById('submit-btn');
        if (takenPhotos === 4) {
            submitBtn.disabled = false;
            submitBtn.classList.remove('btn-disabled');
        } else {
            submitBtn.disabled = true;
            submitBtn.classList.add('btn-disabled');
        }
    }

    // --- 4. Abschluss und Download ---

    window.submitJob = async function() {
        if (window.appState.photos.length !== 4 || window.appState.photos.some(p => p === null || p === undefined)) {
            window.showError("Fehler: Nicht alle 4 Fotos vorhanden.");
            return;
        }

        const submitBtn = document.getElementById('submit-btn');
        submitBtn.disabled = true;
        submitBtn.innerText = 'Erstelle JSON...';
        
        try {
            // JSON Payload erstellen
            const jobData = {
                transactionId: `TX-${Date.now()}-${Math.random().toString(36).substring(2, 6).toUpperCase()}`,
                workerName: window.appState.username,
                building: window.appState.building,
                area: window.appState.area,
                scanTime: window.appState.scanTime.toISOString(),
                submissionTime: new Date().toISOString(),
                location: {
                    latitude: window.appState.latitude,
                    longitude: window.appState.longitude,
                },
                // Fotos als Base64 sind hier enthalten
                photosBase64: window.appState.photos
            };

            const filename = `Protokoll_${jobData.building.replace(/[^a-zA-Z0-9]/g, '_')}_${jobData.submissionTime.substring(0, 10)}.json`;
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(jobData, null, 2));
            
            // Download auslösen
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", filename);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();

            document.getElementById('transaction-id').innerText = jobData.transactionId;
            window.changeState('success-screen');

        } catch (e) {
            console.error("Fehler beim Erstellen/Download des Dokuments: ", e);
            submitBtn.disabled = false;
            submitBtn.innerText = 'Abschließen & JSON Herunterladen';
            window.showError(`Fehler beim Download: ${e.message}.`);
        }
    }

    window.resetApp = function() {
        window.appState.building = null; window.appState.area = null; window.appState.scanTime = null;
        window.appState.latitude = null; window.appState.longitude = null; window.appState.photos = [];
        
        document.getElementById('transaction-id').innerText = '';
        document.getElementById('submit-btn').classList.add('btn-disabled');
        document.getElementById('submit-btn').disabled = true;
        document.getElementById('submit-btn').innerText = 'Abschließen & JSON Herunterladen';
        window.changeState('scan-screen');
    }

    window.onload = function() {
        // Initialen Zustand setzen und Name aus LocalStorage laden
        const storedName = localStorage.getItem('workerName');
        if (storedName) {
            document.getElementById('worker-display').textContent = storedName;
            window.appState.username = storedName;
        }

        document.getElementById('app-container').classList.remove('loading');
        window.changeState('login-screen');
    };
</script>
</body>
</html>
