<!-- 
  QR Code Generator für Standorte und Bereiche (Version 21 - Finaler Build, ohne Maps API)
  Projektidee von Christian Heinrich Hohlfeld.
  Ziel: Entfernung der Google Maps API zur Vermeidung von Billing-Anforderungen. Die Adresseingabe ist wieder ein Standard-Textfeld.
  Fokus: UX, Konsistenz, Unabhängigkeit.
-->
<!DOCTYPE html>
<html lang="de" data-theme="emerald">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Generator V21</title>
    <!-- Tailwind CSS und DaisyUI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.css" rel="stylesheet" type="text/css" />
    <!-- Google Font Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .card { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        /* Stil für den druckbaren Bereich */
        @media print {
            body > :not(#printable-area) { display: none !important; }
            #printable-area {
                display: block; width: 100%; margin: 0; padding: 20px; box-shadow: none;
                page-break-after: always; /* Für mehrere Codes auf separaten Seiten */
            }
        }
        /* Fix für Listen-Buttons im Modal */
        .area-item {
             display: flex; justify-content: space-between; align-items: center; padding: 8px 12px;
             border: 1px solid #e5e7eb; border-radius: 6px; margin-bottom: 6px;
        }
    </style>
    <!-- QR Code Bibliothek -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <!-- Die Maps API wurde entfernt -->
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center justify-start p-2 sm:p-4">

<!-- Generator Container -->
<div class="w-full max-w-sm sm:max-w-xl bg-white shadow-2xl rounded-xl p-6 md:p-8 mt-5 sm:mt-10 border border-gray-200">

    <header class="text-center mb-6">
        <h1 class="text-2xl font-bold text-gray-800">Standort QR Code Generator</h1>
        <p class="text-sm text-gray-500">Hierarchische Verwaltung (Objekt & Bereiche)</p>
    </header>

    <!-- Inline Toast Message für Status (ersetzt Modal) -->
    <div id="toast-message" class="alert alert-success shadow-lg p-3 text-sm mb-4 hidden border-green-400 bg-green-50">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6 text-success" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
        <span id="toast-text" class="text-gray-700"></span>
    </div>
    
    <!-- Projektverwaltung -->
    <div class="card bg-base-100 shadow-md p-4 mb-6 border border-gray-200">
        <h2 class="text-xl font-semibold mb-4 text-primary">Standortverwaltung</h2>
        
        <!-- Objekt Selektor -->
        <label class="form-control w-full mb-4">
            <div class="label"><span class="label-text font-semibold text-sm">Aktives Objekt (Verwaltungseinheit)</span></div>
            <select id="building-selector" class="select select-bordered select-md w-full" onchange="switchBuilding(this.value)">
                <!-- Optionen werden via JavaScript befüllt -->
            </select>
        </label>
        
        <!-- Bereich Selektor (wichtig für die QR Code URL) -->
        <label class="form-control w-full mb-4">
            <div class="label"><span class="label-text font-semibold text-sm">Aktiver Bereich zur QR-Code Generierung</span></div>
            <select id="area-selector" class="select select-bordered select-md w-full" onchange="switchArea(this.value)">
                <!-- Optionen werden via JavaScript befüllt -->
            </select>
        </label>

        <!-- Aktionen: Bearbeiten, Neu, Export -->
        <div class="flex flex-wrap gap-2 justify-between mt-2">
            <button onclick="openEditModal(currentBuildingId)" class="btn btn-sm btn-info btn-outline whitespace-nowrap">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                Details / Bereiche bearbeiten
            </button>
            <button onclick="newObject()" class="btn btn-sm btn-secondary whitespace-nowrap">
                + Neues Objekt hinzufügen
            </button>
        </div>
        
        <!-- Subtile Löschen/Import-Aktionen -->
        <div class="flex flex-wrap gap-2 justify-between mt-4 border-t border-gray-200 pt-3">
             <button onclick="exportProjects()" class="btn btn-sm btn-success btn-outline whitespace-nowrap">
                Export (JSON)
            </button>
            <button onclick="window.importInitiate()" class="btn btn-sm btn-warning btn-outline whitespace-nowrap" id="import-btn">
                Import (JSON)
            </button>
            <button onclick="clearAllProjects()" class="btn btn-xs btn-ghost text-error whitespace-nowrap">
                Alle löschen (Local)
            </button>
        </div>
    </div>

    <!-- QR Code Anzeige und Druckbereich -->
    <div class="mt-6 p-4 border-t border-gray-200">
        <h2 class="text-xl font-semibold mb-4 text-center">QR Code Generierung</h2>
        
        <button onclick="generateQRCode(true)" class="btn btn-primary w-full text-lg shadow-lg">QR Code Generieren & Anzeigen</button>

        <div id="printable-area" class="bg-white p-6 rounded-lg shadow-inner text-center hidden flex flex-col items-center mt-6 border border-gray-300">
            <div id="qrcode-container" class="mb-4">
                <!-- QR Code wird hier generiert -->
            </div>
            <p id="qr-building-display" class="text-xl font-bold mb-0 text-gray-800"></p>
            <p id="qr-area-display" class="text-lg text-primary mb-2"></p>
            <p id="qr-address-display" class="text-sm text-gray-600 mb-4"></p>
            <p class="text-xs text-gray-500">Scannen für Arbeitsnachweis</p>
        </div>

        <div id="qr-url-display" class="mt-4 p-3 bg-gray-100 rounded-lg hidden w-full border border-gray-200">
            <p class="text-xs font-semibold mb-1 text-gray-700">Codierte URL:</p>
            <p id="full-url-text" class="text-xs text-gray-600 font-mono break-all"></p>
            <p class="text-xs font-semibold mt-3 mb-1 text-gray-700">Maps Link:</p>
            <a id="maps-link" target="_blank" class="text-xs text-blue-500 hover:underline break-all"></a>
        </div>

        <button id="print-btn" onclick="window.print()" class="btn btn-success w-full mt-6 text-lg hidden shadow-lg">
            Drucken (mit Standortdaten)
        </button>
    </div>

</div>

<!-- MODAL FÜR BEARBEITUNG/OBJEKT-EDITOR -->
<dialog id="edit-modal" class="modal">
    <div class="modal-box bg-white p-6 shadow-2xl max-w-lg">
        <h3 id="modal-title" class="font-bold text-xl mb-4 text-secondary">Objekt-Editor</h3>
        
        <!-- Objekt / Adressfelder -->
        <label class="form-control w-full mb-3">
            <div class="label"><span class="label-text font-semibold text-sm">Objektname (z.B. Hauptsitz, Lagerhalle A)</span></div>
            <input type="text" id="modal-building-input" placeholder="Neues Objekt" class="input input-bordered w-full input-md" data-default="Neues Objekt" oninput="validateModal()" onfocus="clearPlaceholder(this)" />
            <p id="error-building" class="text-error text-xs mt-1 hidden">Objektname ist erforderlich.</p>
        </label>

        <label class="form-control w-full mb-6">
            <div class="label"><span class="label-text font-semibold text-sm">Adresse (Straße, PLZ, Stadt)</span></div>
            <!-- Das Input-Feld ist jetzt ein Standard-Textfeld -->
            <input type="text" id="modal-address-input" placeholder="Adresse eingeben" class="input input-bordered w-full input-md" data-default="Adresse eingeben" oninput="validateModal()" onfocus="clearPlaceholder(this)" />
            <p id="error-address" class="text-error text-xs mt-1 hidden">Adresse ist erforderlich.</p>
            <p class="text-xs text-gray-500 mt-1">Für den Maps-Link im QR-Code (keine automatische Adressprüfung).</p>
        </label>
        
        <!-- Bereichsverwaltung -->
        <div class="mt-8 pt-4 border-t border-gray-200">
            <h4 class="font-bold text-lg mb-3 flex justify-between items-center">
                Bereichs-Liste
                <button onclick="addAreaToModal()" class="btn btn-sm btn-success">
                    + Bereich hinzufügen
                </button>
            </h4>
            
            <div id="area-list-container" class="space-y-2 max-h-48 overflow-y-auto pr-2">
                <!-- Dynamische Bereichs-Eingabefelder kommen hier rein -->
            </div>
            <p id="error-areas" class="text-error text-xs mt-3 hidden">Mindestens ein Bereich ist erforderlich.</p>
        </div>
        
        <div class="modal-action flex justify-between mt-6 border-t pt-4 border-gray-200">
            <!-- Neuer Button für das Löschen des Objekts -->
            <button onclick="confirmDeleteObject()" class="btn btn-error btn-outline">Objekt löschen</button>

            <div class="flex gap-3">
                <button onclick="document.getElementById('edit-modal').close()" class="btn btn-ghost">Abbrechen</button>
                <button onclick="saveAndCloseModal()" class="btn btn-primary" id="save-modal-btn" disabled>Speichern & Schließen</button>
            </div>
        </div>
    </div>
</dialog>

<!-- MODAL FÜR LÖSCHBESTÄTIGUNG -->
<dialog id="delete-confirm-modal" class="modal">
    <div class="modal-box bg-white p-6 shadow-2xl">
        <h3 class="font-bold text-xl mb-4 text-error">⚠️ Löschbestätigung</h3>
        <p class="mb-4 text-gray-700">Wollen Sie das Objekt "<span id="delete-building-name" class="font-bold text-error"></span>" WIRKLICH löschen?</p>
        <p class="text-sm text-gray-500">Alle zugehörigen Bereiche und Daten gehen dabei verloren.</p>

        <div class="modal-action">
            <button onclick="document.getElementById('delete-confirm-modal').close()" class="btn btn-ghost">Abbrechen</button>
            <button onclick="deleteBuilding(currentBuildingId)" class="btn btn-error">Ja, endgültig löschen</button>
        </div>
    </div>
</dialog>


<!-- MODAL FÜR IMPORTERSTELLUNG (WIRD NUR GEÖFFNET) -->
<dialog id="import-modal" class="modal">
    <div class="modal-box bg-white p-6 shadow-2xl">
        <h3 class="font-bold text-xl mb-4 text-warning">Projekt-Import</h3>
        <p class="mb-4 text-gray-700">Wählen Sie die JSON-Datei, die Sie zuvor exportiert haben, um die Projekte zu importieren (vorhandene Projekte werden überschrieben).</p>
        
        <label class="form-control w-full mb-4">
            <input type="file" accept=".json" class="file-input file-input-bordered file-input-md w-full" onchange="importProjects(event); document.getElementById('import-modal').close();" />
        </label>

        <div class="modal-action">
            <button onclick="document.getElementById('import-modal').close()" class="btn">Abbrechen</button>
        </div>
    </div>
</dialog>

<script>
    // Globale Zustandsvariablen
    const STORAGE_KEY = 'ch_hohlfeld_qr_projects';
    const BASE_URL_HARDCODED = 'https://kurzlernen.de/servicetracker.html'; 

    let projects = []; // Array von Objekt-Objekten
    let currentBuildingId = null; // Stellt das aktive Objekt dar
    let currentAreaId = null; // Stellt den aktiven Bereich dar
    let qrcode = null;

    // Speichert temporäre Daten während der Modal-Bearbeitung
    let tempBuildingData = {}; 

    // --- Utility Funktionen ---

    function generateUUID() {
        return 'id-' + Date.now().toString(36) + Math.random().toString(36).substring(2);
    }

    function findBuilding(id) {
        return projects.find(b => b.id === id);
    }
    
    function findArea(buildingId, areaId) {
        const building = findBuilding(buildingId);
        return building ? building.areas.find(a => a.id === areaId) : null;
    }

    function showToast(message, isError = false) {
        const toast = document.getElementById('toast-message');
        const toastText = document.getElementById('toast-text');
        
        toastText.innerText = message;
        toast.classList.remove('hidden', 'alert-success', 'alert-error');
        toast.classList.add(isError ? 'alert-error' : 'alert-success');
        
        setTimeout(() => {
            toast.classList.add('hidden');
        }, 5000);
    }
    
    window.clearPlaceholder = function(input) {
        if (input.value === input.getAttribute('data-default')) {
            input.value = '';
        }
    }

    // --- Laden und Speichern (LocalStorage) ---

    function loadProjects() {
        const stored = localStorage.getItem(STORAGE_KEY);
        try {
            projects = stored ? JSON.parse(stored) : [];
        } catch (e) {
            console.error("Fehler beim Parsen der Projekte aus LocalStorage:", e);
            projects = [];
        }
        
        if (projects.length === 0) {
            createNewObjectAndArea(true); // Erstellt Standardprojekt
        }
        
        // Setze die aktuelle Auswahl
        if (!currentBuildingId || !findBuilding(currentBuildingId)) {
            currentBuildingId = projects[0].id;
        }
        
        const activeBuilding = findBuilding(currentBuildingId);
        
        if (activeBuilding && activeBuilding.areas && activeBuilding.areas.length > 0) {
             // Wähle entweder den alten AreaId oder den ersten Bereich
             currentAreaId = activeBuilding.areas.find(a => a.id === currentAreaId) ? currentAreaId : activeBuilding.areas[0].id;
        } else if (activeBuilding) {
             currentAreaId = null;
        }
        
        // Bereinigung, falls Daten korrupt sind
        if (!currentBuildingId || !activeBuilding || (activeBuilding.areas.length === 0 && projects.length > 0)) {
             localStorage.removeItem(STORAGE_KEY);
             projects = [];
             createNewObjectAndArea(true);
             currentBuildingId = projects[0].id;
             currentAreaId = projects[0].areas[0].id;
             
             // Nur beim Start, nicht während des normalen Flows toasten
             if (stored && stored.length > 0) {
                  showToast("Fehlerhafte lokale Daten bereinigt und neues Objekt erstellt.", true);
             }
        }
    }

    function saveProjects() {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(projects));
            renderSelectors();
        } catch (e) {
            showToast("Fehler beim Speichern der Projekte. Speicher voll?", true);
            console.error("Fehler beim Speichern der Projekte in LocalStorage:", e);
        }
    }
    
    // Erstellt ein neues Objekt mit einem Standardbereich
    function createNewObjectAndArea(isInitial = false) {
        const newBuildingId = generateUUID();
        const newAreaId = generateUUID();
        
        const newBuilding = {
            id: newBuildingId,
            building: 'Neues Objekt',
            address: 'Adresse eingeben',
            areas: [{ id: newAreaId, area: 'Neuer Bereich' }]
        };
        
        projects.push(newBuilding);
        currentBuildingId = newBuildingId;
        currentAreaId = newAreaId;
        
        if (!isInitial) {
            saveProjects();
            // Die Meldung erscheint im Modal, nicht als Toast
        }
    }
    
    window.newObject = function() {
        createNewObjectAndArea();
        openEditModal(currentBuildingId);
        showToast("Neues Objekt wurde erstellt. Bitte bearbeiten Sie die Details.");
    }

    // --- UI Rendering und Auswahl ---

    function renderSelectors() {
        const buildingSelector = document.getElementById('building-selector');
        const areaSelector = document.getElementById('area-selector');

        // 1. Objekt-Selektor füllen
        buildingSelector.innerHTML = '';
        projects.forEach(building => {
            const option = document.createElement('option');
            option.value = building.id;
            option.textContent = building.building;
            if (building.id === currentBuildingId) { option.selected = true; }
            buildingSelector.appendChild(option);
        });
        
        // 2. Bereich-Selektor füllen (basierend auf aktivem Objekt)
        areaSelector.innerHTML = '';
        const activeBuilding = findBuilding(currentBuildingId);

        if (activeBuilding && activeBuilding.areas) {
            activeBuilding.areas.forEach(area => {
                const option = document.createElement('option');
                option.value = area.id;
                option.textContent = area.area;
                if (area.id === currentAreaId) { option.selected = true; }
                areaSelector.appendChild(option);
            });
        }
        
        generateQRCode(false);
    }

    window.switchBuilding = function(buildingId) {
        currentBuildingId = buildingId;
        const building = findBuilding(buildingId);
        
        // Setze den aktiven Bereich auf den ersten Bereich des neuen Objekts
        if (building && building.areas && building.areas.length > 0) {
            currentAreaId = building.areas[0].id; 
        } else {
            currentAreaId = null;
        }
        
        saveProjects(); 
        renderSelectors();
    }

    window.switchArea = function(areaId) {
        currentAreaId = areaId;
        saveProjects();
        renderSelectors();
    }

    // --- Modal Objekt-Editor Logik ---
    
    window.openEditModal = function(buildingId) {
        const building = findBuilding(buildingId);
        if (!building) {
            showToast("FEHLER: Objekt nicht gefunden. Erstellen Sie ein neues Objekt.", true);
            return;
        }

        // Deep-Kopie für temporäre Bearbeitung
        tempBuildingData = JSON.parse(JSON.stringify(building));
        
        // Felder befüllen (setzt den Wert)
        document.getElementById('modal-building-input').value = building.building;
        document.getElementById('modal-address-input').value = building.address;
        
        renderAreaList();
        validateModal(); 
        document.getElementById('edit-modal').showModal();
    }
    
    // --- LÖSCH-LOGIK ---

    window.confirmDeleteObject = function() {
        const building = findBuilding(currentBuildingId);
        if (!building) return;

        // Namen im Bestätigungs-Modal anzeigen
        document.getElementById('delete-building-name').innerText = building.building;
        
        document.getElementById('edit-modal').close(); // Editor schließen
        document.getElementById('delete-confirm-modal').showModal(); // Bestätigung öffnen
    }

    window.deleteBuilding = function(buildingId) {
        if (projects.length <= 1) {
            showToast("FEHLER: Sie können das letzte Objekt nicht löschen.", true);
            document.getElementById('delete-confirm-modal').close();
            return;
        }

        const deletedBuilding = findBuilding(buildingId);
        
        // Objekt aus der Liste entfernen
        projects = projects.filter(p => p.id !== buildingId);
        
        // Nächstes Objekt auswählen
        currentBuildingId = projects[0].id;
        currentAreaId = projects[0].areas[0].id;

        saveProjects();
        renderSelectors();
        
        document.getElementById('delete-confirm-modal').close();
        showToast(`Objekt "${deletedBuilding.building}" wurde erfolgreich gelöscht.`, true);
    }
    
    // --- BEREICH-LISTE LOGIK ---

    function renderAreaList() {
        const container = document.getElementById('area-list-container');
        container.innerHTML = '';
        
        tempBuildingData.areas.forEach((area) => {
            const item = document.createElement('div');
            item.className = 'area-item bg-gray-50 hover:bg-white';
            item.innerHTML = `
                <input 
                    type="text" 
                    value="${area.area}" 
                    id="area-input-${area.id}" 
                    class="input input-ghost input-sm w-full font-medium" 
                    placeholder="Bereichsname eingeben"
                    oninput="updateTempAreaName('${area.id}', this.value); validateModal()"
                />
                <button 
                    onclick="removeAreaFromModal('${area.id}')" 
                    class="btn btn-error btn-xs ml-2 text-white"
                    title="Bereich löschen"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            `;
            container.appendChild(item);
        });
    }

    window.addAreaToModal = function() {
        tempBuildingData.areas.push({
            id: generateUUID(),
            area: 'Neuer Bereich (noch nicht gespeichert)'
        });
        renderAreaList();
        validateModal();
        // Optional: Fokussiere das neue Input-Feld, wenn hinzugefügt
        const lastAreaId = tempBuildingData.areas[tempBuildingData.areas.length - 1].id;
        document.getElementById(`area-input-${lastAreaId}`).focus();
    }

    window.removeAreaFromModal = function(areaId) {
        if (tempBuildingData.areas.length <= 1) {
            showToast("FEHLER: Ein Objekt muss mindestens einen Bereich haben.", true);
            return;
        }
        tempBuildingData.areas = tempBuildingData.areas.filter(a => a.id !== areaId);
        renderAreaList();
        validateModal();
    }
    
    window.updateTempAreaName = function(areaId, newName) {
        const area = tempBuildingData.areas.find(a => a.id === areaId);
        if (area) {
            area.area = newName;
        }
    }

    window.validateModal = function() {
        const buildingInput = document.getElementById('modal-building-input').value.trim();
        const addressInput = document.getElementById('modal-address-input').value.trim();
        
        let isValid = true;
        
        // 1. Validierung der Objektfelder
        if (!buildingInput || buildingInput === document.getElementById('modal-building-input').getAttribute('data-default')) {
            document.getElementById('error-building').classList.remove('hidden'); isValid = false;
        } else { document.getElementById('error-building').classList.add('hidden'); }
        
        if (!addressInput || addressInput === document.getElementById('modal-address-input').getAttribute('data-default')) {
            document.getElementById('error-address').classList.remove('hidden'); isValid = false;
        } else { document.getElementById('error-address').classList.add('hidden'); }
        
        // 2. Validierung der Bereiche (darf nicht leer sein)
        const validAreas = tempBuildingData.areas.filter(a => a.area && a.area.trim() !== '' && a.area.trim() !== 'Neuer Bereich (noch nicht gespeichert)');
        
        if (validAreas.length === 0) {
             document.getElementById('error-areas').classList.remove('hidden'); isValid = false;
        } else { document.getElementById('error-areas').classList.add('hidden'); }

        document.getElementById('save-modal-btn').disabled = !isValid;
    }

    window.saveAndCloseModal = function() {
        // Sicherstellen, dass die Validierung aktuell ist
        validateModal();
        if (document.getElementById('save-modal-btn').disabled) return; 

        const buildingInput = document.getElementById('modal-building-input').value.trim();
        const addressInput = document.getElementById('modal-address-input').value.trim();
        
        // 1. Filter ungültiger Bereiche aus der temporären Liste
        tempBuildingData.areas = tempBuildingData.areas.filter(a => a.area && a.area.trim() !== '' && a.area.trim() !== 'Neuer Bereich (noch nicht gespeichert)');

        // 2. Objekt in die Hauptliste übernehmen
        const targetBuildingIndex = projects.findIndex(p => p.id === tempBuildingData.id);

        if (targetBuildingIndex !== -1) {
            // Objekt existiert: Details aktualisieren
            projects[targetBuildingIndex].building = buildingInput;
            projects[targetBuildingIndex].address = addressInput;
            projects[targetBuildingIndex].areas = tempBuildingData.areas;

            // Stelle sicher, dass der aktuelle AreaId noch gültig ist (falls er gelöscht wurde)
            if (!findArea(currentBuildingId, currentAreaId)) {
                currentAreaId = projects[targetBuildingIndex].areas[0].id;
            }

            showToast(`Objekt "${buildingInput}" und seine Bereiche gespeichert.`);

        } else {
            // Neues Objekt
            projects.push(tempBuildingData);
            currentBuildingId = tempBuildingData.id;
            currentAreaId = tempBuildingData.areas[0].id;
            showToast(`Neues Objekt "${buildingInput}" erfolgreich hinzugefügt.`);
        }

        saveProjects();
        document.getElementById('edit-modal').close();
    }

    // --- Export, Import und Löschen ---
    
    window.clearAllProjects = function() {
        if (confirm("WARNUNG: Möchten Sie WIRKLICH alle gespeicherten Projekte (Objekte und Bereiche) im lokalen Speicher löschen? Diese Aktion kann NICHT rückgängig gemacht werden.")) {
            localStorage.removeItem(STORAGE_KEY);
            projects = [];
            currentBuildingId = null;
            currentAreaId = null;
            loadProjects(); // App in sauberen Zustand zurücksetzen
            renderSelectors();
            showToast("Alle Projekte erfolgreich gelöscht.", true);
        }
    }
    
    window.importInitiate = function() {
        document.getElementById('import-modal').showModal();
    }

    window.exportProjects = function() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(projects, null, 2));
        const downloadAnchorNode = document.createElement('a');
        const filename = `QR_Projekte_Christian_${new Date().toISOString().slice(0, 10)}.json`; 
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", filename);
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
        
        showToast(`Alle ${projects.length} Objekte und ihre Bereiche wurden erfolgreich exportiert.`);
    }
    
    window.importProjects = function(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedData = JSON.parse(e.target.result);

                // Einfache Validierung der Struktur
                if (!Array.isArray(importedData) || importedData.length === 0 || importedData.some(b => !b.id || !b.building || !b.areas || !Array.isArray(b.areas) || b.areas.length === 0)) {
                    throw new Error("Die importierte Datei ist kein gültiges QR-Projekt-Array im erwarteten hierarchischen Format.");
                }

                projects = importedData;
                currentBuildingId = projects[0].id;
                currentAreaId = projects[0].areas[0].id;
                
                saveProjects(); 
                switchBuilding(currentBuildingId); 

                showToast(`Erfolgreich ${projects.length} Objekte und alle zugehörigen Bereiche importiert.`);

            } catch (error) {
                console.error("Importfehler:", error);
                showToast(`Fehler beim Importieren der Datei: ${error.message}`, true);
            } finally {
                event.target.value = null; 
            }
        };
        reader.readAsText(file);
    }

    // --- QR Code Generierung ---

    window.generateQRCode = function(showToastFlag = false) {
        const building = findBuilding(currentBuildingId);
        const area = findArea(currentBuildingId, currentAreaId);

        // Validierung
        if (!building || !area || !building.building || !area.area || !building.address) {
            if (showToastFlag) {
                 showToast('FEHLER: Bitte füllen Sie alle Standortdetails aus, bevor Sie den QR-Code generieren.', true);
            }
            document.getElementById('printable-area').classList.add('hidden');
            document.getElementById('print-btn').classList.add('hidden');
            document.getElementById('qr-url-display').classList.add('hidden');
            return;
        }
        
        let baseUrl = BASE_URL_HARDCODED;
        if (baseUrl.includes('?')) {
             baseUrl = baseUrl.split('?')[0];
        }
        
        // URL mit ALLEN Query-Parametern (building, area, address) erstellen
        const encodedBuilding = encodeURIComponent(building.building);
        const encodedArea = encodeURIComponent(area.area);
        const encodedAddress = encodeURIComponent(building.address);
        
        const targetUrl = `${baseUrl}?building=${encodedBuilding}&area=${encodedArea}&address=${encodedAddress}`;

        const container = document.getElementById('qrcode-container');
        container.innerHTML = ''; 

        // Generierung
        if (qrcode) {
            qrcode.clear();
            qrcode = null;
        }
        qrcode = new QRCode(container, {
            text: targetUrl,
            width: 256, height: 256, colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.H
        });

        // UI Aktualisieren
        document.getElementById('qr-building-display').innerText = building.building;
        document.getElementById('qr-area-display').innerText = area.area;
        document.getElementById('qr-address-display').innerText = building.address;
        document.getElementById('printable-area').classList.remove('hidden');
        document.getElementById('print-btn').classList.remove('hidden');
        
        // URL und Maps Link im UI anzeigen
        document.getElementById('full-url-text').innerText = targetUrl;
        document.getElementById('maps-link').href = `https://www.google.com/maps/search/?api=1&query=${encodedAddress}`;
        document.getElementById('maps-link').innerText = `Öffnen in Google Maps: ${building.address}`;
        document.getElementById('qr-url-display').classList.remove('hidden');

        if (showToastFlag) {
            showToast("QR Code erfolgreich generiert.");
        }
    }
    
    // Initialisierung beim Laden der Seite
    window.onload = function() {
        loadProjects();
        renderSelectors();
    };
</script>
<!-- MODAL ENDE -->
</body>
</html>
