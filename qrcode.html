<!-- 
  QR Code Generator für Standorte und Bereiche (Version 16 - Finale Produktion)
  Projektidee von Christian Heinrich Hohlfeld.
  Ziel: Erzeugung und Verwaltung von hierarchischen Standort-QR-Codes (Gebäude > Bereich) zur Verwendung mit der Servicetracker App.
  Fokus: UX/UI-Fixes, Speicherresilienz und modal-freier Workflow.
-->
<!DOCTYPE html>
<html lang="de" data-theme="emerald">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Generator V16</title>
    <!-- Tailwind CSS und DaisyUI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.css" rel="stylesheet" type="text/css" />
    <!-- Google Font Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .card { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        /* Stil für den druckbaren Bereich */
        @media print {
            body > :not(#printable-area) { display: none !important; }
            #printable-area {
                display: block; width: 100%; margin: 0; padding: 20px; box-shadow: none;
                page-break-after: always; /* Für mehrere Codes auf separaten Seiten */
            }
        }
    </style>
    <!-- QR Code Bibliothek -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center justify-start p-2 sm:p-4">

<!-- Generator Container -->
<div class="w-full max-w-sm sm:max-w-xl bg-white shadow-2xl rounded-xl p-6 md:p-8 mt-5 sm:mt-10 border border-gray-200">

    <header class="text-center mb-6">
        <h1 class="text-2xl font-bold text-gray-800">Standort QR Code Generator</h1>
        <p class="text-sm text-gray-500">Hierarchische Verwaltung (Gebäude & Bereiche)</p>
    </header>

    <!-- Inline Toast Message für Status (ersetzt Modal) -->
    <div id="toast-message" class="alert alert-success shadow-lg p-3 text-sm mb-4 hidden border-green-400 bg-green-50">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6 text-success" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
        <span id="toast-text" class="text-gray-700"></span>
    </div>
    
    <!-- Projektverwaltung -->
    <div class="card bg-base-100 shadow-md p-4 mb-6 border border-gray-200">
        <h2 class="text-xl font-semibold mb-4 text-primary">Standortverwaltung</h2>
        
        <!-- Gebäude Selektor -->
        <label class="form-control w-full mb-4">
            <div class="label"><span class="label-text font-semibold text-sm">Aktives Gebäude</span></div>
            <select id="building-selector" class="select select-bordered select-md w-full" onchange="switchBuilding(this.value)">
                <!-- Optionen werden via JavaScript befüllt -->
            </select>
        </label>
        
        <!-- Bereich Selektor -->
        <label class="form-control w-full mb-4">
            <div class="label"><span class="label-text font-semibold text-sm">Aktiver Bereich im Gebäude</span></div>
            <select id="area-selector" class="select select-bordered select-md w-full" onchange="switchArea(this.value)">
                <!-- Optionen werden via JavaScript befüllt -->
            </select>
        </label>

        <!-- Aktionen: Bearbeiten, Neu, Export, Löschen -->
        <div class="flex flex-wrap gap-2 justify-between mt-2">
            <button onclick="openEditModal(false)" class="btn btn-sm btn-info btn-outline whitespace-nowrap">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                Details bearbeiten
            </button>
            <button onclick="openEditModal(true)" class="btn btn-sm btn-secondary whitespace-nowrap">
                + Bereich hinzufügen
            </button>
        </div>
        <div class="flex flex-wrap gap-2 justify-between mt-4 border-t border-gray-200 pt-3">
             <button onclick="exportProjects()" class="btn btn-sm btn-success btn-outline whitespace-nowrap">
                Export (JSON)
            </button>
            <button onclick="window.importInitiate()" class="btn btn-sm btn-warning btn-outline whitespace-nowrap" id="import-btn">
                Import (JSON)
            </button>
            <button onclick="clearAllProjects()" class="btn btn-sm btn-error btn-outline whitespace-nowrap">
                Alle löschen (Local)
            </button>
        </div>
        
    </div>

    <!-- QR Code Anzeige und Druckbereich -->
    <div class="mt-6 p-4 border-t border-gray-200">
        <h2 class="text-xl font-semibold mb-4 text-center">QR Code Generierung</h2>
        
        <button onclick="generateQRCode()" class="btn btn-primary w-full text-lg shadow-lg">QR Code Generieren & Anzeigen</button>

        <div id="printable-area" class="bg-white p-6 rounded-lg shadow-inner text-center hidden flex flex-col items-center mt-6 border border-gray-300">
            <div id="qrcode-container" class="mb-4">
                <!-- QR Code wird hier generiert -->
            </div>
            <p id="qr-building-display" class="text-xl font-bold mb-0 text-gray-800"></p>
            <p id="qr-area-display" class="text-lg text-primary mb-2"></p>
            <p id="qr-address-display" class="text-sm text-gray-600 mb-4"></p>
            <p class="text-xs text-gray-500">Scannen für Arbeitsnachweis</p>
        </div>

        <div id="qr-url-display" class="mt-4 p-3 bg-gray-100 rounded-lg hidden w-full border border-gray-200">
            <p class="text-xs font-semibold mb-1 text-gray-700">Codierte URL:</p>
            <p id="full-url-text" class="text-xs text-gray-600 font-mono break-all"></p>
            <p class="text-xs font-semibold mt-3 mb-1 text-gray-700">Maps Link:</p>
            <a id="maps-link" target="_blank" class="text-xs text-blue-500 hover:underline break-all"></a>
        </div>

        <button id="print-btn" onclick="window.print()" class="btn btn-success w-full mt-6 text-lg hidden shadow-lg">
            Drucken (mit Standortdaten)
        </button>
    </div>

</div>

<!-- MODAL FÜR BEARBEITUNG/NEUANLAGE -->
<dialog id="edit-modal" class="modal">
    <div class="modal-box bg-white p-6 shadow-2xl">
        <h3 id="modal-title" class="font-bold text-xl mb-4 text-secondary">Details bearbeiten</h3>
        
        <label class="form-control w-full mb-3">
            <div class="label"><span class="label-text font-semibold text-sm">Gebäudename / Objekt</span></div>
            <input type="text" id="modal-building-input" placeholder="Neues Gebäude" class="input input-bordered w-full input-md" data-default="Neues Gebäude" onfocus="clearPlaceholder(this)" />
            <p id="error-building" class="text-error text-xs mt-1 hidden">Gebäudename ist erforderlich.</p>
        </label>

        <label class="form-control w-full mb-3">
            <div class="label"><span class="label-text font-semibold text-sm">Bereich / Area (z.B. Küche EG)</span></div>
            <input type="text" id="modal-area-input" placeholder="Neuer Bereich" class="input input-bordered w-full input-md" data-default="Neuer Bereich" onfocus="clearPlaceholder(this)" />
            <p id="error-area" class="text-error text-xs mt-1 hidden">Bereich ist erforderlich.</p>
        </label>

        <label class="form-control w-full mb-6">
            <div class="label"><span class="label-text font-semibold text-sm">Adresse (Straße, PLZ, Stadt)</span></div>
            <input type="text" id="modal-address-input" placeholder="Adresse eingeben" class="input input-bordered w-full input-md" data-default="Adresse eingeben" onfocus="clearPlaceholder(this)" />
            <p id="error-address" class="text-error text-xs mt-1 hidden">Adresse ist erforderlich.</p>
            <p class="text-xs text-gray-500 mt-1">Für den Maps-Link im QR-Code.</p>
        </label>
        
        <div class="modal-action flex justify-between">
            <button onclick="document.getElementById('edit-modal').close()" class="btn btn-ghost">Abbrechen</button>
            <button onclick="saveAndCloseModal()" class="btn btn-primary" id="save-modal-btn">Speichern & Schließen</button>
        </div>
    </div>
</dialog>

<!-- MODAL FÜR IMPORTERSTELLUNG (WIRD NUR GEÖFFNET) -->
<dialog id="import-modal" class="modal">
    <div class="modal-box bg-white p-6 shadow-2xl">
        <h3 class="font-bold text-xl mb-4 text-warning">Projekt-Import</h3>
        <p class="mb-4 text-gray-700">Wählen Sie die JSON-Datei, die Sie zuvor exportiert haben, um die Projekte zu importieren (vorhandene Projekte werden überschrieben).</p>
        
        <label class="form-control w-full mb-4">
            <input type="file" accept=".json" class="file-input file-input-bordered file-input-md w-full" onchange="importProjects(event); document.getElementById('import-modal').close();" />
        </label>

        <div class="modal-action">
            <button onclick="document.getElementById('import-modal').close()" class="btn">Abbrechen</button>
        </div>
    </div>
</dialog>

<script>
    // Globale Zustandsvariablen
    const STORAGE_KEY = 'ch_hohlfeld_qr_projects';
    const BASE_URL_HARDCODED = 'https://kurzlernen.de/servicetracker.html'; 

    let projects = []; // { building: string, areas: [{ id: string, name: string, address: string }] }
    let currentBuildingId = null;
    let currentAreaId = null;
    let isNewAreaMode = false;
    let qrcode = null;

    // --- Utility Funktionen ---

    function generateUUID() {
        return 'id-' + Date.now().toString(36) + Math.random().toString(36).substring(2);
    }

    function findBuilding(id) {
        return projects.find(b => b.id === id);
    }
    
    function findArea(buildingId, areaId) {
        const building = findBuilding(buildingId);
        return building ? building.areas.find(a => a.id === areaId) : null;
    }

    function showToast(message, isError = false) {
        const toast = document.getElementById('toast-message');
        const toastText = document.getElementById('toast-text');
        
        toastText.innerText = message;
        toast.classList.remove('hidden', 'alert-success', 'alert-error');
        toast.classList.add(isError ? 'alert-error' : 'alert-success');
        
        // Timeout, um die Nachricht nach 5 Sekunden auszublenden
        setTimeout(() => {
            toast.classList.add('hidden');
        }, 5000);
    }
    
    // UX Fix: Löscht Platzhalter beim Fokus
    window.clearPlaceholder = function(input) {
        if (input.value === input.getAttribute('data-default')) {
            input.value = '';
        }
    }

    // --- Laden und Speichern (LocalStorage) ---

    function loadProjects() {
        const stored = localStorage.getItem(STORAGE_KEY);
        try {
            projects = stored ? JSON.parse(stored) : [];
        } catch (e) {
            console.error("Fehler beim Parsen der Projekte aus LocalStorage:", e);
            projects = [];
        }
        
        // Initiales Projekt erstellen, wenn keins gefunden
        if (projects.length === 0) {
            createNewBuildingAndArea(true); // Erstellt Standardprojekt
        }
        
        // Setze die aktuelle Auswahl
        if (!currentBuildingId && projects.length > 0) {
            currentBuildingId = projects[0].id;
        }
        
        const activeBuilding = findBuilding(currentBuildingId);
        
        // FIX: Sicherstellen, dass Building existiert, bevor auf areas zugegriffen wird
        if (activeBuilding && activeBuilding.areas && activeBuilding.areas.length > 0) {
             currentAreaId = activeBuilding.areas[0].id;
        } else if (activeBuilding) {
             // Edge case: Building existiert, hat aber keine Areas (sollte bei createNewBuildingAndArea nicht passieren)
             currentAreaId = null;
        }
        
        // Falls nach dem Laden und Suchen immer noch kein Projekt/Bereich gefunden wird (Fehlerhafte Daten): 
        if (!currentBuildingId || !currentAreaId) {
             // Lösche potenziell korrupte Daten und starte neu mit Standardprojekt
             localStorage.removeItem(STORAGE_KEY);
             projects = [];
             createNewBuildingAndArea(true);
             currentBuildingId = projects[0].id;
             currentAreaId = projects[0].areas[0].id;
             showToast("Korrupte Daten bereinigt. Start mit neuem Standardprojekt.", true);
        }
    }

    function saveProjects() {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(projects));
            renderSelectors();
        } catch (e) {
            showToast("Fehler beim Speichern der Projekte. Speicher voll?", true);
            console.error("Fehler beim Speichern der Projekte in LocalStorage:", e);
        }
    }
    
    // Erstellt ein neues Gebäude mit einem Standardbereich
    function createNewBuildingAndArea(isInitial = false) {
        const newBuildingId = generateUUID();
        const newAreaId = generateUUID();
        
        const newBuilding = {
            id: newBuildingId,
            building: 'Neues Gebäude',
            address: 'Adresse eingeben',
            areas: [{
                id: newAreaId,
                area: 'Neuer Bereich'
            }]
        };
        
        projects.push(newBuilding);
        currentBuildingId = newBuildingId;
        currentAreaId = newAreaId;
        
        if (!isInitial) {
            saveProjects();
            // Automatisch zum neuen Element wechseln, um die Inputs zu befüllen
            switchBuilding(newBuildingId); 
            showToast("Neues Gebäude wurde erstellt. Bitte bearbeiten Sie die Details.");
        }
    }

    // --- UI Rendering und Auswahl ---

    function renderSelectors() {
        const buildingSelector = document.getElementById('building-selector');
        const areaSelector = document.getElementById('area-selector');

        // 1. Gebäude-Selektor füllen
        buildingSelector.innerHTML = '';
        projects.forEach(building => {
            const option = document.createElement('option');
            option.value = building.id;
            option.textContent = building.building;
            if (building.id === currentBuildingId) {
                option.selected = true;
            }
            buildingSelector.appendChild(option);
        });
        
        // 2. Bereich-Selektor füllen (basierend auf aktivem Gebäude)
        areaSelector.innerHTML = '';
        const activeBuilding = findBuilding(currentBuildingId);

        if (activeBuilding && activeBuilding.areas) {
            activeBuilding.areas.forEach(area => {
                const option = document.createElement('option');
                option.value = area.id;
                option.textContent = area.area;
                if (area.id === currentAreaId) {
                    option.selected = true;
                }
                areaSelector.appendChild(option);
            });
        }
        
        // Nach dem Rendering den QR Code aktualisieren
        generateQRCode();
    }

    window.switchBuilding = function(buildingId) {
        currentBuildingId = buildingId;
        const building = findBuilding(buildingId);
        
        if (building && building.areas && building.areas.length > 0) {
            currentAreaId = building.areas[0].id; // Wähle den ersten Bereich des neuen Gebäudes
        } else {
            currentAreaId = null;
        }
        
        saveProjects(); // Speichern, da die IDs aktualisiert wurden
        renderSelectors();
    }

    window.switchArea = function(areaId) {
        currentAreaId = areaId;
        saveProjects();
        renderSelectors();
    }

    // --- Modal und Bearbeitungs-Logik ---

    window.openEditModal = function(isNewArea) {
        const building = findBuilding(currentBuildingId);
        const area = findArea(currentBuildingId, currentAreaId);
        const modalTitle = document.getElementById('modal-title');
        isNewAreaMode = isNewArea;

        // Reset Fehler
        document.querySelectorAll('[id^="error-"]').forEach(el => el.classList.add('hidden'));
        
        // Sicherstellen, dass gültige Daten existieren
        if (!building) {
            showToast("FEHLER: Bitte erstellen Sie zuerst ein neues Gebäude.", true);
            return;
        }

        if (isNewArea) {
            // NEUER BEREICH: Kopiere Gebäude/Adresse, lasse Bereich leer
            modalTitle.textContent = `Neuen Bereich in "${building.building}" anlegen`;
            document.getElementById('modal-building-input').value = building.building;
            document.getElementById('modal-address-input').value = building.address;
            document.getElementById('modal-area-input').value = document.getElementById('modal-area-input').getAttribute('data-default');
        } else {
            // DETAILS BEARBEITEN
            modalTitle.textContent = 'Standort-Details bearbeiten';
            document.getElementById('modal-building-input').value = building.building;
            document.getElementById('modal-address-input').value = building.address;
            document.getElementById('modal-area-input').value = area ? area.area : '';
        }
        
        // Sicherstellen, dass die Felder nicht 'Neuer Bereich' oder 'Adresse eingeben' anzeigen, wenn das Modal geöffnet wird.
        document.getElementById('modal-building-input').onfocus();
        document.getElementById('modal-area-input').onfocus();
        document.getElementById('modal-address-input').onfocus();

        document.getElementById('edit-modal').showModal();
    }
    
    window.saveAndCloseModal = function() {
        const buildingInput = document.getElementById('modal-building-input').value.trim();
        const areaInput = document.getElementById('modal-area-input').value.trim();
        const addressInput = document.getElementById('modal-address-input').value.trim();
        
        let isValid = true;

        // Validierung
        if (!buildingInput || buildingInput === 'Neues Gebäude') {
            document.getElementById('error-building').classList.remove('hidden'); isValid = false;
        } else { document.getElementById('error-building').classList.add('hidden'); }
        
        if (!areaInput || areaInput === 'Neuer Bereich') {
            document.getElementById('error-area').classList.remove('hidden'); isValid = false;
        } else { document.getElementById('error-area').classList.add('hidden'); }
        
        if (!addressInput || addressInput === 'Adresse eingeben') {
            document.getElementById('error-address').classList.remove('hidden'); isValid = false;
        } else { document.getElementById('error-address').classList.add('hidden'); }

        if (!isValid) return;

        const building = findBuilding(currentBuildingId);

        if (isNewAreaMode) {
            // NEUEN BEREICH SPEICHERN
            const newAreaId = generateUUID();
            building.areas.push({
                id: newAreaId,
                area: areaInput
            });
            // Gebäude-Details aktualisieren, falls sie kopiert und bearbeitet wurden
            building.building = buildingInput;
            building.address = addressInput;
            currentAreaId = newAreaId; // Zum neuen Bereich wechseln
            showToast(`Neuer Bereich "${areaInput}" in ${buildingInput} gespeichert.`);

        } else {
            // AKTUELLEN BEREICH/GEBÄUDE BEARBEITEN
            const area = findArea(currentBuildingId, currentAreaId);
            
            building.building = buildingInput;
            building.address = addressInput;
            
            if (area) {
                area.area = areaInput;
            } else {
                // Falls Bereich noch nicht existiert (Should not happen if initialized correctly)
                building.areas.push({ id: generateUUID(), area: areaInput });
                currentAreaId = building.areas[building.areas.length - 1].id;
            }
            
            showToast(`Details für "${buildingInput} / ${areaInput}" gespeichert.`);
        }

        saveProjects();
        document.getElementById('edit-modal').close();
    }

    // --- Export, Import und Löschen ---
    
    window.clearAllProjects = function() {
        if (confirm("WARNUNG: Möchten Sie WIRKLICH alle gespeicherten Projekte (Gebäude und Bereiche) im lokalen Speicher löschen? Diese Aktion kann NICHT rückgängig gemacht werden.")) {
            localStorage.removeItem(STORAGE_KEY);
            projects = [];
            currentBuildingId = null;
            currentAreaId = null;
            loadProjects(); // App in sauberen Zustand zurücksetzen
            renderSelectors();
            showToast("Alle Projekte erfolgreich gelöscht.", true);
        }
    }
    
    window.importInitiate = function() {
        document.getElementById('import-modal').showModal();
    }

    window.exportProjects = function() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(projects, null, 2));
        const downloadAnchorNode = document.createElement('a');
        const filename = `QR_Projekte_${new Date().toISOString().slice(0, 10)}.json`; 
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", filename);
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
        
        showToast(`Alle ${projects.length} Gebäude und ihre Bereiche wurden erfolgreich exportiert.`);
    }
    
    window.importProjects = function(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedData = JSON.parse(e.target.result);

                if (!Array.isArray(importedData) || importedData.length === 0 || importedData.some(b => !b.id || !b.building || !b.areas || !Array.isArray(b.areas) || b.areas.length === 0)) {
                    throw new Error("Die importierte Datei ist kein gültiges QR-Projekt-Array im erwarteten hierarchischen Format.");
                }

                projects = importedData;
                currentBuildingId = projects[0].id;
                currentAreaId = projects[0].areas[0].id;
                
                saveProjects(); 
                switchBuilding(currentBuildingId); // Lädt und rendert neu

                showToast(`Erfolgreich ${projects.length} Gebäude und alle zugehörigen Bereiche importiert.`);

            } catch (error) {
                console.error("Importfehler:", error);
                showToast(`Fehler beim Importieren der Datei: ${error.message}`, true);
            } finally {
                event.target.value = null; 
            }
        };
        reader.readAsText(file);
    }

    // --- QR Code Generierung ---

    window.generateQRCode = function() {
        const building = findBuilding(currentBuildingId);
        const area = findArea(currentBuildingId, currentAreaId);

        // Validierung
        if (!building || !area || !building.building || !area.area || !building.address) {
            showToast('FEHLER: Bitte füllen Sie alle Standortdetails aus, bevor Sie den QR-Code generieren.', true);
            document.getElementById('printable-area').classList.add('hidden');
            document.getElementById('print-btn').classList.add('hidden');
            document.getElementById('qr-url-display').classList.add('hidden');
            return;
        }
        
        let baseUrl = BASE_URL_HARDCODED;
        if (baseUrl.includes('?')) {
             baseUrl = baseUrl.split('?')[0];
        }
        
        // URL mit ALLEN Query-Parametern (building, area, address) erstellen
        const encodedBuilding = encodeURIComponent(building.building);
        const encodedArea = encodeURIComponent(area.area);
        const encodedAddress = encodeURIComponent(building.address);
        
        const targetUrl = `${baseUrl}?building=${encodedBuilding}&area=${encodedArea}&address=${encodedAddress}`;

        const container = document.getElementById('qrcode-container');
        container.innerHTML = ''; 

        // Generierung
        if (qrcode) {
            qrcode.clear();
            qrcode = null;
        }
        qrcode = new QRCode(container, {
            text: targetUrl,
            width: 256, height: 256, colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.H
        });

        // UI Aktualisieren
        document.getElementById('qr-building-display').innerText = building.building;
        document.getElementById('qr-area-display').innerText = area.area;
        document.getElementById('qr-address-display').innerText = building.address;
        document.getElementById('printable-area').classList.remove('hidden');
        document.getElementById('print-btn').classList.remove('hidden');
        
        // URL und Maps Link im UI anzeigen
        document.getElementById('full-url-text').innerText = targetUrl;
        document.getElementById('maps-link').href = `https://www.google.com/maps/search/?api=1&query=${encodedAddress}`;
        document.getElementById('maps-link').innerText = `Öffnen in Google Maps: ${building.address}`;
        document.getElementById('qr-url-display').classList.remove('hidden');

        showToast("QR Code erfolgreich generiert.");
    }
    
    // Initialisierung beim Laden der Seite
    window.onload = function() {
        loadProjects();
        renderSelectors();
    };
</script>
<!-- MODAL ENDE -->
</body>
</html>
