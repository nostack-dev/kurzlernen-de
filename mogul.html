<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mogul P2P Sync - Einfach Verbinden</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; }
        .connection-dot { 
            width: 12px; height: 12px; border-radius: 50%; 
            display: inline-block; margin-right: 8px; 
        }
        /* Fix fÃ¼r Chat-Box Scroll */
        #chat-box { max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
    <div class="max-w-md mx-auto bg-white rounded-2xl shadow-xl p-6 mt-8">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Mogul P2P Sync</h1>
            <p class="text-gray-600">Einfach verbinden - Automatisch synchronisieren</p>
        </div>

        <div id="connection-status" class="mb-6 p-4 bg-gray-100 rounded-xl text-center">
            <div class="flex items-center justify-center mb-2">
                <div id="status-dot" class="connection-dot bg-gray-400"></div>
                <span id="status-text" class="font-medium">Bereit fÃ¼r Verbindung</span>
            </div>
            <p id="status-detail" class="text-sm text-gray-600 text-center">
                Klicken Sie auf "Verbindung starten"
            </p>
        </div>

        <div class="text-center mb-6">
            <button id="start-connection" class="btn btn-primary btn-lg w-full rounded-xl shadow-lg hover:shadow-xl transition-all duration-300">
                ðŸ”— Verbindung starten
            </button>
        </div>

        <div id="link-section" class="hidden space-y-4">
            <div id="offer-section" class="bg-blue-50 p-4 rounded-xl border border-blue-200">
                <h3 class="font-semibold text-blue-800 mb-2 flex items-center">
                    <span class="connection-dot bg-blue-500"></span>
                    Schritt 1: Link teilen
                </h3>
                <p class="text-sm text-blue-700 mb-3">
                    Teilen Sie diesen Link mit der anderen Person:
                </p>
                <div class="bg-white p-3 rounded-lg border border-blue-300">
                    <div id="offer-link" class="text-xs break-all font-mono text-blue-800 mb-2"></div>
                    <button id="copy-offer" class="btn btn-sm btn-outline btn-primary w-full">
                        ðŸ“‹ Link kopieren
                    </button>
                </div>
            </div>

            <div id="answer-section" class="bg-green-50 p-4 rounded-xl border border-green-200 hidden">
                <h3 class="font-semibold text-green-800 mb-2 flex items-center">
                    <span class="connection-dot bg-green-500"></span>
                    Schritt 2: Auf Antwort warten
                </h3>
                <p class="text-sm text-green-700 mb-3">
                    Warten Sie, bis die andere Person antwortet...
                </p>
                <div class="text-center py-2">
                    <div class="loading loading-spinner text-green-500"></div>
                </div>
            </div>

            <div id="connected-section" class="bg-green-100 p-4 rounded-xl border border-green-300 hidden">
                <h3 class="font-semibold text-green-800 mb-2 flex items-center">
                    <span class="connection-dot bg-green-500 animate-pulse"></span>
                    âœ… Verbunden!
                </h3>
                <p class="text-sm text-green-700">
                    Die P2P-Verbindung ist aktiv. Daten werden automatisch synchronisiert.
                </p>
            </div>
        </div>

        <div id="data-section" class="mt-6 hidden">
            <h3 class="font-semibold text-gray-800 mb-3">Synchronisierte Daten (Automatisch)</h3>
            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                <div id="sync-data" class="text-sm text-gray-700">
                    <div class="text-center py-4">
                        <div class="loading loading-spinner text-primary"></div>
                        <p class="mt-2 text-gray-600">Warte auf Daten...</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="chat-section" class="mt-6 hidden">
            <h3 class="font-semibold text-gray-800 mb-3">Mini-Chat (Manuelle DatenÃ¼bertragung)</h3>
            
            <div id="chat-box" class="bg-gray-50 p-3 rounded-xl border border-gray-200 mb-3 space-y-2">
                </div>

            <div class="flex space-x-2">
                <input id="chat-input" type="text" placeholder="Nachricht eingeben..." class="input input-bordered w-full" onkeydown="if(event.keyCode===13) document.getElementById('send-message').click()">
                <button id="send-message" class="btn btn-primary">Senden</button>
            </div>
        </div>
    </div>

    <script>
        // =================================================================
        // GLOBALE VARIABLEN & KONFIGURATION
        // =================================================================
        let peerConnection = null;
        let dataChannel = null;
        let currentRole = null; 
        let connectionAttempts = 0;
        const MAX_ATTEMPTS = 3;
        const STORAGE_KEY = 'mogul-p2p-offer-sdp'; 

        const config = {
            iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
        };

        // **HILFSFUNKTIONEN FÃœR ROBUSTE KODIERUNG/DEKODIERUNG VON UTF-8 SDP**
        function b64EncodeUnicode(str) {
            return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,
                function(match, p1) {
                    return String.fromCharCode('0x' + p1);
                }));
        }

        function b64DecodeUnicode(str) {
            return decodeURIComponent(atob(str).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
        }

        function decodeBase64Json(base64String) {
            if (!base64String) {
                throw new Error("Leerer String fÃ¼r Decodierung.");
            }
            try {
                const decodedUri = decodeURIComponent(base64String.replace(/\s/g, ''));
                const jsonString = atob(decodedUri); 
                return JSON.parse(jsonString);
            } catch (e) {
                console.error("Decodierungsfehler:", e);
                throw new Error(`Decodierungsfehler: Der Ã¼bergebene Code ist ungÃ¼ltig oder beschÃ¤digt. (${e.message})`);
            }
        }

        // =================================================================
        // UI MANAGEMENT 
        // =================================================================
        function updateStatus(status, detail = "") {
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('status-text');
            const detailEl = document.getElementById('status-detail');
            
            const statusConfig = {
                'ready': { color: 'bg-gray-400', text: 'Bereit fÃ¼r Verbindung', detail: 'Klicken Sie auf "Verbindung starten"' },
                'generating': { color: 'bg-blue-500', text: 'Generiere Link...', detail: 'Erstelle sichere Verbindung' },
                'waiting': { color: 'bg-yellow-500', text: 'Warte auf Antwort...', detail: 'Teilen Sie den Link mit der anderen Person' },
                'connecting': { color: 'bg-orange-500', text: 'Verbinde...', detail: 'Stelle P2P-Verbindung her' },
                'connected': { color: 'bg-green-500', text: 'Verbunden!', detail: 'P2P-Verbindung aktiv' },
                'error': { color: 'bg-red-500', text: 'Fehler', detail: 'Verbindung fehlgeschlagen' }
            };
            
            const config = statusConfig[status] || statusConfig.ready;
            dot.className = `connection-dot ${config.color}`; 
            text.textContent = config.text;
            detailEl.textContent = detail || config.detail;
        }

        function showSection(sectionId) {
            document.getElementById('link-section').classList.add('hidden');
            document.getElementById('offer-section').classList.add('hidden');
            document.getElementById('answer-section').classList.add('hidden');
            document.getElementById('connected-section').classList.add('hidden');
            document.getElementById('data-section').classList.add('hidden');
            document.getElementById('chat-section').classList.add('hidden');
            
            if (sectionId === 'link-section') {
                document.getElementById('link-section').classList.remove('hidden');
                document.getElementById('offer-section').classList.remove('hidden');
            } else if (sectionId === 'connected-section') {
                document.getElementById('connected-section').classList.remove('hidden');
                document.getElementById('data-section').classList.remove('hidden');
                document.getElementById('chat-section').classList.remove('hidden');
            } else if (sectionId) {
                document.getElementById(sectionId).classList.remove('hidden');
            }
        }

        function displaySyncData(data) {
            const container = document.getElementById('sync-data');
            const timestamp = new Date().toLocaleTimeString();
            
            container.innerHTML = `
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="font-medium">GerÃ¤t:</span>
                        <span class="text-blue-600">${data.deviceName || 'Unbekannt'}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="font-medium">Zeit:</span>
                        <span class="text-gray-600">${timestamp}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="font-medium">Status:</span>
                        <span class="text-green-600">âœ… Synchronisiert</span>
                    </div>
                    <div class="mt-3 p-2 bg-white rounded border">
                        <span class="font-medium">Daten:</span>
                        <pre class="text-xs mt-1 overflow-x-auto">${JSON.stringify(data.payload, null, 2)}</pre>
                    </div>
                </div>
            `;
        }
        
        function displayChatMessage(sender, message, isLocal = false) {
            const chatBox = document.getElementById('chat-box');
            const senderClass = isLocal ? 'text-right' : 'text-left';
            const bubbleClass = isLocal ? 'bg-blue-500 text-white ml-auto' : 'bg-gray-200 text-gray-800 mr-auto';
            const senderName = isLocal ? 'Ich' : sender;
            
            const messageElement = document.createElement('div');
            messageElement.className = senderClass;
            messageElement.innerHTML = `
                <div class="text-xs font-semibold ${isLocal ? 'text-blue-600' : 'text-gray-600'}">${senderName}</div>
                <div class="inline-block p-2 rounded-lg ${bubbleClass} max-w-[80%] break-words">
                    ${message}
                </div>
            `;
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // =================================================================
        // AUTOMATISIERTE VERBINDUNGSLOGIK
        // =================================================================
        
        function getOfferCodeFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            let offerCode = urlParams.get('offer');

            if (!offerCode) {
                const urlHash = window.location.hash.substring(1);
                const hashParams = new URLSearchParams(urlHash);
                offerCode = hashParams.get('offer');
            }
            return offerCode;
        }
        
        function getAnswerCodeFromUrl() {
            const urlHash = window.location.hash.substring(1);
            const hashParams = new URLSearchParams(urlHash);
            return hashParams.get('answer');
        }

        async function startConnection(restoredSdp = null) {
            try {
                document.getElementById('start-connection').disabled = true;
                updateStatus('generating');
                
                const offerCode = getOfferCodeFromUrl();
                
                if (offerCode) {
                    currentRole = 'responder';
                    history.replaceState(null, '', window.location.pathname); 
                    await handleIncomingOffer(offerCode);

                } else if (restoredSdp) {
                    // **KORRIGIERTER PFAD FÃœR NEUEN TAB:** Setze aktuelle Rolle und starte Wiederherstellung
                    currentRole = 'initiator';
                    await continueInitiatorFlow(restoredSdp);
                    
                } else {
                    currentRole = 'initiator';
                    await createAndShareOffer();
                }
            } catch (error) {
                console.error('Verbindungsfehler im startConnection:', error);
                updateStatus('error', `Fehler: ${error.message}`);
                
                if (connectionAttempts < MAX_ATTEMPTS) {
                    connectionAttempts++;
                    setTimeout(() => {
                        updateStatus('ready', `Automatischer Wiederholungsversuch (${connectionAttempts}/${MAX_ATTEMPTS})`);
                        document.getElementById('start-connection').disabled = false;
                    }, 3000);
                } else {
                     document.getElementById('start-connection').disabled = false;
                }
            }
        }

        async function createAndShareOffer() {
            if (peerConnection) {
                peerConnection.close();
            }

            peerConnection = new RTCPeerConnection(config);
            dataChannel = peerConnection.createDataChannel("mogul-sync", { negotiated: false });
            setupDataChannel(dataChannel);

            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            
            // SPEICHERN: Den lokalen Offer SDP in localStorage speichern (fÃ¼r Tab-UnabhÃ¤ngigkeit)
            localStorage.setItem(STORAGE_KEY, peerConnection.localDescription.sdp);

            await new Promise(resolve => {
                if (peerConnection.iceGatheringState === 'complete') {
                    resolve();
                } else {
                    peerConnection.onicegatheringstatechange = () => {
                        if (peerConnection.iceGatheringState === 'complete') {
                            resolve();
                        }
                    };
                    setTimeout(resolve, 2000); 
                }
            });

            const offerData = {
                type: 'offer',
                sdp: b64EncodeUnicode(peerConnection.localDescription.sdp), 
                timestamp: Date.now()
            };
            
            const offerString = btoa(JSON.stringify(offerData)); 
            const shareableUrl = `${window.location.origin}${window.location.pathname}?offer=${encodeURIComponent(offerString)}`;
            
            document.getElementById('offer-link').textContent = shareableUrl;
            showSection('link-section');
            updateStatus('waiting', 'Teilen Sie diesen Link mit der anderen Person');
            
            try {
                await navigator.clipboard.writeText(shareableUrl);
                document.getElementById('copy-offer').textContent = 'âœ… Link kopiert!';
                setTimeout(() => {
                    document.getElementById('copy-offer').textContent = 'ðŸ“‹ Link kopieren';
                }, 2000);
            } catch (e) {
                // Fallback
            }

            await waitForAnswer();
        }

        /**
         * **KORRIGIERTE WIEDERHERSTELLUNG:** Stellt die PeerConnection wieder her und setzt NUR den Answer-SDP.
         * @param {string} restoredSdp Der ursprÃ¼ngliche lokale SDP-String des Offers.
         */
        async function continueInitiatorFlow(restoredSdp) {
            updateStatus('connecting', 'Sitzung wiederhergestellt. Warte auf Antwort.');
            
            // 1. PeerConnection neu erstellen und DataChannel vorbereiten
            peerConnection = new RTCPeerConnection(config);
            dataChannel = peerConnection.createDataChannel("mogul-sync", { negotiated: false });
            setupDataChannel(dataChannel);
            
            // **ENTFERNT:** peerConnection.setLocalDescription(offer);
            // Wir mÃ¼ssen den alten Offer-SDP speichern, damit der Answer-SDP ihn als "expected remote SDP" verarbeiten kann.
            
            // Setze den *lokal* gespeicherten Offer-SDP als **Remote Description** des Initiators.
            // Dies ist ein Trick, da der Answer-SDP (den wir gleich erhalten) als *Remote Description* des Responders gesetzt werden muss.
            // ABER: setLocalDescription auf einer neuen PC fÃ¼hrt zum Fehler.
            // WICHTIG: WebRTC erwartet, dass die SENDER-Seite (Initiator) ihren ursprÃ¼nglichen Offer-SDP lokal kennt, um den Answer-SDP zu verarbeiten.
            
            // Erstellen Sie den Offer-SDP des Initiators neu und speichern Sie ihn lokal, OHNE setLocalDescription()
            peerConnection.localDescription = new RTCSessionDescription({ type: 'offer', sdp: restoredSdp });

            // 3. Warte auf den Answer-Code, der jetzt in der URL ist
            await waitForAnswer(true); 
        }

        async function handleIncomingOffer(offerCode) {
            updateStatus('connecting', 'Verarbeite eingehende Verbindung...');
            
            try {
                const offerData = decodeBase64Json(offerCode); 
                if (offerData.type !== 'offer') throw new Error('UngÃ¼ltiger Offer-Code Typ');
                
                const remoteOffer = {
                    type: 'offer',
                    sdp: b64DecodeUnicode(offerData.sdp)
                };

                peerConnection = new RTCPeerConnection(config);
                
                peerConnection.ondatachannel = (event) => {
                    dataChannel = event.channel;
                    setupDataChannel(dataChannel); 
                    establishConnection();
                };

                await peerConnection.setRemoteDescription(remoteOffer);
                
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);

                await new Promise(resolve => {
                    if (peerConnection.iceGatheringState === 'complete') {
                        resolve();
                    } else {
                        peerConnection.onicegatheringstatechange = () => {
                            if (peerConnection.iceGatheringState === 'complete') {
                                resolve();
                            }
                        };
                        setTimeout(resolve, 2000);
                    }
                });

                const answerData = {
                    type: 'answer',
                    sdp: b64EncodeUnicode(peerConnection.localDescription.sdp), 
                    timestamp: Date.now()
                };
                const answerString = btoa(JSON.stringify(answerData));
                
                const finalAnswerUrl = `${window.location.origin}${window.location.pathname}#answer=${encodeURIComponent(answerString)}`;
                
                updateStatus('waiting', 'Antwort-Link erzeugt. Bitte diesen Link dem Initiator geben.');
                document.getElementById('offer-link').textContent = finalAnswerUrl;
                document.getElementById('offer-section').querySelector('h3').innerHTML = '<span class="connection-dot bg-green-500"></span>Schritt 2: Antwort-Link teilen';
                document.getElementById('offer-section').querySelector('p').textContent = 'Teilen Sie diesen Link mit der anderen Person (Initiator), damit dieser die Verbindung abschlieÃŸen kann:';
                showSection('link-section');
                document.getElementById('copy-offer').textContent = 'ðŸ“‹ Antwort-Link kopieren';

            } catch (error) {
                console.error('Fehler bei eingehender Verbindung:', error);
                throw new Error(`Verbindungsfehler: ${error.message}`);
            }
        }

        async function waitForAnswer(answerPresentOnLoad = false) {
            
            if (answerPresentOnLoad) {
                 const answerCode = getAnswerCodeFromUrl();
                 if (answerCode) {
                    await processAnswer(answerCode);
                    return;
                 }
            }

            updateStatus('waiting', 'Warte auf die Gegenstelle, um den Answer-Code zurÃ¼ckzusenden...');
            document.getElementById('answer-section').classList.remove('hidden');

            return new Promise((resolve, reject) => {
                const checkInterval = setInterval(async () => {
                    try {
                        const answerCode = getAnswerCodeFromUrl();
                        
                        if (answerCode) {
                            clearInterval(checkInterval);
                            await processAnswer(answerCode);
                            resolve();
                        }
                    } catch (error) {
                        clearInterval(checkInterval);
                        reject(error);
                    }
                }, 1000);

                setTimeout(() => {
                    clearInterval(checkInterval);
                    reject(new Error('Timeout: Keine Antwort erhalten'));
                }, 120000);
            });
        }
        
        async function processAnswer(answerCode) {
            updateStatus('connecting', 'Empfange Antwort. Stelle Verbindung her...');
            
            history.replaceState(null, '', window.location.pathname);
            localStorage.removeItem(STORAGE_KEY); 
            
            const answerData = decodeBase64Json(answerCode);
            if (answerData.type !== 'answer') {
                throw new Error('UngÃ¼ltiger Answer-Code Typ');
            }

            const remoteAnswer = {
                type: 'answer',
                sdp: b64DecodeUnicode(answerData.sdp)
            };

            await peerConnection.setRemoteDescription(remoteAnswer);
            await establishConnection();
        }


        async function establishConnection() {
            updateStatus('connecting', 'Stelle finale Verbindung her...');

            if (!dataChannel) {
                if (currentRole === 'responder') {
                    updateStatus('connecting', 'Warte auf DataChannel-Empfang/Ã–ffnung...');
                    return; 
                }
                throw new Error("DataChannel konnte nicht initialisiert werden.");
            }

            await new Promise((resolve, reject) => {
                const timeout = setTimeout(() => {
                    reject(new Error('Verbindungstimeout: DataChannel Ã¶ffnet nicht'));
                }, 30000);

                if (dataChannel.readyState === 'open') {
                    clearTimeout(timeout);
                    resolve();
                } else {
                    dataChannel.onopen = () => {
                        clearTimeout(timeout);
                        resolve();
                    };
                    dataChannel.onerror = (error) => {
                        clearTimeout(timeout);
                        reject(error);
                    };
                }
            });

            updateStatus('connected', 'P2P-Verbindung aktiv!');
            showSection('connected-section');
            document.getElementById('start-connection').disabled = false;
            
            document.getElementById('chat-box').innerHTML = '<div class="text-center text-xs text-gray-500">Verbindung hergestellt. Starte Chat!</div>';
            document.getElementById('send-message').addEventListener('click', () => {
                const input = document.getElementById('chat-input');
                if (input.value.trim() !== '') {
                    sendMessage(input.value);
                    input.value = '';
                }
            });

            sendTestData();
        }

        function setupDataChannel(channel) {
            channel.onopen = () => {
                console.log('DataChannel geÃ¶ffnet');
            };

            channel.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'sync-data') {
                        displaySyncData(data);
                        if (data.type === 'sync-request') {
                            sendSyncResponse();
                        }
                    } else if (data.type === 'chat') {
                        const sender = data.deviceName;
                        displayChatMessage(sender, data.message, false);
                    }
                } catch (e) {
                    console.log('Empfangene Nachricht (Nicht-JSON):', event.data);
                }
            };

            channel.onclose = () => {
                updateStatus('error', 'Verbindung geschlossen');
                document.getElementById('start-connection').disabled = false;
                localStorage.removeItem(STORAGE_KEY); 
            };

            channel.onerror = (error) => {
                console.error('DataChannel Fehler:', error);
                updateStatus('error', 'Verbindungsfehler im DataChannel');
                document.getElementById('start-connection').disabled = false;
            };
        }

        function sendMessage(message) {
            if (dataChannel && dataChannel.readyState === 'open') {
                const chatData = {
                    type: 'chat',
                    deviceName: currentRole === 'initiator' ? 'GerÃ¤t A' : 'GerÃ¤t B',
                    message: message,
                    timestamp: new Date().toISOString()
                };
                
                dataChannel.send(JSON.stringify(chatData));
                displayChatMessage('Ich', message, true);
            } else {
                alert('Verbindung ist nicht aktiv. Bitte warten Sie auf "Verbunden!"');
            }
        }


        function sendTestData() {
             if (dataChannel && dataChannel.readyState === 'open') {
                const testData = {
                    type: 'sync-data',
                    deviceName: currentRole === 'initiator' ? 'GerÃ¤t A (Initiator)' : 'GerÃ¤t B (Responder)',
                    timestamp: new Date().toISOString(),
                    payload: {
                        message: 'Automatische Synchronisation aktiv',
                        status: 'connected',
                        data: ['Sync Item 1', 'Sync Item 2', 'Sync Item 3']
                    }
                };
                
                dataChannel.send(JSON.stringify(testData));
                displaySyncData(testData);
                
                setTimeout(sendTestData, 10000);
            }
        }

        function sendSyncResponse() {
             if (dataChannel && dataChannel.readyState === 'open') {
                const response = {
                    type: 'sync-response',
                    deviceName: currentRole === 'initiator' ? 'GerÃ¤t A (Initiator)' : 'GerÃ¤t B (Responder)',
                    timestamp: new Date().toISOString(),
                    payload: {
                        status: 'acknowledged',
                        received: true
                    }
                };
                dataChannel.send(JSON.stringify(response));
            }
        }

        // =================================================================
        // EVENT LISTENER & INITIALISIERUNG
        // =================================================================
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('start-connection').addEventListener('click', () => {
                 localStorage.removeItem(STORAGE_KEY); 
                 startConnection();
            });
            
            document.getElementById('copy-offer').addEventListener('click', function() {
                const link = document.getElementById('offer-link').textContent;
                navigator.clipboard.writeText(link).then(() => {
                    this.textContent = 'âœ… Kopiert!';
                    setTimeout(() => {
                        this.textContent = 'ðŸ“‹ Link kopieren';
                    }, 2000);
                });
            });

            // Automatischer Start bei URL-Parametern
            const offerCode = getOfferCodeFromUrl();
            
            if (offerCode) {
                setTimeout(startConnection, 500);
            } else {
                const answerCode = getAnswerCodeFromUrl();
                const storedSdp = localStorage.getItem(STORAGE_KEY); 

                if (answerCode && storedSdp) {
                    setTimeout(() => startConnection(storedSdp), 500);
                } else if (answerCode && !storedSdp) {
                    setTimeout(() => {
                        document.getElementById('start-connection').disabled = true;
                        updateStatus('error', 'Fehler: Sitzung abgelaufen.');
                        document.getElementById('status-detail').textContent = 'Der Answer-Code ist abgelaufen. Bitte klicken Sie auf "Verbindung starten", um einen neuen Link zu generieren.';
                    }, 500);
                }
            }

            console.log('Mogul P2P Sync - Chat- und Tab-Wiederherstellung aktiv');
        });
    </script>
</body>
</html>
