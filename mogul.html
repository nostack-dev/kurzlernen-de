<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mogul P2P Sync - Final Design</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* BASE DESIGN UND TYPOGRAFIE */
        body { font-family: system-ui, -apple-system, sans-serif; }
        .connection-dot { 
            width: 12px; height: 12px; border-radius: 50%; 
            display: inline-block; margin-right: 8px; 
        }
        
        /* CHAT BEREICH */
        #chat-box { max-height: 400px; overflow-y: auto; background-color: #f5f5f5; border: 1px solid #ddd; }
        
        /* MEDIEN DARSTELLUNG */
        .embedded-media { max-width: 250px; max-height: 250px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); } 
        .video-container, .image-container { max-width: 250px; }
        .audio-container { display: flex; align-items: center; background-color: #f5f5f5; padding: 6px; border-radius: 12px; }
        .speed-button { font-size: 0.75rem; padding: 2px 6px; margin-left: 8px; }

        /* ZUSTANDSKLASSEN */
        .hidden-button { display: none !important; } 

        /* UX Anpassungen */
        .btn-primary { 
            background-color: #4f46e5; 
            border-color: #4f46e5;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(79, 70, 229, 0.3);
        }
        .btn-primary:hover {
            background-color: #4338ca; 
            border-color: #4338ca;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-50 to-indigo-100 p-4">
    <div class="max-w-md mx-auto bg-white rounded-2xl shadow-2xl p-6 mt-8 border border-gray-200">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-gray-800 mb-2">Mogul P2P Sync</h1>
            <p class="text-gray-500">Einfach verbinden - Automatisch synchronisieren</p>
        </div>

        <div id="connection-status" class="mb-6 p-4 bg-gray-100 rounded-xl text-center shadow-inner">
            <div class="flex items-center justify-center mb-2">
                <div id="status-dot" class="connection-dot bg-gray-400"></div>
                <span id="status-text" class="font-bold">Bereit f√ºr Verbindung</span>
            </div>
            <p id="status-detail" class="text-sm text-gray-600 text-center">
                Klicken Sie auf "Verbindung starten"
            </p>
        </div>

        <div id="start-button-container" class="text-center mb-6">
            <button id="start-connection" class="btn btn-primary btn-lg w-full rounded-xl shadow-lg hover:shadow-xl transition-all duration-300">
                üîó Verbindung starten
            </button>
        </div>

        <div id="link-section" class="hidden space-y-4">
            <div id="offer-section" class="bg-blue-50 p-4 rounded-xl border border-blue-200 shadow-md">
                <h3 class="font-semibold text-blue-800 mb-2 flex items-center">
                    <span class="connection-dot bg-blue-500"></span>
                    Schritt 1: Link teilen
                </h3>
                <p class="text-sm text-blue-700 mb-3">
                    Teilen Sie diesen Link mit der anderen Person:
                </p>
                <div class="bg-white p-3 rounded-lg border border-blue-300">
                    <div id="offer-link" class="text-xs break-all font-mono text-blue-800 mb-2"></div>
                    
                    <div id="share-buttons" class="flex space-x-2 mt-2">
                        <button id="copy-offer" class="btn btn-outline btn-primary w-full">
                            üìã Link kopieren
                        </button>
                    </div>

                </div>
            </div>

            <div id="answer-section" class="hidden bg-green-50 p-4 rounded-xl border border-green-200 shadow-md">
                <h3 class="font-semibold text-green-800 mb-2 flex items-center">
                    <span class="connection-dot bg-green-500"></span>
                    Schritt 2: Auf Antwort warten
                </h3>
                <p id="wait-message" class="text-sm text-green-700 mb-3">
                    Warten Sie, bis die andere Person antwortet...
                </p>
                <div class="text-center py-2">
                    <div class="loading loading-spinner text-green-500"></div>
                </div>
                <button id="cancel-connection" class="btn btn-link text-red-500 hover:text-red-700 btn-sm w-full mt-3">
                    ‚ùå Sitzung abbrechen / Neustarten
                </button>
            </div>

            <div id="connected-section" class="bg-green-100 p-4 rounded-xl border border-green-300 hidden shadow-md">
                <h3 class="font-semibold text-green-800 mb-2 flex items-center">
                    <span class="connection-dot bg-green-500 animate-pulse"></span>
                    ‚úÖ Verbunden!
                </h3>
                <p class="text-sm text-green-700 mb-4">
                    Die P2P-Verbindung ist aktiv.
                </p>
                <button id="end-connection" class="btn btn-error btn-sm w-full">
                    ‚ùå Verbindung trennen
                </button>
            </div>
        </div>

        <div id="data-section" class="mt-6 hidden">
            <h3 class="font-semibold text-gray-800 mb-3">Status (Verbindung)</h3>
            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 shadow-inner">
                <div id="sync-data" class="text-sm text-gray-700 text-center py-2">
                    Warte auf manuelle Aktivit√§t...
                </div>
            </div>
        </div>
        
        <div id="chat-section" class="mt-6 hidden">
            <h3 class="font-semibold text-gray-800 mb-3">Mini-Chat</h3>
            
            <div id="chat-box" class="bg-gray-50 p-3 rounded-xl border border-gray-200 mb-3 space-y-2 shadow-inner">
                </div>

            <div id="file-progress-container" class="bg-white p-2 rounded-xl border border-gray-200 mb-3 hidden shadow-md">
                <h4 class="font-semibold text-gray-800 text-xs flex justify-between items-center">
                    Datei-√úbertragung
                    <span id="file-progress-text" class="text-xs text-gray-600"></span>
                </h4>
                <progress id="file-progress" class="progress progress-primary w-full h-2 mb-1" value="0" max="100"></progress>
                <div id="receive-status" class="text-sm text-center text-gray-600">Bereit zum Senden/Empfangen.</div>
            </div>

            <div class="flex space-x-2 items-center">
                <input type="file" id="media-file-input" accept="video/*,audio/*,image/*" class="hidden" />

                <button id="gif-trigger" class="btn btn-ghost text-xs font-bold text-gray-600 hover:text-blue-500 transition-colors">
                    GIF
                </button>

                <button id="media-trigger" class="btn btn-ghost btn-circle text-gray-600 hover:text-blue-500 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path></svg>
                </button>

                <input id="chat-input" type="text" placeholder="Nachricht eingeben..." class="input input-bordered w-full rounded-full" onkeydown="if(event.keyCode===13) document.getElementById('send-message').click()">
                <button id="send-message" class="btn btn-primary btn-circle">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M3.478 2.405a.75.75 0 0 0-.926.94l2.432 7.905H13.5a.75.75 0 0 1 0 1.5H4.984l-2.432 7.905a.75.75 0 0 0 .926.94 60.599 60.599 0 0 0 18.442-8.625.75.75 0 0 0 0-1.25 60.599 60.599 0 0 0-18.442-8.625Z" /></svg>
                </button>
            </div>
        </div>
    </div>

    <dialog id="gif_modal" class="modal">
        <div class="modal-box max-w-lg">
            <h3 class="font-bold text-lg text-gray-800 mb-4">üî• Dynamische GIF Suche (Uncut Stuff)</h3>
            <div class="flex mb-4">
                <input type="text" id="gif-search-input" placeholder="Nach GIFs suchen..." class="input input-bordered w-full" />
                <button id="gif-search-button" class="btn btn-primary ml-2">Suchen</button>
            </div>
            <div id="gif-gallery" class="grid grid-cols-3 gap-3 overflow-y-auto max-h-96">
                <p class="col-span-3 text-center text-gray-500">Lade GIFs...</p>
            </div>
            <p class="text-xs text-gray-500 mt-4">W√§hlen Sie ein GIF zum Senden √ºber den P2P DataChannel.</p>
            <div class="modal-action">
                <form method="dialog">
                    <button class="btn btn-sm btn-ghost">Schlie√üen</button>
                </form>
            </div>
        </div>
    </dialog>


    <script>
        // =================================================================
        // GLOBALE VARIABLEN & KONFIGURATION
        // =================================================================
        let peerConnection = null;
        let dataChannel = null;
        let currentRole = null; 
        let connectionAttempts = 0;
        const MAX_ATTEMPTS = 3;
        const STORAGE_KEY = 'mogul-p2p-offer-sdp'; 
        
        const CHUNK_SIZE = 16384; 
        let file = null;
        let fileReader = null;
        let nextSlice = 0;
        let receivedSlices = [];
        let receivingFileMeta = null;
        let answerCheckInterval = null;
        
        // **GIF API PLATZHALTER**
        // HINWEIS: Da ich keine echten API-Schl√ºssel verwenden kann, muss der Benutzer einen eigenen
        // GIPHY-API-Schl√ºssel f√ºr die dynamische Suche einf√ºgen.
        const GIPHY_API_KEY = 'YOUR_GIPHY_API_KEY_HERE'; // *** BITTE HIER EINF√úGEN ***
        const GIPHY_BASE_URL = 'https://api.giphy.com/v1/gifs/search';
        const GIPHY_TRENDING_URL = 'https://api.giphy.com/v1/gifs/trending';


        const config = {
            iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
        };

        // **HILFSFUNKTIONEN F√úR ROBUSTE KODIERUNG/DEKODIERUNG VON UTF-8 SDP**
        function b64EncodeUnicode(str) {
            return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,
                function(match, p1) {
                    return String.fromCharCode('0x' + p1);
                }));
        }

        function b64DecodeUnicode(str) {
            return decodeURIComponent(atob(str).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
        }

        function decodeBase64Json(base64String) {
            if (!base64String) {
                throw new Error("Leerer String f√ºr Decodierung.");
            }
            try {
                const decodedUri = decodeURIComponent(base64String.replace(/\s/g, ''));
                const jsonString = atob(decodedUri); 
                return JSON.parse(jsonString);
            } catch (e) {
                console.error("Decodierungsfehler:", e);
                throw new Error(`Decodierungsfehler: Der √ºbergebene Code ist ung√ºltig oder besch√§digt. (${e.message})`);
            }
        }

        // =================================================================
        // UI MANAGEMENT 
        // =================================================================
        function updateStatus(status, detail = "") {
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('status-text');
            const detailEl = document.getElementById('status-detail');
            
            const statusConfig = {
                'ready': { color: 'bg-gray-400', text: 'Bereit f√ºr Verbindung', detail: 'Klicken Sie auf "Verbindung starten"' },
                'generating': { color: 'bg-blue-500', text: 'Generiere Link...', detail: 'Erstelle sichere Verbindung' },
                'waiting': { color: 'bg-yellow-500', text: 'Warte auf Antwort...', detail: 'Teilen Sie den Link mit der anderen Person' },
                'connecting': { color: 'bg-orange-500', text: 'Verbinde...', detail: 'Stelle P2P-Verbindung her' },
                'connected': { color: 'bg-green-500', text: 'Verbunden!', detail: 'P2P-Verbindung aktiv' },
                'error': { color: 'bg-red-500', text: 'Fehler', detail: 'Verbindung fehlgeschlagen' }
            };
            
            const config = statusConfig[status] || statusConfig.ready;
            dot.className = `connection-dot ${config.color}`; 
            text.textContent = config.text;
            detailEl.textContent = detail || config.detail;
        }

        function showSection(sectionId) {
            document.getElementById('link-section').classList.add('hidden');
            document.getElementById('offer-section').classList.add('hidden');
            document.getElementById('answer-section').classList.add('hidden');
            document.getElementById('connected-section').classList.add('hidden');
            document.getElementById('data-section').classList.add('hidden');
            document.getElementById('chat-section').classList.add('hidden');
            
            if (sectionId === 'link-section') {
                document.getElementById('link-section').classList.remove('hidden');
                document.getElementById('offer-section').classList.remove('hidden');
                
                const copyBtn = document.getElementById('copy-offer');
                copyBtn.className = 'btn btn-outline btn-primary w-full';

            } else if (sectionId === 'answer-section') {
                document.getElementById('link-section').classList.remove('hidden');
                document.getElementById('answer-section').classList.remove('hidden');
                document.getElementById('cancel-connection').classList.remove('hidden');
            
            } else if (sectionId === 'connected-section') {
                document.getElementById('connected-section').classList.remove('hidden');
                document.getElementById('data-section').classList.remove('hidden');
                document.getElementById('chat-section').classList.remove('hidden');
            } else if (sectionId) {
                document.getElementById(sectionId).classList.remove('hidden');
            }
        }

        function displaySyncData(data) {
            const container = document.getElementById('sync-data');
            const timestamp = new Date().toLocaleTimeString();
            
            container.innerHTML = `
                <div class="text-sm text-gray-700 text-center py-2">
                    ‚úÖ Letzter Sync-Status empfangen um ${timestamp}
                </div>
            `;
        }
        
        // =================================================================
        // CHAT & MEDIA RENDERING
        // =================================================================

        function displayMediaPreview(sender, fileUrl, fileName, fileMimeType, isLocal = false) {
            const chatBox = document.getElementById('chat-box');
            const senderClass = isLocal ? 'text-right' : 'text-left';
            const bubbleClass = isLocal ? 'bg-blue-500 text-white ml-auto' : 'bg-gray-200 text-gray-800 mr-auto';
            const senderName = isLocal ? 'Ich' : sender;
            
            let mediaContent;
            
            if (fileMimeType.startsWith('image/') || fileMimeType === 'image/gif') {
                mediaContent = `<div class="image-container"><img src="${fileUrl}" class="embedded-media" alt="${fileName}" /></div>`;
            } else if (fileMimeType.startsWith('video/')) {
                mediaContent = `<div class="video-container"><video src="${fileUrl}" controls class="embedded-media" preload="metadata"></video></div>`;
            } else if (fileMimeType.startsWith('audio/')) {
                mediaContent = `
                    <div class="audio-container">
                        <audio id="audio-${Date.now()}" src="${fileUrl}" controls preload="metadata" class="w-full"></audio>
                        <button class="btn btn-xs btn-outline btn-primary speed-button" onclick="toggleAudioSpeed(this)">1x</button>
                    </div>`;
            } else {
                mediaContent = `<div class="p-2 text-sm">Empfangen: ${fileName} (${fileMimeType}). <a href="${fileUrl}" download="${fileName}" class="text-blue-500 underline">Download</a></div>`;
            }

            const messageElement = document.createElement('div');
            messageElement.className = senderClass;
            messageElement.innerHTML = `
                <div class="text-xs font-semibold ${isLocal ? 'text-blue-600' : 'text-gray-600'}">${senderName}</div>
                <div class="inline-block p-1 rounded-lg ${bubbleClass} max-w-[90%] break-words">
                    ${mediaContent}
                </div>
            `;
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        window.toggleAudioSpeed = function(button) {
            const audio = button.previousElementSibling;
            if (audio.playbackRate === 1) {
                audio.playbackRate = 2;
                button.textContent = '2x';
                button.classList.replace('btn-outline', 'btn-active');
            } else {
                audio.playbackRate = 1;
                button.textContent = '1x';
                button.classList.replace('btn-active', 'btn-outline');
            }
        };

        function displayChatMessage(sender, message, isLocal = false) {
            const chatBox = document.getElementById('chat-box');
            const senderClass = isLocal ? 'text-right' : 'text-left';
            const bubbleClass = isLocal ? 'bg-blue-500 text-white ml-auto' : 'bg-gray-200 text-gray-800 mr-auto';
            const senderName = isLocal ? 'Ich' : sender;
            
            const messageElement = document.createElement('div');
            messageElement.className = senderClass;
            messageElement.innerHTML = `
                <div class="text-xs font-semibold ${isLocal ? 'text-blue-600' : 'text-gray-600'}">${senderName}</div>
                <div class="inline-block p-2 rounded-lg ${bubbleClass} max-w-[80%] break-words">
                    ${message}
                </div>
            `;
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // =================================================================
        // P2P VERBINDUNGS LOGIK
        // =================================================================
        
        function getOfferCodeFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            let offerCode = urlParams.get('offer');

            if (!offerCode) {
                const urlHash = window.location.hash.substring(1);
                const hashParams = new URLSearchParams(urlHash);
                offerCode = hashParams.get('offer');
            }
            return offerCode;
        }
        
        function getAnswerCodeFromUrl() {
            const urlHash = window.location.hash.substring(1);
            const hashParams = new URLSearchParams(urlHash);
            return hashParams.get('answer');
        }

        async function startConnection(restoredSdp = null) {
            try {
                document.getElementById('start-connection').disabled = true;
                document.getElementById('start-button-container').classList.add('hidden'); 
                updateStatus('generating');
                
                const offerCode = getOfferCodeFromUrl();
                
                if (offerCode) {
                    currentRole = 'responder';
                    history.replaceState(null, '', window.location.pathname); 
                    await handleIncomingOffer(offerCode);

                } else if (restoredSdp) {
                    currentRole = 'initiator';
                    await continueInitiatorFlow(restoredSdp);
                    
                } else {
                    currentRole = 'initiator';
                    await createAndShareOffer();
                }
            } catch (error) {
                console.error('Verbindungsfehler im startConnection:', error);
                updateStatus('error', `Fehler: ${error.message}`);
                
                if (connectionAttempts < MAX_ATTEMPTS) {
                    connectionAttempts++;
                    setTimeout(() => {
                        updateStatus('ready', `Automatischer Wiederholungsversuch (${connectionAttempts}/${MAX_ATTEMPTS})`);
                        document.getElementById('start-connection').disabled = false;
                        document.getElementById('start-button-container').classList.remove('hidden'); 
                    }, 3000);
                } else {
                     document.getElementById('start-connection').disabled = false;
                     document.getElementById('start-button-container').classList.remove('hidden'); 
                }
            }
        }

        async function createAndShareOffer() {
            if (peerConnection) {
                peerConnection.close();
            }

            peerConnection = new RTCPeerConnection(config);
            dataChannel = peerConnection.createDataChannel("mogul-sync", { negotiated: false });
            setupDataChannel(dataChannel);

            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            
            localStorage.setItem(STORAGE_KEY, peerConnection.localDescription.sdp);

            await new Promise(resolve => {
                if (peerConnection.iceGatheringState === 'complete') {
                    resolve();
                } else {
                    peerConnection.onicegatheringstatechange = () => {
                        if (peerConnection.iceGatheringState === 'complete') {
                            resolve();
                        }
                    };
                    setTimeout(resolve, 2000); 
                }
            });

            const offerData = {
                type: 'offer',
                sdp: b64EncodeUnicode(peerConnection.localDescription.sdp), 
                timestamp: Date.now()
            };
            
            const offerString = btoa(JSON.stringify(offerData)); 
            const shareableUrl = `${window.location.origin}${window.location.pathname}?offer=${encodeURIComponent(offerString)}`;
            
            document.getElementById('offer-link').textContent = shareableUrl;
            showSection('link-section');
            updateStatus('waiting', 'Teilen Sie diesen Link mit der anderen Person');
            
            await waitForAnswer();
        }

        async function continueInitiatorFlow(restoredSdp) {
            updateStatus('connecting', 'Sitzung wiederhergestellt. Warte auf Antwort.');
            
            peerConnection = new RTCPeerConnection(config);
            dataChannel = peerConnection.createDataChannel("mogul-sync", { negotiated: false });
            setupDataChannel(dataChannel);
            
            peerConnection.localDescription = new RTCSessionDescription({ type: 'offer', sdp: restoredSdp });
            
            await waitForAnswer(true); 
        }

        async function handleIncomingOffer(offerCode) {
            updateStatus('connecting', 'Verarbeite eingehende Verbindung...');
            
            try {
                const offerData = decodeBase64Json(offerCode); 
                if (offerData.type !== 'offer') throw new Error('Ung√ºltiger Offer-Code Typ');
                
                const remoteOffer = {
                    type: 'offer',
                    sdp: b64DecodeUnicode(offerData.sdp)
                };

                peerConnection = new RTCPeerConnection(config);
                
                peerConnection.ondatachannel = (event) => {
                    dataChannel = event.channel;
                    setupDataChannel(dataChannel); 
                    establishConnection();
                };

                await peerConnection.setRemoteDescription(remoteOffer);
                
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);

                await new Promise(resolve => {
                    if (peerConnection.iceGatheringState === 'complete') {
                        resolve();
                    } else {
                        peerConnection.onicegatheringstatechange = () => {
                            if (peerConnection.iceGatheringState === 'complete') {
                                resolve();
                            }
                        };
                        setTimeout(resolve, 2000);
                    }
                });

                const answerData = {
                    type: 'answer',
                    sdp: b64EncodeUnicode(peerConnection.localDescription.sdp), 
                    timestamp: Date.now()
                };
                const answerString = btoa(JSON.stringify(answerData));
                
                const finalAnswerUrl = `${window.location.origin}${window.location.pathname}#answer=${encodeURIComponent(answerString)}`;
                
                updateStatus('waiting', 'Antwort-Link erzeugt. Bitte diesen Link dem Initiator geben.');
                document.getElementById('offer-link').textContent = finalAnswerUrl;
                showSection('link-section');
                
                document.getElementById('offer-section').querySelector('h3').innerHTML = '<span class="connection-dot bg-green-500"></span>Schritt 2: Antwort-Link teilen';
                document.getElementById('offer-section').querySelector('p').textContent = 'Teilen Sie diesen Link mit der anderen Person (Initiator), damit dieser die Verbindung abschlie√üen kann:';
                
                document.getElementById('copy-offer').textContent = 'üìã Antwort-Link kopieren';
                
            } catch (error) {
                console.error('Fehler bei eingehender Verbindung:', error);
                throw new Error(`Verbindungsfehler: ${error.message}`);
            }
        }

        async function waitForAnswer(answerPresentOnLoad = false) {
            
            if (answerPresentOnLoad) {
                 const answerCode = getAnswerCodeFromUrl();
                 if (answerCode) {
                    await processAnswer(answerCode);
                    return;
                 }
            }

            updateStatus('waiting', 'Warte auf die Gegenstelle, um den Answer-Code zur√ºckzusenden...');
            showSection('answer-section'); 
            document.getElementById('wait-message').textContent = 'Warte auf die Gegenstelle, um den Answer-Code zur√ºckzusenden...';
            document.getElementById('cancel-connection').classList.remove('hidden');


            return new Promise((resolve, reject) => {
                answerCheckInterval = setInterval(async () => { 
                    try {
                        const answerCode = getAnswerCodeFromUrl();
                        
                        if (answerCode) {
                            clearInterval(answerCheckInterval);
                            answerCheckInterval = null; 
                            await processAnswer(answerCode);
                            resolve();
                        }
                    } catch (error) {
                        clearInterval(answerCheckInterval);
                        answerCheckInterval = null; 
                        reject(error);
                    }
                }, 1000);

                setTimeout(() => {
                    if (answerCheckInterval) {
                        clearInterval(answerCheckInterval);
                        answerCheckInterval = null; 
                        reject(new Error('Timeout: Keine Antwort erhalten'));
                    }
                }, 120000);
            });
        }
        
        async function processAnswer(answerCode) {
            updateStatus('connecting', 'Empfange Antwort. Stelle Verbindung her...');
            
            history.replaceState(null, '', window.location.pathname);
            localStorage.removeItem(STORAGE_KEY); 
            
            const answerData = decodeBase64Json(answerCode);
            if (answerData.type !== 'answer') {
                throw new Error('Ung√ºltiger Answer-Code Typ');
            }

            const remoteAnswer = {
                type: 'answer',
                sdp: b64DecodeUnicode(answerData.sdp)
            };

            await peerConnection.setRemoteDescription(remoteAnswer);
            await establishConnection();
        }

        function resetConnectionState() {
            if (peerConnection) {
                if (peerConnection.connectionState !== 'closed' && peerConnection.connectionState !== 'failed') {
                    peerConnection.close();
                }
                peerConnection = null;
            }
            if (answerCheckInterval) {
                clearInterval(answerCheckInterval);
                answerCheckInterval = null;
            }
            localStorage.removeItem(STORAGE_KEY);
            
            updateStatus('ready');
            document.getElementById('start-button-container').classList.remove('hidden');
            
            document.getElementById('link-section').classList.add('hidden');
            document.getElementById('offer-section').classList.add('hidden');
            document.getElementById('answer-section').classList.add('hidden');
            document.getElementById('connected-section').classList.add('hidden');
            document.getElementById('data-section').classList.add('hidden');
            document.getElementById('chat-section').classList.add('hidden');
            document.getElementById('file-progress-container').classList.add('hidden');
            
            document.getElementById('cancel-connection').classList.add('hidden');
        }

        function endConnection() {
            resetConnectionState();
        }


        async function establishConnection() {
            updateStatus('connecting', 'Stelle finale Verbindung her...');

            if (!dataChannel) {
                if (currentRole === 'responder') {
                    updateStatus('connecting', 'Warte auf DataChannel-Empfang/√ñffnung...');
                    return; 
                }
                throw new Error("DataChannel konnte nicht initialisiert werden.");
            }

            await new Promise((resolve, reject) => {
                const timeout = setTimeout(() => {
                    reject(new Error('Verbindungstimeout: DataChannel √∂ffnet nicht'));
                }, 30000);

                if (dataChannel.readyState === 'open') {
                    clearTimeout(timeout);
                    resolve();
                } else {
                    dataChannel.onopen = () => {
                        clearTimeout(timeout);
                        resolve();
                    };
                    dataChannel.onerror = (error) => {
                        clearTimeout(timeout);
                        reject(error);
                    };
                }
            });

            updateStatus('connected', 'P2P-Verbindung aktiv!');
            showSection('connected-section');
            
            document.getElementById('start-button-container').classList.add('hidden'); 

            document.getElementById('sync-data').innerHTML = 'Die P2P-Verbindung ist aktiv und bereit f√ºr Daten√ºbertragung.';

            document.getElementById('chat-box').innerHTML = '<div class="text-center text-xs text-gray-500">Verbindung hergestellt. Starte Chat!</div>';
            document.getElementById('send-message').addEventListener('click', () => {
                const input = document.getElementById('chat-input');
                if (input.value.trim() !== '') {
                    sendMessage(input.value);
                    input.value = '';
                }
            });
        }

        function setupDataChannel(channel) {
            channel.onopen = () => {
                console.log('DataChannel ge√∂ffnet');
            };

            channel.onmessage = async (event) => {
                if (typeof event.data === 'string') {
                    try {
                        const data = JSON.parse(event.data);
                        
                        if (data.type === 'chat') {
                            const sender = data.deviceName;
                            displayChatMessage(sender, data.message, false);
                        } else if (data.type === 'file-meta') {
                            handleIncomingFileMeta(data);
                        } else if (data.type === 'file-end') {
                            handleFileTransferEnd();
                        } else if (data.type === 'sync-data') {
                            displaySyncData(data);
                        }
                    } catch (e) {
                        console.log('Empfangene Nachricht (Nicht-JSON):', event.data);
                    }
                } else if (event.data instanceof ArrayBuffer) {
                    handleIncomingFileChunk(event.data);
                }
            };

            channel.onclose = () => {
                resetConnectionState(); 
            };

            channel.onerror = (error) => {
                console.error('DataChannel Fehler:', error);
                resetConnectionState();
                updateStatus('error', 'Verbindungsfehler im DataChannel');
            };
        }

        function sendMessage(message) {
            if (dataChannel && dataChannel.readyState === 'open') {
                const chatData = {
                    type: 'chat',
                    deviceName: currentRole === 'initiator' ? 'Ger√§t A' : 'Ger√§t B',
                    message: message,
                    timestamp: new Date().toISOString()
                };
                
                dataChannel.send(JSON.stringify(chatData));
                displayChatMessage('Ich', message, true);
            } else {
                alert('Verbindung ist nicht aktiv. Bitte warten Sie auf "Verbunden!"');
            }
        }

        // =================================================================
        // DATEI-SENDEN & EMPFANGEN LOGIK
        // =================================================================

        function sendFile(file) {
            document.getElementById('file-progress-container').classList.remove('hidden');

            const fileMeta = {
                type: 'file-meta',
                name: file.name,
                size: file.size,
                mimeType: file.type,
                sender: currentRole === 'initiator' ? 'Ger√§t A' : 'Ger√§t B'
            };
            dataChannel.send(JSON.stringify(fileMeta));

            fileReader = new FileReader();
            let offset = 0;
            
            function sendSlice() {
                if (!dataChannel || dataChannel.readyState !== 'open') {
                    console.error('DataChannel ist nicht bereit.');
                    return;
                }
                
                const slice = file.slice(offset, offset + CHUNK_SIZE);
                fileReader.readAsArrayBuffer(slice);
            }

            fileReader.onload = (e) => {
                dataChannel.send(e.target.result);
                offset += e.target.result.byteLength;
                
                updateFileProgress(offset, file.size);

                if (offset < file.size) {
                    if (dataChannel.bufferedAmount === 0) {
                        sendSlice();
                    } else {
                        setTimeout(sendSlice, 100);
                    }
                } else {
                    dataChannel.send(JSON.stringify({ type: 'file-end' }));
                    document.getElementById('receive-status').textContent = `Datei "${file.name}" erfolgreich gesendet.`;
                    
                    const fileUrl = URL.createObjectURL(file);
                    displayMediaPreview(fileMeta.sender, fileUrl, fileMeta.name, fileMeta.mimeType, true);
                    
                    document.getElementById('media-file-input').value = '';
                    document.getElementById('file-progress-container').classList.add('hidden');
                }
            };
            
            sendSlice();
        }

        function handleIncomingFileMeta(meta) {
            receivingFileMeta = meta;
            receivedSlices = [];
            document.getElementById('file-progress-container').classList.remove('hidden');
            document.getElementById('file-progress').value = 0;
            document.getElementById('receive-status').textContent = `Empfange Datei von ${meta.sender}: "${meta.name}" (${(meta.size / 1024 / 1024).toFixed(2)} MB)...`;
        }

        function handleIncomingFileChunk(data) {
            if (!receivingFileMeta) return;

            receivedSlices.push(data);
            const totalReceived = receivedSlices.reduce((sum, chunk) => sum + chunk.byteLength, 0);

            updateFileProgress(totalReceived, receivingFileMeta.size);
        }

        function handleFileTransferEnd() {
            if (!receivingFileMeta) return;

            const blob = new Blob(receivedSlices, { type: receivingFileMeta.mimeType });
            
            const fileUrl = URL.createObjectURL(blob);
            const fileName = receivingFileMeta.name;
            const fileMimeType = receivingFileMeta.mimeType;
            const sender = receivingFileMeta.sender;
            const statusEl = document.getElementById('receive-status');
            
            statusEl.innerHTML = `Datei **${fileName}** empfangen.`;

            displayMediaPreview(sender, fileUrl, fileName, fileMimeType, false);

            receivingFileMeta = null;
            receivedSlices = [];
            document.getElementById('file-progress-container').classList.add('hidden');
        }

        function updateFileProgress(transferred, total) {
            const percent = Math.floor((transferred / total) * 100);
            const progressEl = document.getElementById('file-progress');
            const progressTextEl = document.getElementById('file-progress-text');
            
            progressEl.value = percent;
            progressTextEl.textContent = `Fortschritt: ${percent}% (${(transferred / 1024 / 1024).toFixed(2)} MB / ${(total / 1024 / 1024).toFixed(2)} MB)`;

            if (percent === 100) {
                document.getElementById('receive-status').textContent = '√úbertragung abgeschlossen.';
            } else if (percent > 0) {
                 document.getElementById('receive-status').textContent = '√úbertrage Daten...';
            }
        }


        // =================================================================
        // EVENT LISTENER & INITIALISIERUNG
        // =================================================================
        document.addEventListener('DOMContentLoaded', function() {
            const copyOfferButton = document.getElementById('copy-offer');
            const endConnectionButton = document.getElementById('end-connection');
            const mediaTriggerButton = document.getElementById('media-trigger');
            const gifTriggerButton = document.getElementById('gif-trigger');
            const fileInput = document.getElementById('media-file-input');
            const cancelButton = document.getElementById('cancel-connection'); 

            // --- P2P Start / End / Cancel ---
            document.getElementById('start-connection').addEventListener('click', () => {
                 localStorage.removeItem(STORAGE_KEY); 
                 startConnection();
            });
            if (endConnectionButton) {
                endConnectionButton.addEventListener('click', endConnection);
            }
            if (cancelButton) {
                cancelButton.addEventListener('click', resetConnectionState); 
            }

            // --- GIF Trigger ---
            gifTriggerButton.addEventListener('click', function() {
                if (dataChannel && dataChannel.readyState === 'open') {
                    const modal = document.getElementById('gif_modal');
                    const gallery = document.getElementById('gif-gallery');
                    const searchInput = document.getElementById('gif-search-input');
                    const searchButton = document.getElementById('gif-search-button');

                    gallery.innerHTML = '<p class="col-span-3 text-center text-gray-500">Lade trendende GIFs...</p>';
                    modal.showModal();

                    const fetchGifs = async (query = '') => {
                        gallery.innerHTML = '<p class="col-span-3 text-center text-gray-500">Suche l√§uft...</p>';
                        
                        // **WICHTIG:** Simuliere hier den API-Aufruf
                        if (GIPHY_API_KEY === 'YOUR_GIPHY_API_KEY_HERE') {
                            // Verwende statische GIFs, da kein API-Schl√ºssel vorhanden ist
                            gallery.innerHTML = '<p class="col-span-3 text-center text-red-500 font-bold">FEHLER: Bitte GIPHY_API_KEY einf√ºgen. Nutze statische Platzhalter...</p>';
                            
                            const staticGifs = SICK_GIF_GALLERY.filter((_, i) => i < 6);
                            displayGifGallery(staticGifs);
                        } else {
                            // F√ºhre tats√§chlichen API-Aufruf aus (wenn Schl√ºssel vorhanden)
                            const url = query ? `${GIPHY_BASE_URL}?api_key=${GIPHY_API_KEY}&q=${encodeURIComponent(query)}&limit=9&rating=r` : `${GIPHY_TRENDING_URL}?api_key=${GIPHY_API_KEY}&limit=9&rating=r`;
                            
                            try {
                                const response = await fetch(url);
                                const json = await response.json();
                                const gifUrls = json.data.map(item => item.images.fixed_width.url);
                                displayGifGallery(gifUrls);
                            } catch (e) {
                                gallery.innerHTML = '<p class="col-span-3 text-center text-red-500">Fehler beim Laden von GIPHY. Netzwerkproblem oder ung√ºltiger Schl√ºssel.</p>';
                            }
                        }
                    };

                    const displayGifGallery = (urls) => {
                        gallery.innerHTML = '';
                        urls.forEach(url => {
                            const imgWrapper = document.createElement('div');
                            imgWrapper.className = 'cursor-pointer p-0.5 border-2 border-transparent hover:border-blue-500 transition-all duration-100';
                            imgWrapper.innerHTML = `<img src="${url}" class="w-full h-auto rounded" />`;
                            
                            imgWrapper.addEventListener('click', () => {
                                selectAndSendGif(url);
                                modal.close();
                            });
                            gallery.appendChild(imgWrapper);
                        });
                        if (urls.length === 0) {
                            gallery.innerHTML = '<p class="col-span-3 text-center text-gray-500">Keine Ergebnisse gefunden.</p>';
                        }
                    };

                    searchButton.onclick = () => fetchGifs(searchInput.value);
                    searchInput.onkeydown = (e) => { if (e.key === 'Enter') fetchGifs(searchInput.value); };

                    fetchGifs(); // Lade initiale GIFs
                    

                } else {
                    alert('Verbindung ist nicht aktiv. Bitte warten Sie auf "Verbunden!"');
                }
            });

            function selectAndSendGif(gifUrl) {
                const chatData = {
                    type: 'chat',
                    deviceName: currentRole === 'initiator' ? 'Ger√§t A' : 'Ger√§t B',
                    message: gifUrl, 
                    mimeType: 'image/gif',
                    isMedia: true,
                    timestamp: new Date().toISOString()
                };
                
                dataChannel.send(JSON.stringify(chatData));
                
                displayMediaPreview(chatData.deviceName, chatData.message, 'GIF', 'image/gif', true);
            }


            // --- Datei Senden Trigger ---
            mediaTriggerButton.addEventListener('click', function() {
                if (dataChannel && dataChannel.readyState === 'open') {
                    fileInput.click();
                } else {
                    alert('Verbindung ist nicht aktiv. Bitte warten Sie auf "Verbunden!", bevor Sie eine Datei senden.');
                }
            });

            fileInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    file = this.files[0];
                    if (file.size > 200 * 1024 * 1024) { 
                         alert('Die Datei ist zu gro√ü (max. 200 MB).');
                         this.value = '';
                         return;
                    }

                    if (confirm(`M√∂chten Sie die Datei "${file.name}" (${(file.size / 1024 / 1024).toFixed(2)} MB) senden?`)) {
                        sendFile(file);
                    } else {
                        this.value = '';
                    }
                }
            });
            
            // --- UI/Share Logik ---
            copyOfferButton.addEventListener('click', function() {
                const link = document.getElementById('offer-link').textContent;
                navigator.clipboard.writeText(link).then(() => {
                    this.textContent = '‚úÖ Kopiert!';
                    setTimeout(() => {
                        this.textContent = (currentRole === 'responder' ? 'üìã Antwort-Link kopieren' : 'üìã Link kopieren');
                    }, 2000);
                });
            });
            
            // --- Automatischer Start / Zustandswiederherstellung ---
            const offerCode = getOfferCodeFromUrl();
            const answerCode = getAnswerCodeFromUrl();
            const storedSdp = localStorage.getItem(STORAGE_KEY); 

            if (offerCode) {
                setTimeout(startConnection, 500);
            } else if (answerCode && storedSdp) {
                localStorage.removeItem(STORAGE_KEY); 
                setTimeout(() => startConnection(storedSdp), 500);
            } else if (storedSdp && !answerCode) {
                setTimeout(() => continueInitiatorFlow(storedSdp), 500); 
                document.getElementById('start-button-container').classList.add('hidden');
            } else if (answerCode && !storedSdp) {
                history.replaceState(null, '', window.location.pathname);
                setTimeout(() => {
                    document.getElementById('start-connection').disabled = true;
                    updateStatus('error', 'Fehler: Sitzung abgelaufen.');
                    document.getElementById('start-button-container').classList.remove('hidden');
                    document.getElementById('status-detail').textContent = 'Der Answer-Code ist abgelaufen. Bitte klicken Sie auf "Verbindung starten", um einen neuen Link zu generieren.';
                }, 500);
            }

            console.log('Mogul P2P Sync - Finaler Code geladen.');
        });
    </script>
</body>
</html>
