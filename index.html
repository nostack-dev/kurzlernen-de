<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>kurzlernen.de</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- DaisyUI -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- html2pdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
    <!-- RecordRTC.js -->
    <script src="https://cdn.jsdelivr.net/npm/recordrtc@5.6.2/RecordRTC.js"></script>
</head>
<body class="bg-base-200 text-base-content">
    <!-- Header mit DaisyUI Navbar -->
    <header class="navbar bg-base-300">
        <div class="flex-1">
            <a class="btn btn-ghost normal-case text-xl">10-Minuten-Herausforderung</a>
        </div>
        <div class="flex-none">
            <!-- Farbschema Dropdown -->
            <div class="dropdown dropdown-end">
                <label tabindex="0" class="btn btn-secondary m-1">Farbschema √§ndern</label>
                <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-52">
                    <li><a href="#" onclick="setTheme('light')">Licht</a></li>
                    <li><a href="#" onclick="setTheme('dark')">Dunkel</a></li>
                    <li><a href="#" onclick="setTheme('cupcake')">Cupcake</a></li>
                    <li><a href="#" onclick="setTheme('emerald')">Emerald</a></li>
                    <li><a href="#" onclick="setTheme('synthwave')">Synthwave</a></li>
                    <li><a href="#" onclick="setTheme('dracula')">Dracula</a></li>
                </ul>
            </div>
        </div>
    </header>

    <div class="mx-auto p-4 max-w-screen-md">
        <div class="flex flex-col items-center">
            <button class="btn btn-secondary mt-2 w-full" onclick="confirmResetTasks()">Neues Set an Aufgaben</button>
            <button class="btn btn-accent mt-4 w-full" onclick="printTasksAsPDF()">Alle Aufgaben als PDF drucken</button>
        </div>

        <!-- Aufgaben-Bereich -->
        <div id="tasks" class="mt-4">
            <!-- Aufgabe 1: Lesen -->
            <div id="task1" class="task card shadow-lg bg-base-100 mb-8">
                <div class="card-body">
                    <h2 class="card-title text-lg font-bold">Aufgabe 1: Lesen</h2>
                    <div class="flex items-center justify-center">
                        <progress id="progress1" class="progress progress-primary w-full max-w-xs" value="100" max="100"></progress>
                        <span id="timer1" class="ml-4 text-lg font-mono">10:00</span>
                    </div>
                    <p class="py-4 text-center">Lesen Sie den folgenden Text laut vor, w√§hrend die Aufnahme l√§uft:</p>
                    <p id="readText" class="py-2 text-center">
                        <strong>Lesetext:</strong><br>
                        <!-- Platzhalter, wird durch JavaScript ersetzt -->
                    </p>
                    <button id="toggleTimer1" class="btn btn-primary mt-4 w-full" onclick="toggleTask(1)">Aufgabe beginnen</button>
                    <div id="savedRecording" class="mt-4 hidden">
                        <audio id="audioPlayer" controls></audio>
                        <span id="recordingName" class="ml-2"></span>
                        <button class="btn btn-error btn-sm ml-4" onclick="confirmDeleteRecording()">üóëÔ∏è L√∂schen</button>
                    </div>
                </div>
            </div>

            <!-- Aufgabe 2: Schreiben -->
            <div id="task2" class="task card shadow-lg bg-base-100 mb-8">
                <div class="card-body">
                    <h2 class="card-title text-lg font-bold">Aufgabe 2: Abschreiben</h2>
                    <div class="flex items-center justify-center">
                        <progress id="progress2" class="progress progress-secondary w-full max-w-xs" value="100" max="100"></progress>
                        <span id="timer2" class="ml-4 text-lg font-mono">10:00</span>
                    </div>
                    <p id="writeText" class="mt-4 text-center">
                        <!-- Platzhalter, wird durch JavaScript ersetzt -->
                    </p>
                    <button id="toggleTimer2" class="btn btn-primary mt-4 w-full" onclick="toggleTask(2)">Aufgabe beginnen</button>
                    
                    <!-- Stilisiertes Datei-Upload-Feld -->
                    <label for="proofUpload" class="btn btn-primary mt-4 w-full">Foto der Abschrift hochladen</label>
                    <input id="proofUpload" type="file" accept="image/*" class="hidden" onchange="uploadProof()" />
                    
                    <div id="savedProof" class="mt-4 hidden">
                        <span id="proofName" class="ml-2"></span>
                        <button class="btn btn-error btn-sm ml-4" onclick="confirmDeleteProof()">üóëÔ∏è L√∂schen</button>
                        <a id="proofPreview" href="#" class="btn btn-link ml-2 hidden" target="_blank">Vorschau anzeigen</a>
                    </div>
                </div>
            </div>

            <!-- Aufgabe 3: Mathe -->
            <div id="task3" class="task card shadow-lg bg-base-100 mb-8">
                <div class="card-body">
                    <h2 class="card-title text-lg font-bold">Aufgabe 3: Rechenaufgaben</h2>
                    <div class="flex items-center justify-center">
                        <progress id="progress3" class="progress progress-accent w-full max-w-xs" value="100" max="100"></progress>
                        <span id="timer3" class="ml-4 text-lg font-mono">10:00</span>
                    </div>
                    <button id="toggleTimer3" class="btn btn-primary mt-4 w-full" onclick="toggleTask(3)">Aufgabe beginnen</button>
                    <div id="mathText" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4"></div>
                </div>
            </div>
        </div>

        <!-- WhatsApp-Button -->
        <button id="submitBtn" class="btn btn-success fixed bottom-4 right-4 hidden" onclick="sendResultsViaWhatsApp()">Per WhatsApp versenden</button>
    </div>

    <!-- Modale f√ºr Validierungen -->
    <!-- Modale bleiben unver√§ndert -->
    <input type="checkbox" id="validationModal" class="modal-toggle" />
    <div class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Abgabe-Validierung</h3>
            <p id="validationMessage" class="py-4"></p>
            <div class="modal-action">
                <label for="validationModal" class="btn">Schlie√üen</label>
            </div>
        </div>
    </div>

    <!-- Best√§tigungsmodal f√ºr das Stoppen der Aufnahme -->
    <input type="checkbox" id="confirmStopRecordingModal" class="modal-toggle" />
    <div class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Aufnahme beenden?</h3>
            <p class="py-4">M√∂chten Sie die Aufnahme wirklich beenden? Falls dies ein Versehen war, k√∂nnen Sie den Vorgang fortsetzen.</p>
            <div class="modal-action">
                <label class="btn btn-error" onclick="stopTaskConfirmed(1)">Ja, beenden</label>
                <label for="confirmStopRecordingModal" class="btn">Abbrechen</label>
            </div>
        </div>
    </div>

    <!-- Best√§tigungsmodal f√ºr das L√∂schen der Aufnahme -->
    <input type="checkbox" id="confirmDeleteRecordingModal" class="modal-toggle" />
    <div class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Aufnahme l√∂schen?</h3>
            <p class="py-4">M√∂chten Sie die Aufnahme wirklich l√∂schen?</p>
            <div class="modal-action">
                <label class="btn btn-error" onclick="deleteRecording()">Ja, l√∂schen</label>
                <label for="confirmDeleteRecordingModal" class="btn">Abbrechen</label>
            </div>
        </div>
    </div>

    <!-- Best√§tigungsmodal f√ºr das L√∂schen des Beweises -->
    <input type="checkbox" id="confirmDeleteProofModal" class="modal-toggle" />
    <div class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Beweis l√∂schen?</h3>
            <p class="py-4">M√∂chten Sie den Beweis wirklich l√∂schen?</p>
            <div class="modal-action">
                <label class="btn btn-error" onclick="deleteProof()">Ja, l√∂schen</label>
                <label for="confirmDeleteProofModal" class="btn">Abbrechen</label>
            </div>
        </div>
    </div>

    <!-- Best√§tigungsmodal f√ºr das Zur√ºcksetzen -->
    <input type="checkbox" id="confirmResetModal" class="modal-toggle" />
    <div class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Aufgaben zur√ºcksetzen?</h3>
            <p class="py-4">M√∂chten Sie wirklich die Aufgaben zur√ºcksetzen? Alle bisherigen Fortschritte gehen verloren.</p>
            <div class="modal-action">
                <label class="btn btn-error" onclick="resetTasks()">Ja, zur√ºcksetzen</label>
                <label for="confirmResetModal" class="btn">Abbrechen</label>
            </div>
        </div>
    </div>

    <!-- Druckfreundlicher Bereich -->
    <div id="printableTasks" class="hidden">
        <div style="padding: 2rem; background-color: white; color: black;">
            <div id="printableTask1" style="margin-bottom: 2rem;">
                <h1 style="font-size: 2rem; font-weight: bold; margin-bottom: 1rem; text-align: center;">10-Minuten-Herausforderung</h1>
                <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem;">Aufgabe 1: Lesen</h2>
                <p><strong>Lesetext:</strong></p>
                <p id="printableReadText" style="border-bottom: 2px dashed black; padding-bottom: 1rem; margin-bottom: 1rem; min-height: 60px;">
                    <!-- Lesetext -->
                </p>
                <p style="margin-bottom: 2rem;"><strong>Notizen:</strong></p>
                <div style="border-top: 2px dashed black; padding-top: 1rem; margin-bottom: 2rem; min-height: 100px;">
                    <!-- Notizenbereich -->
                </div>
            </div>
            <div id="printableTask2" style="margin-bottom: 2rem;">
                <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem;">Aufgabe 2: Abschreiben</h2>
                <p><strong>Abschreibtext:</strong></p>
                <p id="printableWriteText" style="border-bottom: 2px dashed black; padding-bottom: 1rem; margin-bottom: 1rem; min-height: 60px;">
                    <!-- Abschreibtext -->
                </p>
                <p style="margin-bottom: 2rem;"><strong>Foto der Abschrift:</strong></p>
                <div id="printableProof" style="border: 2px dashed black; padding: 1rem; margin-bottom: 2rem; min-height: 150px; text-align: center;">
                    <!-- Platz f√ºr das Foto oder QR-Code -->
                    <!-- Wird dynamisch eingef√ºgt -->
                </div>
            </div>
            <div id="printableTask3">
                <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem;">Aufgabe 3: Rechenaufgaben</h2>
                <div id="printableMathTasks">
                    <!-- Rechenaufgaben -->
                    <!-- Jede Aufgabe mit einer Linie f√ºr die Antwort -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initiale Timerwerte (in Sekunden)
        const taskTimersInitial = [600, 600, 600];
        let taskTimers = [...taskTimersInitial];
        let taskIntervals = [null, null, null];
        let currentTask = null;
        let isRecording = false;
        let recorder;
        let savedAudioURL = "";
        let savedProofURL = "";
        let storedTasks = {};

        document.addEventListener("DOMContentLoaded", () => {
            const storedTheme = localStorage.getItem("theme") || "synthwave";
            setTheme(storedTheme);
            if (checkBrowserCompatibility()) {
                loadTasksFromLocalStorage(); // Lade Aufgaben aus dem Local Storage
            }
        });

        function setTheme(theme) {
            document.documentElement.setAttribute("data-theme", theme);
            localStorage.setItem("theme", theme);
        }

        function checkBrowserCompatibility() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showValidationModal("Ihr Browser unterst√ºtzt keine Audioaufnahmen. Bitte verwenden Sie einen aktuellen Browser.");
                return false;
            }
            return true;
        }

        function loadTasksFromLocalStorage() {
            storedTasks = JSON.parse(localStorage.getItem("tasks"));

            if (storedTasks) {
                // Aufgaben sind bereits gespeichert, laden wir sie
                taskTimers = [storedTasks.task1.timer, storedTasks.task2.timer, storedTasks.task3.timer];
                document.getElementById("progress1").value = storedTasks.task1.progress;
                document.getElementById("timer1").innerText = formatTime(storedTasks.task1.timer);
                document.getElementById("progress2").value = storedTasks.task2.progress;
                document.getElementById("timer2").innerText = formatTime(storedTasks.task2.timer);
                document.getElementById("progress3").value = storedTasks.task3.progress;
                document.getElementById("timer3").innerText = formatTime(storedTasks.task3.timer);

                // Laden der Inhalte f√ºr Aufgabe 1 und 2
                document.getElementById("readText").innerHTML = `<strong>Lesetext:</strong><br>${storedTasks.task1.readText}`;
                document.getElementById("writeText").innerHTML = storedTasks.task2.writeText;

                // Laden der gespeicherten Aufnahmen und Beweise
                if (storedTasks.task1.savedAudioURL) {
                    savedAudioURL = storedTasks.task1.savedAudioURL;
                    document.getElementById("audioPlayer").src = savedAudioURL;
                    document.getElementById("recordingName").innerText = "Aufnahme gespeichert";
                    document.getElementById("savedRecording").classList.remove("hidden");
                }

                if (storedTasks.task2.savedProofURL) {
                    savedProofURL = storedTasks.task2.savedProofURL;
                    document.getElementById("proofName").innerText = storedTasks.task2.proofName;
                    document.getElementById("proofPreview").href = savedProofURL;
                    document.getElementById("proofPreview").classList.remove("hidden");
                    document.getElementById("savedProof").classList.remove("hidden");

                    // F√ºgen Sie das Bild in den druckfreundlichen Bereich ein, falls vorhanden
                    const printableProof = document.getElementById("printableProof");
                    printableProof.innerHTML = ''; // Leeren vor dem Hinzuf√ºgen
                    const img = document.createElement("img");
                    img.src = savedProofURL;
                    img.style.maxWidth = "100%";
                    img.style.height = "auto";
                    printableProof.appendChild(img);
                }

                // Laden der Mathematikaufgaben
                loadMathTasks();
            } else {
                // Aufgaben sind nicht gespeichert, initialisieren wir sie
                initializeTasks();
            }
        }

        function initializeTasks() {
            // Initialisierung der Inhalte f√ºr Aufgabe 1 (Lesen) und Aufgabe 2 (Schreiben)
            const initialReadText = `**Das Geheimnis des Verborgenen Tals**

Einst gab es ein verborgenes Tal, umgeben von hohen Bergen und dichten W√§ldern. In diesem Tal lebten Wesen, von denen niemand je geh√∂rt hatte. Sie h√ºteten einen Schatz, der nicht aus Gold oder Edelsteinen bestand, sondern aus reiner Weisheit. Es hie√ü, wer den Weg in das Tal finde und die Pr√ºfungen bestehe, erlange Wissen, das keine B√ºcher lehren konnten.

Eines Tages beschlossen die Geschwister Anna und Ben, das Tal zu suchen. Bewaffnet mit Mut und Neugier machten sie sich auf den Weg. Sie durchquerten st√ºrmische Fl√ºsse, kletterten √ºber steile Felsen und k√§mpften sich durch dichte Vegetation. Nach vielen Tagen erreichten sie schlie√ülich einen Nebel, der das Tal verbarg.

Am Eingang erschienen ihnen drei W√§chter. "Nur die Reinen im Herzen d√ºrfen eintreten", sagten sie. Anna und Ben blickten sich an und antworteten: "Wir suchen nicht nach Reicht√ºmern, sondern nach Verst√§ndnis." Die W√§chter l√§chelten und lie√üen sie passieren.

Im Tal lernten sie von den Wesen die Sprache der Natur, die Melodie des Windes und die Geschichten der Sterne. Sie erkannten, dass wahre Weisheit nicht im Besitz liegt, sondern im Erleben und Teilen. Mit neu gewonnenen Erkenntnissen kehrten sie zur√ºck, bereit, die Welt mit ihrem Wissen zu bereichern.`;

            const initialWriteText = `Schreibe folgenden Text sorgf√§ltig ab:

"Der wahre Wert eines Menschen zeigt sich nicht in dem, was er besitzt, sondern in dem, was er anderen gibt. Freundlichkeit und Gro√üz√ºgigkeit sind die Edelsteine des Herzens."`;

            // Speichern der initialen Aufgaben in localStorage
            storedTasks = {
                task1: {
                    progress: 100,
                    timer: taskTimersInitial[0],
                    readText: initialReadText,
                    savedAudioURL: ""
                },
                task2: {
                    progress: 100,
                    timer: taskTimersInitial[1],
                    writeText: initialWriteText,
                    savedProofURL: "",
                    proofName: ""
                },
                task3: {
                    progress: 100,
                    timer: taskTimersInitial[2],
                    mathTasks: []
                }
            };
            localStorage.setItem("tasks", JSON.stringify(storedTasks));

            // Anzeigen der initialen Inhalte
            document.getElementById("readText").innerHTML = `<strong>Lesetext:</strong><br>${initialReadText}`;
            document.getElementById("writeText").innerHTML = initialWriteText;
            loadMathTasks();
        }

        function toggleTask(taskIndex) {
            if (currentTask === taskIndex) {
                if (taskIndex === 1) {
                    // Stoppen der Aufnahme
                    stopTaskConfirmed(taskIndex);
                } else {
                    stopTask(taskIndex);
                }
            } else {
                if (currentTask !== null) {
                    stopTask(currentTask);
                }
                startTask(taskIndex);
            }
        }

        function stopTaskConfirmed(taskIndex) {
            document.getElementById("confirmStopRecordingModal").checked = false; // Schlie√üt das Modal
            stopTask(taskIndex); // Stoppt die Aufgabe
        }

        function startTask(taskIndex) {
            currentTask = taskIndex;
            const toggleButton = document.getElementById(`toggleTimer${taskIndex}`);
            toggleButton.textContent = "Pause";
            toggleButton.classList.remove("btn-primary");
            toggleButton.classList.add("btn-error");

            if (taskIndex === 1) {
                toggleButton.innerHTML = '<span class="mr-2">üî¥</span> Pause';
                startRecording();
            }

            if (taskIndex === 3) {
                toggleMathInputs(true);
            }

            taskIntervals[taskIndex - 1] = setInterval(() => updateTaskTimer(taskIndex), 1000);
        }

        function stopTask(taskIndex) {
            clearInterval(taskIntervals[taskIndex - 1]);
            taskIntervals[taskIndex - 1] = null;
            currentTask = null;
            const toggleButton = document.getElementById(`toggleTimer${taskIndex}`);
            const timerValue = taskTimers[taskIndex - 1];

            if (timerValue === 0) {
                toggleButton.textContent = "Per WhatsApp versenden";
                toggleButton.classList.remove("btn-error");
                toggleButton.classList.add("btn-success");
                document.getElementById("submitBtn").classList.remove("hidden");
            } else {
                toggleButton.textContent = "Aufgabe beginnen";
                toggleButton.classList.remove("btn-error");
                toggleButton.classList.add("btn-primary");
            }

            if (taskIndex === 1) {
                stopRecording();
            }

            if (taskIndex === 3) {
                toggleMathInputs(false);
            }

            // Speichern des aktuellen Aufgabenstands
            saveTasksToLocalStorage();
        }

        function startRecording() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showValidationModal("Audioaufnahme nicht m√∂glich. Ihr Ger√§t oder Browser unterst√ºtzt diese Funktion nicht.");
                return;
            }

            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    const options = {
                        mimeType: 'audio/webm', // 'audio/wav' kann auf einigen Ger√§ten Probleme machen
                        numberOfAudioChannels: 1,
                        sampleRate: 44100 // CD quality
                    };
                    recorder = RecordRTC(stream, options);
                    recorder.startRecording();
                    isRecording = true;
                    console.log("Recording started using RecordRTC");
                })
                .catch(error => {
                    console.error("Fehler beim Starten der Aufnahme:", error);
                    showValidationModal("Audioaufnahme nicht m√∂glich. Bitte Mikrofonzugriff erlauben.");
                });
        }

        function stopRecording() {
            if (recorder && isRecording) {
                recorder.stopRecording(() => {
                    const blob = recorder.getBlob();
                    savedAudioURL = URL.createObjectURL(blob);
                    const audioPlayer = document.getElementById("audioPlayer");
                    audioPlayer.src = savedAudioURL;
                    document.getElementById("recordingName").innerText = "Aufnahme gespeichert";
                    document.getElementById("savedRecording").classList.remove("hidden");
                    isRecording = false;
                    console.log("Recording stopped.");
                    // Speichern der Aufnahme im localStorage
                    saveTasksToLocalStorage();
                });
            }
        }

        function toggleMathInputs(enable) {
            const inputs = document.querySelectorAll("#mathText input");
            inputs.forEach(input => input.disabled = !enable);
        }

        function updateTaskTimer(taskIndex) {
            let timeLeft = taskTimers[taskIndex - 1];
            const timerElement = document.getElementById(`timer${taskIndex}`);
            const progressElement = document.getElementById(`progress${taskIndex}`);

            if (timeLeft > 0) {
                taskTimers[taskIndex - 1]--;
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerElement.innerText = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                const progressValue = (taskTimers[taskIndex - 1] / taskTimersInitial[taskIndex - 1]) * 100;
                progressElement.value = progressValue;
                saveTasksToLocalStorage();
            } else {
                stopTask(taskIndex);
                taskTimers[taskIndex - 1] = taskTimersInitial[taskIndex - 1];
                timerElement.innerText = "10:00";
                progressElement.value = 100;
                showValidationModal(`Zeit f√ºr Aufgabe ${taskIndex} abgelaufen`);
            }
        }

        function showValidationModal(message) {
            document.getElementById("validationMessage").innerText = message;
            document.getElementById("validationModal").checked = true;
        }

        function uploadProof() {
            const fileInput = document.getElementById("proofUpload");
            const file = fileInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById("proofName").innerText = file.name;
                    const proofPreview = document.getElementById("proofPreview");
                    proofPreview.href = e.target.result; // Setze die URL f√ºr die Vorschau
                    proofPreview.classList.remove("hidden"); // Mache den Link sichtbar
                    document.getElementById("savedProof").classList.remove("hidden");
                    savedProofURL = e.target.result;

                    // F√ºgen Sie das Bild in den druckfreundlichen Bereich ein
                    const printableProof = document.getElementById("printableProof");
                    printableProof.innerHTML = ''; // Leeren vor dem Hinzuf√ºgen
                    const img = document.createElement("img");
                    img.src = savedProofURL;
                    img.style.maxWidth = "100%";
                    img.style.height = "auto";
                    printableProof.appendChild(img);

                    // Speichern des Beweises im localStorage
                    saveTasksToLocalStorage();
                };
                reader.readAsDataURL(file);
            }
            fileInput.value = "";
        }

        function confirmDeleteProof() {
            document.getElementById("confirmDeleteProofModal").checked = true;
        }

        function deleteProof() {
            document.getElementById("savedProof").classList.add("hidden");
            document.getElementById("proofName").innerText = "";
            document.getElementById("proofPreview").classList.add("hidden"); // Verstecke den Vorschau-Link
            savedProofURL = "";
            document.getElementById("printableProof").innerHTML = ''; // Entfernt das Bild im Druckbereich
            // Aktualisieren im localStorage
            saveTasksToLocalStorage();
        }

        function confirmDeleteRecording() {
            document.getElementById("confirmDeleteRecordingModal").checked = true;
        }

        function deleteRecording() {
            document.getElementById("savedRecording").classList.add("hidden");
            document.getElementById("audioPlayer").src = "";
            savedAudioURL = "";
            document.getElementById("confirmDeleteRecordingModal").checked = false; // Modal schlie√üen
            // Aktualisieren im localStorage
            saveTasksToLocalStorage();
        }

        function checkSubmission() {
            let message = "";
            if (!savedAudioURL && !savedProofURL && !hasAnyMathInput()) {
                message = "Bitte f√ºllen Sie mindestens eine Aufgabe aus: eine Aufnahme in Aufgabe 1, ein Bild in Aufgabe 2 oder eine Berechnung in Aufgabe 3.";
            } else {
                message = "Alle Anforderungen erf√ºllt oder mindestens eine Aufgabe abgeschlossen. Abgabe erfolgreich!";
                // Nach erfolgreicher Abgabe speichern wir den aktuellen Stand
                saveTasksToLocalStorage();
                // Bereinigen der gespeicherten Aufgaben, um bei n√§chstem Laden ein neues Set zu generieren
                localStorage.removeItem("tasks");
            }
            showValidationModal(message);
        }

        function hasAnyMathInput() {
            const mathInputs = document.querySelectorAll("#mathText input");
            return Array.from(mathInputs).some(input => input.value.trim() !== "");
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
        }

        function confirmResetTasks() {
            document.getElementById("confirmResetModal").checked = true;
        }

        function resetTasks() {
            taskTimers = [...taskTimersInitial];
            taskIntervals.forEach(interval => clearInterval(interval));
            taskIntervals = [null, null, null];
            currentTask = null;
            document.querySelectorAll('[id^=toggleTimer]').forEach(btn => {
                btn.textContent = 'Aufgabe beginnen';
                btn.classList.remove("btn-error", "btn-success");
                btn.classList.add("btn-primary");
            });
            updateTimerDisplays();
            deleteRecording();
            deleteProof();
            // Entfernen der gespeicherten Aufgaben aus dem localStorage
            localStorage.removeItem("tasks");
            // Initialisieren neuer Aufgaben
            initializeTasks();
            document.getElementById("confirmResetModal").checked = false; // Schlie√üen des Modals
        }

        function updateTimerDisplays() {
            for (let i = 1; i <= 3; i++) {
                document.getElementById(`timer${i}`).innerText = formatTime(taskTimersInitial[i - 1]);
                document.getElementById(`progress${i}`).value = 100;
            }
        }

        function loadMathTasks() {
            const mathContainer = document.getElementById("mathText");
            mathContainer.innerHTML = '';

            let mathTasks = storedTasks.task3.mathTasks;
            if (mathTasks.length === 32) {
                // Bereits vorhandene Aufgaben verwenden
            } else {
                // Neue Mathematikaufgaben generieren
                mathTasks = [];
                const operators = ["+", "-", "*"];
                for (let i = 0; i < 32; i++) {
                    const num1 = Math.floor(Math.random() * 20) + 1;
                    const num2 = Math.floor(Math.random() * 20) + 1;
                    const operator1 = operators[Math.floor(Math.random() * operators.length)];
                    let taskText = `${num1} ${operator1} ${num2}`;
                    let answer;
                    try {
                        answer = eval(taskText);
                    } catch (error) {
                        answer = "?";
                    }
                    mathTasks.push({ num1, num2, operator: operator1, answer, userAnswer: "" });
                }
                storedTasks.task3.mathTasks = mathTasks;
            }

            // Mathematikaufgaben anzeigen
            mathTasks.forEach((task, index) => {
                const taskDiv = document.createElement("div");
                taskDiv.classList.add("flex", "items-center", "justify-center", "mb-2");

                const taskNumber = document.createElement("span");
                taskNumber.classList.add("mr-2");
                taskNumber.innerText = `${index + 1}.`;

                const taskTextElement = document.createElement("span");
                taskTextElement.classList.add("mr-2");
                taskTextElement.innerText = `${task.num1} ${task.operator} ${task.num2} =`;

                const input = document.createElement("input");
                input.type = "text";
                input.classList.add("input", "input-bordered", "ml-2", "w-16");
                input.dataset.index = index;
                input.value = task.userAnswer || "";
                input.addEventListener('input', function() {
                    this.value = this.value.replace(/[^0-9\-]/g, ''); // Erlaubt Zahlen und Minuszeichen
                    storedTasks.task3.mathTasks[this.dataset.index].userAnswer = this.value;
                    saveTasksToLocalStorage();
                });
                input.disabled = true; // Initial disabled

                taskDiv.appendChild(taskNumber);
                taskDiv.appendChild(taskTextElement);
                taskDiv.appendChild(input);

                mathContainer.appendChild(taskDiv);
            });
        }

        function sendResultsViaWhatsApp() {
            let message = "";
            // Aufgabe 1
            message += "Aufgabe 1: Lesen\n";
            message += "Lesetext:\n" + storedTasks.task1.readText + "\n";
            message += "Aufnahme: " + (savedAudioURL ? "Vorhanden" : "Keine Aufnahme") + "\n\n";

            // Aufgabe 2
            message += "Aufgabe 2: Abschreiben\n";
            message += "Abschreibtext:\n" + storedTasks.task2.writeText + "\n";
            message += "Foto der Abschrift: " + (savedProofURL ? "Vorhanden" : "Kein Foto hochgeladen") + "\n\n";

            // Aufgabe 3
            message += "Aufgabe 3: Rechenaufgaben\n";
            storedTasks.task3.mathTasks.forEach((task, index) => {
                let userAnswer = task.userAnswer || "";
                message += `${index + 1}. ${task.num1} ${task.operator} ${task.num2} = ${userAnswer} (L√∂sung: ${task.answer})\n`;
            });

            // Encode message for URL
            const encodedMessage = encodeURIComponent(message);

            // Open WhatsApp
            const whatsappURL = `https://wa.me/?text=${encodedMessage}`;
            window.open(whatsappURL, '_blank');
        }

        function saveTasksToLocalStorage() {
            storedTasks.task1.progress = document.getElementById("progress1").value;
            storedTasks.task1.timer = taskTimers[0];
            storedTasks.task1.savedAudioURL = savedAudioURL;

            storedTasks.task2.progress = document.getElementById("progress2").value;
            storedTasks.task2.timer = taskTimers[1];
            storedTasks.task2.savedProofURL = savedProofURL;
            storedTasks.task2.proofName = document.getElementById("proofName").innerText;

            storedTasks.task3.progress = document.getElementById("progress3").value;
            storedTasks.task3.timer = taskTimers[2];
            // Math-Aufgaben werden bereits aktualisiert

            localStorage.setItem("tasks", JSON.stringify(storedTasks));
        }
    </script>
</body>
</html>
