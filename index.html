<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>kurzlernen.de - 30-Minuten-Herausforderung</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- DaisyUI und Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- RecordRTC.js -->
    <script src="https://cdn.jsdelivr.net/npm/recordrtc@5.6.2/RecordRTC.js"></script>

    <!-- Setze das Farbschema basierend auf den Systemeinstellungen -->
    <script>
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.setAttribute('data-theme', 'dark');
        } else {
            document.documentElement.setAttribute('data-theme', 'light');
        }
    </script>
</head>
<body class="bg-base-200 text-base-content">
    <!-- Header mit DaisyUI Navbar -->
    <header class="navbar bg-primary text-primary-content">
        <div class="flex-1">
            <a class="btn btn-ghost normal-case text-xl">10-Minuten-Herausforderung</a>
        </div>
        <div class="flex-none">
            <!-- Neues Set an Aufgaben Knopf -->
            <button class="btn btn-accent mr-4" onclick="confirmResetTasks()">🔄 Neue Aufgaben</button>
            <!-- Farbschema Toggle -->
            <label class="swap swap-rotate">
                <input type="checkbox" id="theme-toggle" />
                <svg class="swap-on fill-current w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M5.64 17.36A9 9 0 1118.36 6.64 9 9 0 015.64 17.36zM12 7a5 5 0 100 10 5 5 0 000-10z"/>
                </svg>
                <svg class="swap-off fill-current w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M21 12.79A9 9 0 1111.21 3a7 7 0 109.79 9.79z"/>
                </svg>
            </label>
        </div>
    </header>

    <div class="mx-auto p-4 max-w-screen-md">
        <!-- Fortschrittsanzeige -->
        <div class="mt-6 text-center">
            <progress id="overallProgress" class="progress progress-info w-full" value="0" max="3"></progress>
            <p id="progressText" class="mt-2">0 von 3 Aufgaben abgeschlossen</p>
        </div>

        <!-- Aufgaben-Bereich -->
        <div id="tasks" class="mt-6">
            <!-- Aufgabe 1: Lesen -->
            <div id="task1" class="task card shadow-lg bg-base-100 mb-8">
                <div class="collapse collapse-open">
                    <input type="checkbox" class="peer" />
                    <div class="collapse-title bg-base-200 text-base-content peer-checked:bg-base-300 peer-checked:text-base-content">
                        📖 Aufgabe 1: Lesen
                    </div>
                    <div class="collapse-content">
                        <div class="card-body">
                            <div class="flex items-center justify-center mt-2">
                                <progress id="progress1" class="progress progress-primary w-full max-w-xs" value="100" max="100"></progress>
                                <span id="timer1" class="ml-4 text-lg font-mono">10:00</span>
                            </div>
                            <button id="toggleTimer1" class="btn btn-primary mt-4 w-full" onclick="toggleTask(1)">🎙️ Aufgabe beginnen</button>
                            <p class="py-4 text-center">Lesen Sie den folgenden Text laut vor, während die Aufnahme läuft:</p>
                            <div class="collapse">
                                <input type="checkbox" class="peer" />
                                <div class="collapse-title bg-base-200 text-base-content peer-checked:bg-base-300 peer-checked:text-base-content">
                                    Lesetext anzeigen
                                </div>
                                <div class="collapse-content bg-base-200 text-base-content peer-checked:bg-base-300 peer-checked:text-base-content">
                                    <p id="readText" class="py-4 text-justify">
                                        <!-- Platzhalter, wird durch JavaScript ersetzt -->
                                    </p>
                                </div>
                            </div>
                            <div id="savedRecording" class="mt-4 hidden">
                                <audio id="audioPlayer" controls class="w-full"></audio>
                                <div class="flex items-center mt-2">
                                    <span id="recordingName" class="ml-2">Aufnahme gespeichert</span>
                                    <button class="btn btn-error btn-sm ml-auto" onclick="confirmDeleteRecording()">🗑️ Löschen</button>
                                </div>
                            </div>
                            <button id="completeTask1" class="btn btn-success mt-4 w-full hidden" onclick="completeTask(1)">✔️ Aufgabe abschließen</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Aufgabe 2: Schreiben -->
            <div id="task2" class="task card shadow-lg bg-base-100 mb-8">
                <div class="collapse collapse-open">
                    <input type="checkbox" class="peer" />
                    <div class="collapse-title bg-base-200 text-base-content peer-checked:bg-base-300 peer-checked:text-base-content">
                        ✍️ Aufgabe 2: Abschreiben
                    </div>
                    <div class="collapse-content">
                        <div class="card-body">
                            <div class="flex items-center justify-center mt-2">
                                <progress id="progress2" class="progress progress-secondary w-full max-w-xs" value="100" max="100"></progress>
                                <span id="timer2" class="ml-4 text-lg font-mono">10:00</span>
                            </div>
                            <button id="toggleTimer2" class="btn btn-primary mt-4 w-full" onclick="toggleTask(2)">📝 Aufgabe beginnen</button>
                            <p class="mt-4 text-center">Lesen Sie den folgenden Text und schreiben Sie ihn sorgfältig ab:</p>
                            <div class="collapse">
                                <input type="checkbox" class="peer" />
                                <div class="collapse-title bg-base-200 text-base-content peer-checked:bg-base-300 peer-checked:text-base-content">
                                    Abschreibtext anzeigen
                                </div>
                                <div class="collapse-content bg-base-200 text-base-content peer-checked:bg-base-300 peer-checked:text-base-content">
                                    <p id="writeText" class="py-4 text-justify">
                                        <!-- Platzhalter, wird durch JavaScript ersetzt -->
                                    </p>  
                                </div>
                            </div>

                            <label for="proofUpload" class="btn btn-secondary mt-4 w-full">📷 Foto der Abschrift hochladen</label>
                            <input id="proofUpload" type="file" accept="image/*" class="hidden" onchange="uploadProof()" />

                            <div id="savedProof" class="mt-4 hidden">
                                <div class="flex items-center">
                                    <span id="proofName" class="ml-2">Foto hochgeladen</span>
                                    <a id="proofPreview" href="#" class="btn btn-info btn-sm ml-auto" target="_blank">👁️ Vorschau</a>
                                    <button class="btn btn-error btn-sm ml-2" onclick="confirmDeleteProof()">🗑️ Löschen</button>
                                </div>
                            </div>
                            <button id="completeTask2" class="btn btn-success mt-4 w-full hidden" onclick="completeTask(2)">✔️ Aufgabe abschließen</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Aufgabe 3: Mathe -->
            <div id="task3" class="task card shadow-lg bg-base-100 mb-8">
                <div class="collapse collapse-open">
                    <input type="checkbox" class="peer" />
                    <div class="collapse-title bg-base-200 text-base-content peer-checked:bg-base-300 peer-checked:text-base-content">
                        ➗ Aufgabe 3: Rechenaufgaben
                    </div>
                    <div class="collapse-content">
                        <div class="card-body">
                            <div class="flex items-center justify-center mt-2">
                                <progress id="progress3" class="progress progress-accent w-full max-w-xs" value="100" max="100"></progress>
                                <span id="timer3" class="ml-4 text-lg font-mono">10:00</span>
                            </div>
                            <button id="toggleTimer3" class="btn btn-primary mt-4 w-full" onclick="toggleTask(3)">🧮 Aufgabe beginnen</button>
                            <div class="mt-4">
                                <p class="text-center">Lösen Sie die folgenden Rechenaufgaben:</p>
                                <div id="mathText" class="overflow-x-auto mt-4">
                                    <!-- Rechenaufgaben werden hier eingefügt -->
                                </div>
                            </div>
                            <button id="completeTask3" class="btn btn-success mt-4 w-full hidden" onclick="completeTask(3)">✔️ Aufgabe abschließen</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Abgabe-Button -->
        <button id="submitBtn" class="btn btn-success mt-4 w-full hidden text-xl">📤 Aufgaben abgeben</button>
    </div>

    <!-- Modale für Validierungen -->
    <!-- Modale bleiben unverändert -->
    <input type="checkbox" id="validationModal" class="modal-toggle" />
    <div class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Abgabe-Validierung</h3>
            <p id="validationMessage" class="py-4"></p>
            <div class="modal-action">
                <label for="validationModal" class="btn">Schließen</label>
            </div>
        </div>
    </div>

    <!-- Bestätigungsmodal für das Stoppen der Aufnahme -->
    <input type="checkbox" id="confirmStopRecordingModal" class="modal-toggle" />
    <div class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Aufnahme beenden?</h3>
            <p class="py-4">Möchten Sie die Aufnahme wirklich beenden? Falls dies ein Versehen war, können Sie den Vorgang fortsetzen.</p>
            <div class="modal-action">
                <label class="btn btn-error" onclick="stopTaskConfirmed(1)">Ja, beenden</label>
                <label for="confirmStopRecordingModal" class="btn">Abbrechen</label>
            </div>
        </div>
    </div>

    <!-- Bestätigungsmodal für das Löschen der Aufnahme -->
    <input type="checkbox" id="confirmDeleteRecordingModal" class="modal-toggle" />
    <div class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Aufnahme löschen?</h3>
            <p class="py-4">Möchten Sie die Aufnahme wirklich löschen?</p>
            <div class="modal-action">
                <label class="btn btn-error" onclick="deleteRecording()">Ja, löschen</label>
                <label for="confirmDeleteRecordingModal" class="btn">Abbrechen</label>
            </div>
        </div>
    </div>

    <!-- Bestätigungsmodal für das Löschen des Beweises -->
    <input type="checkbox" id="confirmDeleteProofModal" class="modal-toggle" />
    <div class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Beweis löschen?</h3>
            <p class="py-4">Möchten Sie das hochgeladene Foto wirklich löschen?</p>
            <div class="modal-action">
                <label class="btn btn-error" onclick="deleteProof()">Ja, löschen</label>
                <label for="confirmDeleteProofModal" class="btn">Abbrechen</label>
            </div>
        </div>
    </div>

    <!-- Bestätigungsmodal für das Zurücksetzen -->
    <input type="checkbox" id="confirmResetModal" class="modal-toggle" />
    <div class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Aufgaben zurücksetzen?</h3>
            <p class="py-4">Möchten Sie wirklich das aktuelle Set an Aufgaben zurücksetzen? Alle bisherigen Fortschritte gehen verloren.</p>
            <div class="modal-action">
                <label class="btn btn-error" onclick="resetTasks()">Ja, zurücksetzen</label>
                <label for="confirmResetModal" class="btn">Abbrechen</label>
            </div>
        </div>
    </div>

    <!-- Skriptbereich -->
    <script>
        // Initiale Timerwerte (in Sekunden)
        const taskTimersInitial = [600, 600, 600];
        let taskTimers = [...taskTimersInitial];
        let taskIntervals = [null, null, null];
        let currentTask = null;
        let isRecording = false;
        let recorder;
        let savedAudioURL = "";
        let savedProofURL = "";
        let storedTasks = {};
        let audioStream; // Variable to hold the media stream
        let tasksCompleted = [false, false, false];

        // Globale Variable für Stimmen
        let voices = [];

        document.addEventListener("DOMContentLoaded", () => {
            if (checkBrowserCompatibility()) {
                loadTasksFromLocalStorage(); // Lade Aufgaben aus dem Local Storage
            }

            // Theme Toggle
            const themeToggle = document.getElementById('theme-toggle');
            // Prüfe das bevorzugte Farbschema des Benutzers
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.setAttribute('data-theme', 'dark');
                themeToggle.checked = true;
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
                themeToggle.checked = false;
            }

            themeToggle.addEventListener('change', function() {
                if (this.checked) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                } else {
                    document.documentElement.setAttribute('data-theme', 'light');
                }
            });

            // Stimmen laden
            populateVoiceList();
            if (typeof speechSynthesis !== 'undefined' && speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = populateVoiceList;
            }
        });

        function populateVoiceList() {
            voices = speechSynthesis.getVoices();
        }

        function checkBrowserCompatibility() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showValidationModal("Ihr Browser unterstützt keine Audioaufnahmen. Bitte verwenden Sie einen aktuellen Browser.");
                return false;
            }
            if (!('speechSynthesis' in window)) {
                showValidationModal("Ihr Browser unterstützt keine Text-zu-Sprache-Funktion. Bitte verwenden Sie einen aktuellen Browser.");
                return false;
            }
            return true;
        }

        function loadTasksFromLocalStorage() {
            storedTasks = JSON.parse(localStorage.getItem("tasks"));

            if (storedTasks) {
                // Aufgaben sind bereits gespeichert, laden wir sie
                taskTimers = [storedTasks.task1.timer, storedTasks.task2.timer, storedTasks.task3.timer];
                document.getElementById("progress1").value = storedTasks.task1.progress;
                document.getElementById("timer1").innerText = formatTime(storedTasks.task1.timer);
                document.getElementById("progress2").value = storedTasks.task2.progress;
                document.getElementById("timer2").innerText = formatTime(storedTasks.task2.timer);
                document.getElementById("progress3").value = storedTasks.task3.progress;
                document.getElementById("timer3").innerText = formatTime(storedTasks.task3.timer);

                // Laden der Inhalte für Aufgabe 1 und 2
                document.getElementById("readText").innerHTML = storedTasks.task1.readText;
                document.getElementById("writeText").innerHTML = storedTasks.task2.writeText;

                // Laden der gespeicherten Aufnahmen und Beweise
                if (storedTasks.task1.savedAudioURL) {
                    savedAudioURL = storedTasks.task1.savedAudioURL;
                    document.getElementById("audioPlayer").src = savedAudioURL;
                    document.getElementById("recordingName").innerText = "Aufnahme gespeichert";
                    document.getElementById("savedRecording").classList.remove("hidden");
                    document.getElementById("completeTask1").classList.remove("hidden");
                }

                if (storedTasks.task2.savedProofURL) {
                    savedProofURL = storedTasks.task2.savedProofURL;
                    document.getElementById("proofName").innerText = storedTasks.task2.proofName;
                    document.getElementById("proofPreview").href = savedProofURL;
                    document.getElementById("proofPreview").classList.remove("hidden");
                    document.getElementById("savedProof").classList.remove("hidden");
                    document.getElementById("completeTask2").classList.remove("hidden");
                }

                // Laden der Mathematikaufgaben
                loadMathTasks();

                // Überprüfen, ob Aufgaben abgeschlossen wurden
                tasksCompleted = storedTasks.tasksCompleted || [false, false, false];
                updateOverallProgress();

                // Einklappen abgeschlossener Aufgaben
                for (let i = 1; i <= 3; i++) {
                    if (tasksCompleted[i - 1]) {
                        collapseTask(i);
                    }
                }
            } else {
                // Aufgaben sind nicht gespeichert, initialisieren wir sie
                initializeTasks();
            }
        }

        function initializeTasks() {
            // Initialisierung der Inhalte für Aufgabe 1 (Lesen) und Aufgabe 2 (Schreiben)
            const initialReadText = `
            <strong>Lesetext:</strong><br>
            <em>Das geheime Tagebuch</em><br><br>
            Als ich an diesem verregneten Nachmittag auf den Dachboden stieg, erwartete ich nicht, mein Leben für immer zu verändern. Zwischen staubigen alten Kisten und vergessenen Erinnerungsstücken entdeckte ich ein ledergebundenes Buch. Es war alt, sehr alt, und der Einband trug keinen Titel. Neugierig öffnete ich es und begann zu lesen.<br><br>
            Die Seiten waren mit handgeschriebenen Notizen gefüllt, die von Abenteuern, verborgenen Schätzen und mysteriösen Begegnungen erzählten. Je mehr ich las, desto mehr fühlte ich mich mit dem unbekannten Autor verbunden. War dies das Tagebuch eines meiner Vorfahren? Oder vielleicht das eines völlig Fremden? Eines war sicher: Dies war kein gewöhnliches Tagebuch.<br><br>
            Plötzlich spürte ich eine leichte Brise, obwohl kein Fenster geöffnet war. Ein leises Flüstern erfüllte den Raum: "Folge den Zeichen..." Mein Herz schlug schneller. Sollte ich dem Rätsel folgen, das sich vor mir entfaltete? Mit klopfendem Herzen beschloss ich, mich auf das Abenteuer einzulassen.
            `;

            const initialWriteText = `
            <strong>Abschreibtext:</strong><br>
            "Ich konnte kaum glauben, was ich entdeckt hatte. Die Geheimnisse, die in diesem Tagebuch verborgen lagen, schienen älter zu sein als unsere Familie selbst. Jeder Satz, jede Zeichnung führte mich tiefer in ein Mysterium, das darauf wartete, gelüftet zu werden. Mutig entschied ich mich, dem Pfad zu folgen, auch wenn ich nicht wusste, wohin er mich führen würde."
            `;

            // Speichern der initialen Aufgaben in localStorage
            storedTasks = {
                task1: {
                    progress: 100,
                    timer: taskTimersInitial[0],
                    readText: initialReadText,
                    savedAudioURL: ""
                },
                task2: {
                    progress: 100,
                    timer: taskTimersInitial[1],
                    writeText: initialWriteText,
                    savedProofURL: "",
                    proofName: ""
                },
                task3: {
                    progress: 100,
                    timer: taskTimersInitial[2],
                    mathTasks: []
                },
                tasksCompleted: [false, false, false]
            };
            localStorage.setItem("tasks", JSON.stringify(storedTasks));

            // Anzeigen der initialen Inhalte
            document.getElementById("readText").innerHTML = initialReadText;
            document.getElementById("writeText").innerHTML = initialWriteText;
            loadMathTasks();
        }

        function toggleTask(taskIndex) {
            if (currentTask === taskIndex) {
                if (taskIndex === 1) {
                    // Stoppen der Aufnahme
                    document.getElementById("confirmStopRecordingModal").checked = true; // Öffnet das Modal
                } else {
                    stopTask(taskIndex);
                }
            } else {
                if (currentTask !== null) {
                    stopTask(currentTask);
                }
                startTask(taskIndex);
            }
        }

        function stopTaskConfirmed(taskIndex) {
            document.getElementById("confirmStopRecordingModal").checked = false; // Schließt das Modal
            stopTask(taskIndex); // Stoppt die Aufgabe
        }

        function startTask(taskIndex) {
            currentTask = taskIndex;
            const toggleButton = document.getElementById(`toggleTimer${taskIndex}`);
            toggleButton.textContent = "Pause";
            toggleButton.classList.remove("btn-primary");
            toggleButton.classList.add("btn-error");

            if (taskIndex === 1) {
                toggleButton.innerHTML = '<span class="mr-2">⏸️</span> Aufnahme pausieren';
                startRecording();
            }

            if (taskIndex === 3) {
                toggleMathInputs(true);
            }

            taskIntervals[taskIndex - 1] = setInterval(() => updateTaskTimer(taskIndex), 1000);
        }

        function stopTask(taskIndex) {
            clearInterval(taskIntervals[taskIndex - 1]);
            taskIntervals[taskIndex - 1] = null;
            currentTask = null;
            const toggleButton = document.getElementById(`toggleTimer${taskIndex}`);
            const timerValue = taskTimers[taskIndex - 1];

            if (timerValue === 0) {
                toggleButton.textContent = "Aufgabe abgeschlossen";
                toggleButton.classList.remove("btn-error");
                toggleButton.classList.add("btn-success");
                document.getElementById(`completeTask${taskIndex}`).classList.remove("hidden");
            } else {
                toggleButton.innerHTML = taskIndex === 1 ? '🎙️ Aufgabe beginnen' : taskIndex === 2 ? '📝 Aufgabe beginnen' : '🧮 Aufgabe beginnen';
                toggleButton.classList.remove("btn-error");
                toggleButton.classList.add("btn-primary");
            }

            if (taskIndex === 1) {
                stopRecording();
            }

            if (taskIndex === 3) {
                toggleMathInputs(false);
            }

            // Speichern des aktuellen Aufgabenstands
            saveTasksToLocalStorage();
        }

        function startRecording() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showValidationModal("Audioaufnahme nicht möglich. Ihr Gerät oder Browser unterstützt diese Funktion nicht.");
                return;
            }

            navigator.mediaDevices.getUserMedia({ 
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    sampleRate: 44100,
                    channelCount: 1 // Mono-Audio
                }
            })
                .then(stream => {
                    audioStream = stream; // Save the stream to stop it later
                    const options = {
                        type: 'audio',
                        mimeType: 'audio/webm;codecs=opus',
                        recorderType: StereoAudioRecorder,
                        numberOfAudioChannels: 1,
                        desiredSampRate: 16000 // Optional
                    };
                    recorder = new RecordRTC(stream, options);
                    recorder.startRecording();
                    isRecording = true;
                    console.log("Recording started using RecordRTC");
                })
                .catch(error => {
                    console.error("Fehler beim Starten der Aufnahme:", error);
                    showValidationModal("Audioaufnahme nicht möglich. Bitte Mikrofonzugriff erlauben.");
                });
        }

        function stopRecording() {
            if (recorder && isRecording) {
                recorder.stopRecording(() => {
                    const blob = recorder.getBlob();
                    savedAudioURL = URL.createObjectURL(blob);
                    const audioPlayer = document.getElementById("audioPlayer");
                    audioPlayer.src = savedAudioURL;
                    document.getElementById("recordingName").innerText = "Aufnahme gespeichert";
                    document.getElementById("savedRecording").classList.remove("hidden");
                    document.getElementById("completeTask1").classList.remove("hidden");
                    isRecording = false;
                    console.log("Recording stopped.");
                    // Release the media stream
                    if (audioStream) {
                        audioStream.getTracks().forEach(track => track.stop());
                        audioStream = null;
                    }
                    // Speichern der Aufnahme im localStorage
                    saveTasksToLocalStorage();
                });
            }
        }

        function toggleMathInputs(enable) {
            const inputs = document.querySelectorAll("#mathText input");
            inputs.forEach(input => input.disabled = !enable);
        }

        function updateTaskTimer(taskIndex) {
            let timeLeft = taskTimers[taskIndex - 1];
            const timerElement = document.getElementById(`timer${taskIndex}`);
            const progressElement = document.getElementById(`progress${taskIndex}`);

            if (timeLeft > 0) {
                taskTimers[taskIndex - 1]--;
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerElement.innerText = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                const progressValue = (taskTimers[taskIndex - 1] / taskTimersInitial[taskIndex - 1]) * 100;
                progressElement.value = progressValue;
                saveTasksToLocalStorage();
            } else {
                stopTask(taskIndex);
                taskTimers[taskIndex - 1] = taskTimersInitial[taskIndex - 1];
                timerElement.innerText = "10:00";
                progressElement.value = 100;
                showValidationModal(`Zeit für Aufgabe ${taskIndex} abgelaufen`);
            }
        }

        function showValidationModal(message) {
            document.getElementById("validationMessage").innerText = message;
            document.getElementById("validationModal").checked = true;
        }

        function uploadProof() {
            const fileInput = document.getElementById("proofUpload");
            const file = fileInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById("proofName").innerText = file.name;
                    const proofPreview = document.getElementById("proofPreview");
                    proofPreview.href = e.target.result; // Setze die URL für die Vorschau
                    proofPreview.classList.remove("hidden"); // Mache den Link sichtbar
                    document.getElementById("savedProof").classList.remove("hidden");
                    document.getElementById("completeTask2").classList.remove("hidden");
                    savedProofURL = e.target.result;

                    // Speichern des Beweises im localStorage
                    saveTasksToLocalStorage();

                    // Bewertung der Handschrift und Ausgabe in der Konsole
                    assessHandwriting();
                };
                reader.readAsDataURL(file);
            }
            fileInput.value = "";
        }

        function confirmDeleteProof() {
            document.getElementById("confirmDeleteProofModal").checked = true;
        }

        function deleteProof() {
            document.getElementById("savedProof").classList.add("hidden");
            document.getElementById("proofName").innerText = "";
            document.getElementById("proofPreview").classList.add("hidden"); // Verstecke den Vorschau-Link
            savedProofURL = "";
            document.getElementById("completeTask2").classList.add("hidden");
            // Aktualisieren im localStorage
            saveTasksToLocalStorage();
            document.getElementById("confirmDeleteProofModal").checked = false; // Modal schließen
        }

        function confirmDeleteRecording() {
            document.getElementById("confirmDeleteRecordingModal").checked = true;
        }

        function deleteRecording() {
            document.getElementById("savedRecording").classList.add("hidden");
            document.getElementById("audioPlayer").src = "";
            savedAudioURL = "";
            document.getElementById("completeTask1").classList.add("hidden");
            document.getElementById("confirmDeleteRecordingModal").checked = false; // Modal schließen
            // Aktualisieren im localStorage
            saveTasksToLocalStorage();
        }

        function checkSubmission() {
            if (!tasksCompleted.includes(false)) {
                showValidationModal("Alle Aufgaben erfolgreich abgeschlossen! Danke für Ihre Teilnahme.");
                // Hier können Sie zusätzliche Logik hinzufügen, z.B. Ergebnisse versenden
            } else {
                showValidationModal("Bitte schließen Sie alle Aufgaben ab, bevor Sie sie abgeben.");
            }
        }

        function completeTask(taskIndex) {
            tasksCompleted[taskIndex - 1] = true;
            document.getElementById(`completeTask${taskIndex}`).classList.add("hidden");
            document.getElementById(`toggleTimer${taskIndex}`).classList.add("hidden");
            // Aktualisierung der Gesamtfortschrittsanzeige
            updateOverallProgress();
            // Zeige den Abgabe-Button an, wenn alle Aufgaben abgeschlossen sind
            if (!tasksCompleted.includes(false)) {
                document.getElementById("submitBtn").classList.remove("hidden");
            }
            // Einklappen der abgeschlossenen Aufgabe
            collapseTask(taskIndex);
            saveTasksToLocalStorage();
        }

        function collapseTask(taskIndex) {
            const taskCollapse = document.querySelector(`#task${taskIndex} .collapse`);
            if (taskCollapse) {
                taskCollapse.classList.remove('collapse-open');
                taskCollapse.classList.add('collapse-close');
                // Das entsprechende Checkbox-Element deaktivieren
                const inputCheckbox = taskCollapse.querySelector('input[type="checkbox"]');
                if (inputCheckbox) {
                    inputCheckbox.checked = false;
                }
            }
        }

        function updateOverallProgress() {
            const completedCount = tasksCompleted.filter(Boolean).length;
            document.getElementById("overallProgress").value = completedCount;
            document.getElementById("progressText").innerText = `${completedCount} von 3 Aufgaben abgeschlossen`;
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
        }

        function confirmResetTasks() {
            document.getElementById("confirmResetModal").checked = true;
        }

        function resetTasks() {
            taskTimers = [...taskTimersInitial];
            taskIntervals.forEach(interval => clearInterval(interval));
            taskIntervals = [null, null, null];
            currentTask = null;
            tasksCompleted = [false, false, false];
            document.querySelectorAll('[id^=toggleTimer]').forEach((btn, index) => {
                btn.innerHTML = index === 0 ? '🎙️ Aufgabe beginnen' : index === 1 ? '📝 Aufgabe beginnen' : '🧮 Aufgabe beginnen';
                btn.classList.remove("btn-error", "btn-success", "hidden");
                btn.classList.add("btn-primary");
            });
            document.querySelectorAll('[id^=completeTask]').forEach(btn => {
                btn.classList.add("hidden");
            });

            // Entfernen der Code, die die Collapses öffnet oder schließt
            // Ursprünglich:
            /*
            // Einklappen aller Aufgaben
            document.querySelectorAll('.collapse').forEach(collapse => {
                collapse.classList.add('collapse-open');
                collapse.classList.remove('collapse-close');
                const inputCheckbox = collapse.querySelector('input[type="checkbox"]');
                if (inputCheckbox) {
                    inputCheckbox.checked = true;
                }
            });
            */
            // Diese Zeilen wurden entfernt, um die Collapses nicht zu beeinflussen

            updateTimerDisplays();
            deleteRecording();
            deleteProof();
            document.getElementById("submitBtn").classList.add("hidden");
            // Entfernen der gespeicherten Aufgaben aus dem localStorage
            localStorage.removeItem("tasks");
            // Initialisieren neuer Aufgaben
            initializeTasks();
            updateOverallProgress();
            document.getElementById("confirmResetModal").checked = false; // Schließen des Modals
        }

        function updateTimerDisplays() {
            for (let i = 1; i <= 3; i++) {
                document.getElementById(`timer${i}`).innerText = formatTime(taskTimersInitial[i - 1]);
                document.getElementById(`progress${i}`).value = 100;
            }
        }

        function loadMathTasks() {
            const mathContainer = document.getElementById("mathText");
            mathContainer.innerHTML = '';

            let mathTasks = storedTasks.task3.mathTasks;
            if (mathTasks.length === 20) {
                // Bereits vorhandene Aufgaben verwenden
            } else {
                // Neue Mathematikaufgaben generieren
                mathTasks = [];
                const operators = ["+", "-", "*", "/"];
                for (let i = 0; i < 20; i++) {
                    const num1 = Math.floor(Math.random() * 50) + 1;
                    const num2 = Math.floor(Math.random() * 50) + 1;
                    const operator = operators[Math.floor(Math.random() * operators.length)];
                    let taskText = `${num1} ${operator} ${num2}`;
                    let answer;
                    try {
                        if (operator === '/' && num2 === 0) {
                            answer = "?";
                        } else {
                            answer = eval(taskText).toFixed(2);
                        }
                    } catch (error) {
                        answer = "?";
                    }
                    mathTasks.push({ num1, num2, operator, answer, userAnswer: "" });
                }
                storedTasks.task3.mathTasks = mathTasks;
                saveTasksToLocalStorage();
            }

            // Mathematikaufgaben anzeigen
            const table = document.createElement("table");
            table.classList.add("table", "w-full");

            const tbody = document.createElement("tbody");

            mathTasks.forEach((task, index) => {
                const tr = document.createElement("tr");

                const tdIndex = document.createElement("td");
                tdIndex.textContent = index + 1;
                tdIndex.classList.add("font-bold");

                const tdTask = document.createElement("td");
                tdTask.textContent = `${task.num1} ${task.operator} ${task.num2} =`;

                const tdInput = document.createElement("td");
                const input = document.createElement("input");
                input.type = "text";
                input.classList.add("input", "input-bordered", "w-full", "max-w-xs");
                input.dataset.index = index;
                input.value = task.userAnswer || "";
                input.addEventListener('input', function() {
                    this.value = this.value.replace(/[^0-9\.\-]/g, ''); // Erlaubt Zahlen, Punkt und Minuszeichen
                    storedTasks.task3.mathTasks[this.dataset.index].userAnswer = this.value;
                    saveTasksToLocalStorage();

                    // Überprüfe, ob alle Felder ausgefüllt sind
                    if (checkAllMathInputsFilled()) {
                        document.getElementById("completeTask3").classList.remove("hidden");
                    } else {
                        document.getElementById("completeTask3").classList.add("hidden");
                    }
                });
                input.disabled = true; // Initial disabled
                tdInput.appendChild(input);

                tr.appendChild(tdIndex);
                tr.appendChild(tdTask);
                tr.appendChild(tdInput);

                tbody.appendChild(tr);
            });

            table.appendChild(tbody);
            mathContainer.appendChild(table);

            // Überprüfe beim Laden, ob alle Felder bereits ausgefüllt sind
            if (checkAllMathInputsFilled()) {
                document.getElementById("completeTask3").classList.remove("hidden");
            } else {
                document.getElementById("completeTask3").classList.add("hidden");
            }
        }

        // Funktion zur Überprüfung, ob alle Mathe-Eingabefelder ausgefüllt sind
        function checkAllMathInputsFilled() {
            const inputs = document.querySelectorAll("#mathText input");
            for (let input of inputs) {
                if (input.value.trim() === "") {
                    return false;
                }
            }
            return true;
        }

        function saveTasksToLocalStorage() {
            storedTasks.task1.progress = document.getElementById("progress1").value;
            storedTasks.task1.timer = taskTimers[0];
            storedTasks.task1.savedAudioURL = savedAudioURL;

            storedTasks.task2.progress = document.getElementById("progress2").value;
            storedTasks.task2.timer = taskTimers[1];
            storedTasks.task2.savedProofURL = savedProofURL;
            storedTasks.task2.proofName = document.getElementById("proofName").innerText;

            storedTasks.task3.progress = document.getElementById("progress3").value;
            storedTasks.task3.timer = taskTimers[2];
            // Math-Aufgaben werden bereits aktualisiert

            storedTasks.tasksCompleted = tasksCompleted;

            localStorage.setItem("tasks", JSON.stringify(storedTasks));
        }

        // Neue Funktion zur Bewertung der Handschrift
        function assessHandwriting() {
            // Simuliere eine Bewertung der Handschrift
            const percentage = Math.floor(Math.random() * 51) + 50; // Zufälliger Wert zwischen 50% und 100%
            console.log(`Handwriting quality: ${percentage}%`);
        }

    </script>
</body>
</html>
