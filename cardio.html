<!DOCTYPE html>
<html lang="de" data-theme="dracula">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Z2 Log â€“ Cardio Log (Gamified)</title>
    <!-- Tailwind + DaisyUI via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2gN1f2zI+w140+9A2s251n5+1i+9C8c/8f5e71A7p4/C65F87c4A4f11g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Firebase -->
    <script type="module">
        // Firebase CDN imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Global variables and constants ---
        const DB_COLLECTION = 'sessions';
        const USERS_COLLECTION = 'users';
        const REWARDS_COLLECTION = 'rewards';
        
        const nowISO = () => new Date().toISOString();
        const uid = () => Math.random().toString(36).slice(2, 10);

        // --- Firebase initialization (using provided globals) ---
        // These global variables are provided by the canvas environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Application state and Firebase services
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let localState = {
            activeUserId: 'default',
            users: {},
            sessions: [],
            rewards: []
        };
        let sessionBeingEdited = null;

        // --- UI elements
        const themeSelect = document.getElementById('themeSelect');
        const userSelect = document.getElementById('userSelect');
        const btnSaveSettings = document.getElementById('btnSaveSettings');
        const btnNewUser = document.getElementById('btnNewUser');
        const btnCreateUser = document.getElementById('btnCreateUser');
        const newUserNameInput = document.getElementById('newUserName');
        const btnQuickSession = document.getElementById('btnQuickSession');
        const tbody = document.getElementById('tbodySessions');
        const btnExport = document.getElementById('btnExport');
        const btnImport = document.getElementById('btnImport');
        const fileImport = document.getElementById('fileImport');
        const quickLevelRange = document.getElementById('quickLevel');
        const wattValueSpan = document.getElementById('wattValue');
        const btnSaveSession = document.getElementById('btnSaveSession');
        const bodyWeightInput = document.getElementById('bodyWeight');
        const weeklyTargetInput = document.getElementById('weeklyTarget');
        const userIdDisplay = document.getElementById('userIdDisplay');

        // --- Persistence Functions ---
        /**
         * Loads user data from Firestore.
         * @returns {Promise<object>} The user's data from Firestore.
         */
        async function loadUserData() {
            if (!userId) {
                console.error("User ID not available.");
                return null;
            }
            const userDocRef = doc(db, `/artifacts/${appId}/users/${userId}/private`, 'user-data');
            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    return docSnap.data();
                } else {
                    console.log("No user data found, creating default.");
                    return {
                        settings: { weeklyTarget: 140, theme: 'dracula', bodyWeight: 100, quickLevel: 1, quickDuration: 20, quickHr: 115 },
                        metrics: { level: 1, xp: 0, streakCount: 0, totalEntries: 0, lastDay: null },
                        rewards: []
                    };
                }
            } catch (e) {
                console.error("Error loading user data:", e);
                return null;
            }
        }
        
        /**
         * Saves user settings to Firestore.
         */
        async function saveUserSetting() {
            if (!userId) return;
            const userDocRef = doc(db, `/artifacts/${appId}/users/${userId}/private`, 'user-data');
            try {
                await setDoc(userDocRef, {
                    settings: localState.users[userId].settings,
                    metrics: localState.users[userId].metrics,
                    rewards: localState.users[userId].rewards
                }, { merge: true });
                console.log("User settings saved to Firestore.");
            } catch (e) {
                console.error("Error saving settings:", e);
            }
        }

        /**
         * Adds or updates a session in Firestore.
         * @param {object} sessionData The data for the session.
         */
        async function saveSessionToFirestore(sessionData) {
            if (!userId) return;
            const sessionRef = doc(db, `/artifacts/${appId}/users/${userId}/private/${DB_COLLECTION}`, sessionData.id);
            try {
                await setDoc(sessionRef, sessionData, { merge: true });
                console.log("Session saved to Firestore:", sessionData.id);
            } catch (e) {
                console.error("Error saving session:", e);
            }
        }
        
        /**
         * Deletes a session from Firestore.
         * @param {string} sessionId The ID of the session to delete.
         */
        async function deleteSessionFromFirestore(sessionId) {
            if (!userId) return;
            const sessionRef = doc(db, `/artifacts/${appId}/users/${userId}/private/${DB_COLLECTION}`, sessionId);
            try {
                await deleteDoc(sessionRef);
                console.log("Session deleted from Firestore:", sessionId);
            } catch (e) {
                console.error("Error deleting session:", e);
            }
        }
        
        // --- UI Helper Functions ---
        function showConfirmDialog(title, text) {
            return new Promise(resolve => {
                const dlg = document.getElementById('dlgConfirm');
                document.getElementById('confirmTitle').textContent = title;
                document.getElementById('confirmText').textContent = text;
                const confirmCancel = document.getElementById('confirmCancel');
                const confirmOk = document.getElementById('confirmOk');

                const newConfirmOk = confirmOk.cloneNode(true);
                confirmOk.parentNode.replaceChild(newConfirmOk, confirmOk);
                const newConfirmCancel = confirmCancel.cloneNode(true);
                confirmCancel.parentNode.replaceChild(newConfirmCancel, confirmCancel);
                
                const handleConfirm = () => {
                    dlg.close();
                    resolve(true);
                };

                const handleCancel = () => {
                    dlg.close();
                    resolve(false);
                };

                newConfirmOk.addEventListener('click', handleConfirm);
                newConfirmCancel.addEventListener('click', handleCancel);
                dlg.showModal();
            });
        }

        function showSuccessDialog(title, text, iconClass) {
            const dlg = document.getElementById('dlgSuccess');
            document.getElementById('successTitle').textContent = title;
            document.getElementById('successText').textContent = text;
            const icon = document.getElementById('successIcon');
            icon.className = `text-6xl text-primary mb-6 animate-pulse ${iconClass}`;
            for(let i = 0; i < 50; i++) setTimeout(() => createConfetti('confetti-container-success'), i * 20);
            dlg.showModal();
        }

        function createConfetti(containerId) {
            const container = document.getElementById(containerId);
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = `${Math.random() * 100}vw`;
            confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
            confetti.style.animationDuration = `${Math.random() * 2 + 3}s`;
            confetti.style.transform = `translateY(-100vh) rotate(${Math.random() * 360}deg)`;
            container.appendChild(confetti);
            confetti.addEventListener('animationend', () => confetti.remove());
        }

        // --- Gamification & Logic ---
        const REWARDS = [
            { id: 'first_session', title: 'Erster Eintrag', desc: 'Absolviere deine erste Trainingseinheit.', icon: 'fas fa-medal', condition: (metrics) => metrics.totalEntries >= 1 },
            { id: 'weekly_target_hit', title: 'Wochenziel', desc: 'Erreiche dein Wochenziel von 75 Minuten.', icon: 'fas fa-trophy', condition: (metrics) => metrics.weekMinutes >= (localState.users[userId].settings.weeklyTarget || 75) },
            { id: '10_sessions', title: 'Zehn Sessions', desc: 'Absolviere 10 Trainingseinheiten.', icon: 'fas fa-fire-extinguisher', condition: (metrics) => metrics.totalEntries >= 10 },
            { id: 'first_streak', title: 'Erster Streak', desc: 'Trainiere an zwei aufeinanderfolgenden Tagen.', icon: 'fas fa-bolt', condition: (metrics) => metrics.streakCount >= 2 },
            { id: 'level_5', title: 'Level 5', desc: 'Erreiche Level 5.', icon: 'fas fa-star', condition: (metrics) => metrics.level >= 5 },
            { id: '10_streak', title: 'Zehn-Tage-Streak', desc: 'Trainiere an 10 aufeinanderfolgenden Tagen.', icon: 'fas fa-crown', condition: (metrics) => metrics.streakCount >= 10 },
            { id: '100_entries', title: 'Hundert Sessions', desc: 'Absolviere 100 Trainingseinheiten.', icon: 'fas fa-dumbbell', condition: (metrics) => metrics.totalEntries >= 100 },
            { id: 'max_level', title: 'Max Level!', desc: 'Erreiche Level 10.', icon: 'fas fa-gem', condition: (metrics) => metrics.level >= 10 },
        ];
        
        const WATT_BASE = 50;
        const WATT_STEP = 25;

        function getWattValue(level) {
            return WATT_BASE + (level - 1) * WATT_STEP;
        }

        function calculateCalories(session, bodyWeight) {
            if (!session.duration || !bodyWeight) return 0;
            let met;
            if (session.watt) {
                if (session.watt < 50) met = 3.5;
                else if (session.watt < 100) met = 5.8;
                else if (session.watt < 160) met = 7.0;
                else met = 8.5;
            } else if (session.hr) {
                if (session.hr < 100) met = 3.0;
                else if (session.hr < 130) met = 5.0;
                else if (session.hr < 150) met = 7.0;
                else if (session.hr < 170) met = 8.5;
                else met = 10.0;
            } else {
                met = 5.0;
            }
            return (met * 3.5 * bodyWeight / 200) * session.duration;
        }

        function calculateXp(session) {
            let xp = session.duration;
            if (session.watt) xp += session.watt * 0.5;
            if (session.hr > 140) xp += 10;
            if (session.distance) xp += session.distance * 2;
            return Math.floor(xp);
        }

        /**
         * Centralized function to recalculate metrics and UI.
         */
        function handleDataChange() {
            if (!userId) return;
            
            const user = localState.users[userId];
            const sessions = localState.sessions;
            
            // Recalculate sessions and enrich with calories
            sessions.forEach(session => {
                session.calories = calculateCalories(session, user.settings.bodyWeight);
            });

            // Recalculate metrics
            const metrics = { level: 1, xp: 0, streakCount: 0, totalEntries: 0, lastDay: null, weekMinutes: 0 };
            const sortedSessions = [...sessions].sort((a, b) => new Date(a.date) - new Date(b.date));
            const now = new Date();
            
            sortedSessions.forEach(session => {
                metrics.totalEntries++;
                metrics.xp += calculateXp(session);

                // Streak calculation
                const sessionDate = new Date(session.date).toDateString();
                const yesterday = new Date(new Date(metrics.lastDay).setDate(new Date(metrics.lastDay).getDate() + 1)).toDateString();
                if (metrics.lastDay === null) {
                    metrics.streakCount = 1;
                } else if (sessionDate === metrics.lastDay) {
                    // Same day, no change
                } else if (sessionDate === yesterday) {
                    metrics.streakCount++;
                } else {
                    metrics.streakCount = 1;
                }
                metrics.lastDay = sessionDate;

                // Weekly minutes
                if (isSameWeek(new Date(session.date), now)) {
                    metrics.weekMinutes += session.duration;
                }
            });

            metrics.level = 1 + Math.floor(metrics.xp / 100);
            metrics.xp = metrics.xp % 100;
            
            user.metrics = metrics;
            
            // Re-evaluate rewards
            const oldRewards = new Set(user.rewards);
            const newRewards = [];
            REWARDS.forEach(reward => {
                if (reward.condition(user.metrics)) {
                    newRewards.push(reward.id);
                    if (!oldRewards.has(reward.id)) {
                        showSuccessDialog(reward.title, reward.desc, reward.icon);
                    }
                }
            });
            user.rewards = newRewards;
            
            // Render UI
            localState.sessions.sort((a, b) => new Date(b.date) - new Date(a.date));
            renderAll();
            saveUserSetting(); // Save metrics/rewards
        }

        // --- Data Operations (now async with Firestore) ---
        async function addSession(sessionData) {
            if (!userId) {
                console.error("User not authenticated.");
                return;
            }
            const sessionId = doc(collection(db, `/artifacts/${appId}/users/${userId}/private/${DB_COLLECTION}`)).id;
            const session = { id: sessionId, ...sessionData, userId: userId, createdAt: nowISO() };
            await saveSessionToFirestore(session);
        }

        async function updateSession(sessionId, newData) {
            if (!userId) return;
            const sessionRef = doc(db, `/artifacts/${appId}/users/${userId}/private/${DB_COLLECTION}`, sessionId);
            try {
                await setDoc(sessionRef, newData, { merge: true });
            } catch(e) {
                console.error("Error updating session:", e);
            }
        }

        async function deleteSession(sessionId) {
            const isConfirmed = await showConfirmDialog('Eintrag lÃ¶schen?', 'MÃ¶chtest du diesen Eintrag wirklich lÃ¶schen?');
            if (isConfirmed) {
                await deleteSessionFromFirestore(sessionId);
            }
        }

        function openSessionModal(session = null) {
            const dlg = document.getElementById('dlgNewSession');
            const title = document.getElementById('sessionModalTitle');
            const btnSave = document.getElementById('btnSaveSession');
            
            sessionBeingEdited = session ? session.id : null;

            if (session) {
                title.textContent = 'Session bearbeiten';
                document.getElementById('sessionDate').value = session.date.substring(0, 10);
                document.getElementById('sessionDuration').value = session.duration;
                document.getElementById('sessionHr').value = session.hr;
                document.getElementById('sessionWatt').value = session.watt;
                document.getElementById('sessionDistance').value = session.distance;
                document.getElementById('sessionNote').value = session.note;
                btnSave.textContent = 'Ã„nderungen speichern';
            } else {
                title.textContent = 'Training eintragen (Manuell)';
                document.getElementById('sessionDate').valueAsDate = new Date();
                document.getElementById('sessionDuration').value = '';
                document.getElementById('sessionHr').value = '';
                document.getElementById('sessionWatt').value = '';
                document.getElementById('sessionDistance').value = '';
                document.getElementById('sessionNote').value = '';
                btnSave.textContent = 'Eintrag speichern';
            }
            dlg.showModal();
        }

        function saveSessionFromModal() {
            const data = {
                date: document.getElementById('sessionDate').value,
                duration: parseInt(document.getElementById('sessionDuration').value) || 0,
                hr: parseInt(document.getElementById('sessionHr').value) || null,
                watt: parseInt(document.getElementById('sessionWatt').value) || null,
                distance: parseFloat(document.getElementById('sessionDistance').value) || null,
                note: document.getElementById('sessionNote').value.trim() || null
            };

            if (sessionBeingEdited) {
                updateSession(sessionBeingEdited, data);
            } else {
                addSession(data);
            }
            document.getElementById('dlgNewSession').close();
        }
        
        // --- UI Rendering ---
        function renderUsers() {
            const userSelect = document.getElementById('userSelect');
            userSelect.innerHTML = `
                <option value="${userId}" selected>Christian</option>
            `;
            userIdDisplay.textContent = `User ID: ${userId}`;
        }

        function renderSettings() {
            if (!localState.users[userId] || !localState.users[userId].settings) return;
            const user = localState.users[userId];
            document.getElementById('bodyWeight').value = user.settings.bodyWeight;
            document.getElementById('weeklyTarget').value = user.settings.weeklyTarget;
            document.getElementById('themeSelect').value = user.settings.theme;
            document.getElementById('quickLevel').value = user.settings.quickLevel;
            document.getElementById('quickDuration').value = user.settings.quickDuration;
            document.getElementById('quickHr').value = user.settings.quickHr;
            document.documentElement.setAttribute('data-theme', user.settings.theme);
            wattValueSpan.textContent = `${getWattValue(user.settings.quickLevel)} W`;
        }

        function calculateAndRenderKPIs() {
            if (!localState.users[userId] || !localState.users[userId].metrics) return;
            const user = localState.users[userId];
            const metrics = user.metrics;
            document.getElementById('kpiWeekMin').textContent = metrics.weekMinutes;
            document.getElementById('kpiStreak').textContent = metrics.streakCount;
            document.getElementById('kpiLevel').textContent = metrics.level;
            document.getElementById('kpiXp').textContent = metrics.xp;
            document.getElementById('kpiEntries').textContent = metrics.totalEntries;
        }

        function renderSessions() {
            const tbody = document.getElementById('tbodySessions');
            tbody.innerHTML = localState.sessions.map(session => {
                const date = new Date(session.date);
                const isDeletable = session.userId === userId; // Deletable if created by the current user
                return `
                    <tr>
                        <td class="text-xs md:text-sm">${date.toLocaleDateString()}</td>
                        <td class="text-xs md:text-sm">${session.duration}</td>
                        <td class="text-xs md:text-sm">${session.hr || '-'}</td>
                        <td class="hide-xs text-xs md:text-sm">${session.watt || '-'}</td>
                        <td class="hide-xs text-xs md:text-sm">${(session.distance ? session.distance.toFixed(1) : '-')}</td>
                        <td class="text-xs md:text-sm">${(session.calories ? Math.floor(session.calories) : '-')}</td>
                        <td class="text-xs md:text-sm row-note">${session.note || '-'}</td>
                        <td class="flex gap-1">
                            <button class="btn btn-xs btn-circle btn-info btn-outline btn-edit" data-id="${session.id}">
                                <i class="fa-solid fa-pen-to-square"></i>
                            </button>
                            ${isDeletable ? `
                            <button class="btn btn-xs btn-circle btn-error btn-outline btn-delete" data-id="${session.id}">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>` : `<button class="btn btn-xs btn-circle btn-ghost" disabled>
                                <i class="fa-solid fa-trash-can text-gray-400"></i>
                            </button>`}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderRewards() {
            if (!localState.users[userId] || !localState.users[userId].rewards) return;
            const rewardsGrid = document.getElementById('rewardsGrid');
            rewardsGrid.innerHTML = REWARDS.map(reward => {
                const unlocked = localState.users[userId].rewards.includes(reward.id);
                return `
                    <div class="card bg-base-100 shadow-md ${unlocked ? 'opacity-100' : 'opacity-40'}" title="${reward.title}">
                        <div class="card-body p-3 text-center items-center">
                            <i class="${reward.icon} text-3xl mb-2"></i>
                            <p class="text-sm font-semibold">${reward.title}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // --- Helper Functions (Date) and Data Import/Export/Share ---
        function isSameWeek(date1, date2) {
            const d1 = new Date(date1);
            const d2 = new Date(date2);
            d1.setHours(0, 0, 0, 0);
            d2.setHours(0, 0, 0, 0);
            const onejan = new Date(d1.getFullYear(), 0, 1);
            const week1 = Math.ceil((((d1 - onejan) / 86400000) + onejan.getUTCDay() + 1) / 7);
            const week2 = Math.ceil((((d2 - onejan) / 86400000) + onejan.getUTCDay() + 1) / 7);
            return week1 === week2 && d1.getFullYear() === d2.getFullYear();
        }

        async function exportData() {
            if (!userId) {
                alert("Please authenticate first.");
                return;
            }
            const dataToExport = {
                userSettings: localState.users[userId].settings,
                sessions: localState.sessions,
            };
            const json = JSON.stringify(dataToExport, null, 2);
            const backupFilename = `z2log-backup-${new Date().toISOString().slice(0, 10)}.json`;
            const file = new File([json], backupFilename, { type: 'application/json' });

            if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                try {
                    await navigator.share({
                        title: 'Z2 Log Daten-Backup',
                        text: 'Hier ist dein Backup der Z2 Log App.',
                        files: [file],
                    });
                    console.log('Data shared successfully.');
                } catch (error) {
                    console.error('Sharing failed:', error);
                    downloadFile(json, backupFilename);
                }
            } else {
                downloadFile(json, backupFilename);
            }
        }

        function downloadFile(content, filename) {
            const blob = new Blob([content], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function importData(file) {
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (await showConfirmDialog('Daten importieren?', 'MÃ¶chtest du diese Daten wirklich importieren?')) {
                        // Assuming the imported file has sessions and user settings
                        localState.users[userId].settings = importedData.userSettings;
                        
                        // Clear existing sessions and import new ones
                        const existingSessionRefs = await getDocs(collection(db, `/artifacts/${appId}/users/${userId}/private/${DB_COLLECTION}`));
                        const deletePromises = existingSessionRefs.docs.map(doc => deleteDoc(doc.ref));
                        await Promise.all(deletePromises);
                        
                        // Add imported sessions to Firestore
                        const addPromises = importedData.sessions.map(s => {
                            const newSessionRef = doc(collection(db, `/artifacts/${appId}/users/${userId}/private/${DB_COLLECTION}`));
                            return setDoc(newSessionRef, { ...s, id: newSessionRef.id, userId: userId });
                        });
                        await Promise.all(addPromises);
                        
                        // UI will auto-update via onSnapshot
                    }
                } catch (err) {
                    const dlg = document.getElementById('dlgConfirm');
                    document.getElementById('confirmTitle').textContent = 'Import fehlgeschlagen';
                    document.getElementById('confirmText').textContent = 'UngÃ¼ltige Datei. Bitte Ã¼berprÃ¼fe das Format.';
                    document.getElementById('confirmOk').style.display = 'none';
                    document.getElementById('confirmCancel').textContent = 'SchlieÃŸen';
                    dlg.showModal();
                    console.error('Import error:', err);
                }
            };
            reader.readAsText(file);
        }

        // --- Event Listeners and Initialization ---
        function setupEventListeners() {
            themeSelect.addEventListener('change', (e) => {
                localState.users[userId].settings.theme = e.target.value;
                document.documentElement.setAttribute('data-theme', e.target.value);
                saveUserSetting();
            });

            btnSaveSettings.addEventListener('click', () => {
                const user = localState.users[userId];
                user.settings.bodyWeight = parseFloat(bodyWeightInput.value);
                user.settings.weeklyTarget = parseInt(weeklyTargetInput.value);
                user.settings.quickLevel = parseInt(quickLevelRange.value);
                user.settings.quickDuration = parseInt(document.getElementById('quickDuration').value);
                user.settings.quickHr = parseInt(document.getElementById('quickHr').value);
                saveUserSetting();
            });

            quickLevelRange.addEventListener('input', (e) => {
                wattValueSpan.textContent = `${getWattValue(parseInt(e.target.value))} W`;
            });
            
            btnQuickSession.addEventListener('click', () => {
                const user = localState.users[userId];
                const session = {
                    date: nowISO().substring(0, 10),
                    watt: getWattValue(parseInt(user.settings.quickLevel)),
                    hr: parseInt(user.settings.quickHr),
                    duration: parseInt(user.settings.quickDuration),
                    distance: null,
                    calories: null,
                    note: 'Schnelleingabe'
                };
                addSession(session);
            });

            tbody.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                const sessionId = target.dataset.id;
                
                if (target.classList.contains('btn-delete')) {
                    deleteSession(sessionId);
                } else if (target.classList.contains('btn-edit')) {
                    const session = localState.sessions.find(s => s.id === sessionId);
                    if (session) {
                        openSessionModal(session);
                    }
                }
            });

            btnSaveSession.addEventListener('click', saveSessionFromModal);

            btnExport.addEventListener('click', exportData);
            btnImport.addEventListener('click', () => fileImport.click());
            fileImport.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    importData(e.target.files[0]);
                }
            });
        }
        
        function renderAll() {
            renderUsers();
            renderSettings();
            renderSessions();
            calculateAndRenderKPIs();
            renderRewards();
        }

        // --- Application Initialization ---
        window.addEventListener('load', async () => {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    console.log("Authenticated as user:", userId);

                    // Load user data and set up real-time listeners
                    const userData = await loadUserData();
                    if (userData) {
                        localState.users[userId] = userData;
                        renderSettings(); // Render settings immediately
                    }
                    
                    // Listen for real-time updates to sessions
                    const sessionsQuery = query(collection(db, `/artifacts/${appId}/users/${userId}/private/${DB_COLLECTION}`));
                    onSnapshot(sessionsQuery, (snapshot) => {
                        localState.sessions = snapshot.docs.map(d => d.data());
                        handleDataChange(); // Update UI when sessions change
                    }, (error) => {
                        console.error("Error listening to sessions:", error);
                    });

                } else {
                    console.log("Signing in anonymously...");
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (e) {
                        console.error("Firebase Auth failed:", e);
                    }
                }
            });

            setupEventListeners();
        });
    </script>
    
    <style>
        /* Basic styles */
        body { overflow-x: hidden; }
        .container { max-width: 980px; }
        .tap-big button, .tap-big .btn { min-height: 3rem; }
        .thumb { width: 48px; height: 48px; object-fit: cover; border-radius: .375rem; }
        .row-note { max-width: 220px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* Animations */
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .pop-animation { animation: pop 0.3s ease-in-out; }
        @keyframes highlight-fade { 0% { background-color: oklch(var(--a)); } 50% { background-color: oklch(var(--a) / 0.5); } 100% { background-color: transparent; } }
        .new-entry-highlight { animation: highlight-fade 2s ease-out forwards; }
        #confetti-container-success { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: hidden; z-index: 100; }
        .confetti { position: absolute; width: 10px; height: 10px; background-color: var(--fallback-p); animation-name: confetti-fall; animation-timing-function: linear; animation-fill-mode: forwards; }
        @keyframes confetti-fall { 0% { transform: translate(0, -100vh) rotate(0deg); opacity: 1; } 100% { transform: translate(0, 100vh) rotate(720deg); opacity: 0; } }
        
        /* Mobile view and table improvements */
        @media (max-width: 420px){
            .hide-xs { display: none; }
            table th, table td { white-space: normal; }
            .stat { margin-bottom: 0.5rem; }
            .stats { flex-wrap: wrap; }
        }
        .sessions-table-container { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .sessions-table-container table { width: 100%; }
    </style>
</head>
<body class="bg-base-100">
    <div class="container mx-auto p-4 md:p-6 max-w-full">
        <!-- Header / Theme / User -->
        <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
            <div>
                <h1 class="text-2xl font-bold">Z2 Log â€“ Cardio</h1>
                <p class="text-sm opacity-70">Cloud-basierte Eingabe mit Gamification. Christian Heinrich Hohlfeld, Konstanz Germany, 05.04.1983</p>
                <p id="userIdDisplay" class="text-xs mt-1 text-gray-500"></p>
            </div>
            <div class="flex items-center gap-2">
                <label class="label text-sm">Theme</label>
                <select id="themeSelect" class="select select-bordered select-sm">
                    <option>winter</option><option>cupcake</option><option>emerald</option>
                    <option>corporate</option><option>dracula</option><option>night</option>
                </select>
            </div>
        </div>

        <!-- User Settings -->
        <div class="flex flex-wrap items-center gap-2 mb-3">
            <label class="label text-sm whitespace-nowrap">Benutzer</label>
            <select id="userSelect" class="select select-bordered select-sm" disabled></select>
            <div class="ml-auto flex flex-wrap items-center gap-2">
                <label class="label text-sm whitespace-nowrap">KÃ¶rpergewicht (kg)</label>
                <input id="bodyWeight" type="number" min="0" class="input input-bordered input-sm w-24" placeholder="z.B. 75" />
                <label class="label text-sm whitespace-nowrap">Wochenziel (Min)</label>
                <input id="weeklyTarget" type="number" min="0" class="input input-bordered input-sm w-24" />
                <button id="btnSaveSettings" class="btn btn-sm">Speichern</button>
            </div>
        </div>
        
        <!-- Quick-entry settings -->
        <div class="mt-6 mb-4 p-4 bg-base-200 rounded-lg">
            <h2 class="text-lg font-semibold mb-2">Schnell-Eingabe-Einstellungen</h2>
            <div class="flex flex-wrap items-center gap-4">
                <label class="form-control w-full sm:w-auto">
                    <div class="label"><span class="label-text">Watt-Stufe</span></div>
                    <div class="flex items-center gap-2">
                        <input id="quickLevel" type="range" min="1" max="8" value="1" step="1" class="range range-xs" />
                        <span id="wattValue" class="text-sm font-bold w-12 text-center">0 W</span>
                    </div>
                </label>
                <label class="form-control w-full sm:w-auto">
                    <div class="label"><span class="label-text">Dauer (Min)</span></div>
                    <input id="quickDuration" type="number" min="1" class="input input-bordered input-sm w-full sm:w-20" />
                </label>
                <label class="form-control w-full sm:w-auto">
                    <div class="label"><span class="label-text">Puls (bpm)</span></div>
                    <input id="quickHr" type="number" min="0" class="input input-bordered input-sm w-full sm:w-20" />
                </label>
            </div>
        </div>

        <!-- KPIs -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
            <div class="stat shadow">
                <div class="stat-title">Wochenminuten</div><div id="kpiWeekMin" class="stat-value">0</div>
            </div>
            <div class="stat shadow">
                <div class="stat-title">Streak</div><div id="kpiStreak" class="stat-value transition-all duration-300">0</div>
                <div class="stat-desc">Tage am StÃ¼ck</div>
            </div>
            <div class="stat shadow">
                <div class="stat-title">Level</div><div class="stat-value">Lv <span id="kpiLevel" class="transition-all duration-300">1</span></div>
                <div class="stat-desc"><span id="kpiXp" class="transition-all duration-300">0</span> / 100 XP</div>
            </div>
            <div class="stat shadow">
                <div class="stat-title">EintrÃ¤ge</div><div id="kpiEntries" class="stat-value transition-all duration-300">0</div>
            </div>
        </div>

        <!-- Rewards Section -->
        <h2 class="text-lg font-semibold mt-6 mb-2">Deine Belohnungen</h2>
        <div id="rewardsGrid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-4 mb-6">
            <!-- Rewards will be rendered here by JS -->
        </div>

        <!-- CTA: Open quick-entry -->
        <div class="tap-big mb-4">
            <button id="btnQuickSession" class="btn btn-primary w-full text-lg">âœ¨ Training eintragen (schnell)</button>
        </div>

        <!-- Data Tools -->
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 mb-2">
            <h2 class="text-lg font-semibold whitespace-nowrap">Deine Sessions</h2>
            <div class="flex flex-wrap gap-2">
                <button id="btnExport" class="btn btn-sm">Export/Teilen</button>
                <input id="fileImport" class="hidden" type="file" accept="application/json">
                <button id="btnImport" class="btn btn-sm">Importieren</button>
            </div>
        </div>

        <!-- Table -->
        <div class="overflow-x-auto sessions-table-container">
            <table class="table w-full table-zebra">
                <thead>
                    <tr>
                        <th class="text-xs md:text-sm">Datum</th>
                        <th class="text-xs md:text-sm">Min</th>
                        <th class="text-xs md:text-sm">Ã˜ Puls</th>
                        <th class="hide-xs text-xs md:text-sm">Watt</th>
                        <th class="hide-xs text-xs md:text-sm">Distanz (km)</th>
                        <th class="text-xs md:text-sm">Kcal</th>
                        <th class="text-xs md:text-sm">Notizen</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="tbodySessions"></tbody>
            </table>
        </div>

    </div>
    
    <!-- Modals -->
    <dialog id="dlgNewSession" class="modal">
        <div class="modal-box w-11/12 max-w-lg p-6">
            <form method="dialog">
                <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">âœ•</button>
            </form>
            <h3 id="sessionModalTitle" class="font-bold text-lg mb-4">Training eintragen (Manuell)</h3>
            
            <div class="form-control mb-4">
                <label class="label"><span class="label-text">Datum</span></label>
                <input id="sessionDate" type="date" class="input input-bordered w-full" required />
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="form-control">
                    <label class="label"><span class="label-text">Dauer (Minuten)</span></label>
                    <input id="sessionDuration" type="number" min="1" class="input input-bordered w-full" required />
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text">Durchschnittlicher Puls (bpm)</span></label>
                    <input id="sessionHr" type="number" min="0" class="input input-bordered w-full" />
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text">Durchschnittliche Watt</span></label>
                    <input id="sessionWatt" type="number" min="0" class="input input-bordered w-full" />
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text">Distanz (km)</span></label>
                    <input id="sessionDistance" type="number" step="0.1" class="input input-bordered w-full" />
                </div>
            </div>
            
            <div class="form-control mt-4">
                <label class="label"><span class="label-text">Notizen</span></label>
                <textarea id="sessionNote" class="textarea textarea-bordered w-full" placeholder="Notizen..."></textarea>
            </div>

            <div class="modal-action mt-6">
                <button id="btnSaveSession" class="btn btn-primary w-full text-lg">Eintrag speichern</button>
            </div>
        </div>
    </dialog>
    
    <!-- Confirmation dialog -->
    <dialog id="dlgConfirm" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg" id="confirmTitle"></h3>
            <p class="py-4" id="confirmText"></p>
            <div class="modal-action">
                <button class="btn" id="confirmCancel">Abbrechen</button>
                <button class="btn btn-primary" id="confirmOk">BestÃ¤tigen</button>
            </div>
        </div>
    </dialog>

    <!-- Success/Achievement Dialog -->
    <dialog id="dlgSuccess" class="modal">
        <div id="confetti-container-success"></div>
        <div class="modal-box text-center relative z-10">
            <h3 class="text-3xl font-bold mb-4" id="successTitle"></h3>
            <p class="text-xl mb-6" id="successText"></p>
            <i id="successIcon" class="text-6xl text-primary mb-6 animate-pulse"></i>
            <div class="modal-action justify-center mt-6">
                <form method="dialog"><button class="btn btn-primary">Super!</button></form>
            </div>
        </div>
    </dialog>
</body>
</html>
