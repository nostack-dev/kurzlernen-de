<!DOCTYPE html>
<html lang="de" data-theme="winter">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Z2 Log ‚Äì Gamified (CDN-only)</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.3/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
<style>
  :root { --font: Inter, ui-sans-serif, system-ui; }
  body { font-family: var(--font); }
  .mono { font-variant-numeric: tabular-nums; }
  .thumb { width:84px; height:84px; object-fit:cover; border-radius:.75rem; border:1px solid rgba(0,0,0,.08); }
  .wrap { word-break: break-word; white-space: pre-wrap; }
  .chip { @apply badge badge-sm; }
</style>
</head>
<body class="bg-base-200 min-h-screen">

<!-- NAV -->
<div class="navbar bg-base-100 shadow-sm sticky top-0 z-30">
  <div class="flex-1">
    <span class="btn btn-ghost normal-case text-xl font-extrabold">Z2 Log ‚ö°Ô∏è</span>
  </div>
  <div class="flex-none gap-2">
    <label class="label cursor-pointer gap-2">
      <span class="label-text">Theme</span>
      <select id="themeSel" class="select select-bordered select-sm">
        <option>winter</option><option>cupcake</option><option>emerald</option>
        <option>corporate</option><option>dracula</option><option>night</option>
      </select>
    </label>
    <div class="dropdown dropdown-end">
      <div tabindex="0" role="button" class="btn btn-ghost btn-circle avatar placeholder">
        <div class="bg-neutral text-neutral-content rounded-full w-10"><span>‚öôÔ∏è</span></div>
      </div>
      <ul tabindex="0" class="menu menu-sm dropdown-content mt-3 z-[1] p-2 shadow bg-base-100 rounded-box w-64">
        <li class="menu-title">Einstellungen</li>
        <li>
          <div class="px-2 py-1">
            <label class="label"><span class="label-text">Ton (Motivation)</span></label>
            <div class="join w-full">
              <button class="join-item btn btn-sm" data-tone="gentle">gentle</button>
              <button class="join-item btn btn-sm btn-active" data-tone="cheeky">cheeky</button>
              <button class="join-item btn btn-sm" data-tone="spicy">spicy</button>
            </div>
            <label class="label mt-2"><span class="label-text">Wochenziel (Minuten)</span></label>
            <input id="weeklyTarget" type="number" class="input input-sm input-bordered w-full" value="140" />
          </div>
        </li>
        <li><button id="btnSaveSettings">Speichern</button></li>
      </ul>
    </div>
  </div>
</div>

<!-- HERO / STATS -->
<div class="container mx-auto px-4 py-6">
  <div class="grid gap-4 md:grid-cols-3">
    <div class="card bg-base-100 shadow">
      <div class="card-body">
        <div class="flex items-center justify-between">
          <h2 class="card-title">Weekly Minutes</h2>
          <div id="wkMin" class="text-2xl font-extrabold mono">0</div>
        </div>
        <progress id="wkProg" class="progress progress-primary w-full" value="0" max="100"></progress>
        <div id="wkMsg" class="text-sm opacity-70 mt-1">Let‚Äôs roll.</div>
      </div>
    </div>
    <div class="card bg-base-100 shadow">
      <div class="card-body">
        <div class="flex items-center justify-between">
          <h2 class="card-title">Streak</h2>
          <div id="streak" class="text-2xl font-extrabold mono">0üî•</div>
        </div>
        <div class="text-sm opacity-70">Konsekutive Tage mit Eintrag</div>
        <div id="nextBadge" class="badge badge-outline mt-2">n√§chster Badge bei 3 üî•</div>
      </div>
    </div>
    <div class="card bg-base-100 shadow">
      <div class="card-body">
        <div class="flex items-center justify-between">
          <h2 class="card-title">XP / Level</h2>
          <div class="text-right">
            <div id="level" class="text-2xl font-extrabold mono">Lv 1</div>
            <div id="xpLbl" class="text-xs opacity-70">0 / 100 XP</div>
          </div>
        </div>
        <progress id="xpProg" class="progress progress-secondary w-full" value="0" max="100"></progress>
        <div id="xpMsg" class="text-sm opacity-70 mt-1">XP sammeln durch Sessions & PBs</div>
      </div>
    </div>
  </div>
</div>

<!-- OCR + FORM -->
<div class="container mx-auto px-4">
  <div class="grid gap-6 md:grid-cols-2">
    <div class="card bg-base-100 shadow">
      <div class="card-body">
        <h2 class="card-title">1) Fotos ‚Üí OCR</h2>
        <p class="text-sm opacity-80">Lade 2‚Äì3 Screens (Puls / Dauer / Speed/Watt) hoch. Wir mergen die Infos automatisch.</p>
        <input id="fileInput" type="file" accept="image/*" multiple capture="environment" class="file-input file-input-bordered w-full max-w-xs" />
        <div class="mt-2" id="thumbs" class="flex gap-2"></div>
        <div id="ocrPanel" class="mt-3">
          <button id="btnOcr" class="btn btn-primary">OCR starten</button>
          <div id="ocrStatus" class="text-sm opacity-70 mt-2"></div>
          <progress id="ocrProg" class="progress w-full hidden"></progress>
          <details class="mt-2">
            <summary class="cursor-pointer text-sm">OCR Rohtext</summary>
            <pre id="rawText" class="wrap text-xs opacity-80 p-2 bg-base-200 rounded"></pre>
          </details>
        </div>
      </div>
    </div>

    <div class="card bg-base-100 shadow">
      <div class="card-body">
        <h2 class="card-title">2) Eintrag pr√ºfen & speichern</h2>
        <div class="grid gap-3 md:grid-cols-2">
          <label class="form-control">
            <span class="label-text">√ò Puls (bpm)</span>
            <input id="f_hr" type="number" inputmode="numeric" placeholder="115" class="input input-bordered" />
          </label>
          <label class="form-control">
            <span class="label-text">Dauer (min)</span>
            <input id="f_dur" type="number" step="0.1" inputmode="decimal" placeholder="20" class="input input-bordered" />
          </label>
          <label class="form-control">
            <span class="label-text">Speed (km/h)</span>
            <input id="f_speed" type="number" step="0.1" inputmode="decimal" class="input input-bordered" />
          </label>
          <label class="form-control">
            <span class="label-text">Watt</span>
            <input id="f_watt" type="number" step="1" inputmode="numeric" class="input input-bordered" />
          </label>
          <label class="form-control md:col-span-2">
            <span class="label-text">Notizen</span>
            <input id="f_notes" type="text" placeholder="Hitze, Koffein, Medikinet‚Ä¶" class="input input-bordered" />
          </label>
        </div>
        <div class="mt-3 flex gap-2">
          <button id="btnSave" class="btn btn-success">Eintrag speichern</button>
          <button id="btnQuick115" class="btn">Quick-Fill: 115 / 20</button>
        </div>
        <div id="saveMsg" class="text-sm opacity-70 mt-2"></div>
      </div>
    </div>
  </div>
</div>

<!-- LOG + BADGES -->
<div class="container mx-auto px-4 my-6">
  <div class="grid gap-6 lg:grid-cols-3">
    <div class="card bg-base-100 shadow lg:col-span-2">
      <div class="card-body">
        <div class="flex items-center justify-between">
          <h2 class="card-title">3) Deine Sessions</h2>
          <div class="flex gap-2">
            <button id="btnExport" class="btn btn-sm">Export (JSON)</button>
            <label class="btn btn-sm">
              Import
              <input id="importFile" type="file" accept="application/json" class="hidden">
            </label>
            <button id="btnClear" class="btn btn-sm btn-error">Alles l√∂schen</button>
          </div>
        </div>
        <div class="overflow-x-auto mt-2">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Datum</th><th>Zeit</th><th>√ò HR</th><th>Min</th><th>Speed</th><th>Watt</th><th>Notiz</th><th></th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="card bg-base-100 shadow">
      <div class="card-body">
        <h2 class="card-title">Achievements</h2>
        <div id="badges" class="flex flex-wrap gap-2"></div>
        <div class="divider my-2"></div>
        <div class="text-sm opacity-70">Badges werden automatisch freigeschaltet (Streaks, HR-Treffer, PBs, Umfang).</div>
      </div>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast toast-end z-40" id="toasts"></div>

<!-- MODAL: Badge unlocked -->
<dialog id="badgeModal" class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg">üéâ Neuer Badge!</h3>
    <p id="badgeModalTxt" class="py-2"></p>
    <div class="modal-action">
      <form method="dialog"><button class="btn">Nice</button></form>
    </div>
  </div>
</dialog>

<script>
/* ====== State & Storage ====== */
const LS = {
  entries: 'z2_fun_entries_v1',
  settings: 'z2_fun_settings_v1',
  meta: 'z2_fun_meta_v1'
};
const defSettings = { tone: 'cheeky', weeklyTarget: 140, theme: 'winter' };

function load(key, fallback) {
  try { return JSON.parse(localStorage.getItem(key)) ?? fallback; } catch(e){ return fallback; }
}
function save(key, val) { localStorage.setItem(key, JSON.stringify(val)); }
function nowTS(){ return Date.now(); }

/* ====== Tone dictionaries (PG-13 spicy) ====== */
const TONES = {
  gentle: {
    wk: [
      "Let‚Äôs roll.", "Ruhig starten ‚Äì best√§ndig bleiben.",
      "Guter Flow ‚Äì Zone-2 liebt Konstanz.", "Stark! Der Trend gef√§llt.",
      "On fire (auf leise Art). Weiter so!"
    ],
    save: [
      "Sch√∂ner Eintrag. Kleine Schritte, gro√üer Effekt.",
      "Konstant ist K√∂nig. Sauber erledigt.",
      "Fein dosiert, fein geliefert.",
      "Sehr gut ‚Äì Mitochondrien sagen Danke."
    ],
    progress: ["Aufw√§rmphase","Du bist dabei","Kommt ins Rollen","Fast da","Goldene Konstanz!"]
  },
  cheeky: {
    wk: [
      "Ok, Anlasser gez√ºndet.", "Motor schnurrt. Mehr davon.",
      "Zone-2 Enjoyer detected.", "Cardio greift ‚Äì nice!",
      "Well well‚Ä¶ look who‚Äôs consistent üòé"
    ],
    save: [
      "Logged. Clean like a whistle.",
      "Another brick in the aerobic wall.",
      "Chef‚Äôs kiss ‚Äì genau so.",
      "Mint. Keep stacking."
    ],
    progress: ["Low-key","Wird warm","Nice groove","Baller-mode light","Consistency beast!"]
  },
  spicy: {
    wk: [
      "Startschuss. Keine Ausreden.", "Okay, du bist auf der Bahn.",
      "Das brennt angenehm ‚Äì weiter.", "Stabiler Grind, Respekt.",
      "Well, well‚Ä¶ you‚Äôve got guts."
    ],
    save: [
      "Logged. No fluff.",
      "Disziplin > Motivation. Good call.",
      "Werk getan. N√§chster.",
      "Solid. Keep the heat on."
    ],
    progress: ["Couch-escape","Wach werden","It‚Äôs cooking","Nearly there","Certified machine"]
  }
};
function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

/* ====== Elements ====== */
const el = {
  themeSel: document.getElementById('themeSel'),
  weeklyTarget: document.getElementById('weeklyTarget'),
  btnSaveSettings: document.getElementById('btnSaveSettings'),
  wkMin: document.getElementById('wkMin'),
  wkProg: document.getElementById('wkProg'),
  wkMsg: document.getElementById('wkMsg'),
  streak: document.getElementById('streak'),
  nextBadge: document.getElementById('nextBadge'),
  level: document.getElementById('level'),
  xpLbl: document.getElementById('xpLbl'),
  xpProg: document.getElementById('xpProg'),
  xpMsg: document.getElementById('xpMsg'),
  fileInput: document.getElementById('fileInput'),
  thumbs: document.getElementById('thumbs'),
  btnOcr: document.getElementById('btnOcr'),
  ocrStatus: document.getElementById('ocrStatus'),
  ocrProg: document.getElementById('ocrProg'),
  rawText: document.getElementById('rawText'),
  f_hr: document.getElementById('f_hr'),
  f_dur: document.getElementById('f_dur'),
  f_speed: document.getElementById('f_speed'),
  f_watt: document.getElementById('f_watt'),
  f_notes: document.getElementById('f_notes'),
  btnSave: document.getElementById('btnSave'),
  btnQuick115: document.getElementById('btnQuick115'),
  rows: document.getElementById('rows'),
  btnExport: document.getElementById('btnExport'),
  importFile: document.getElementById('importFile'),
  btnClear: document.getElementById('btnClear'),
  badges: document.getElementById('badges'),
  toasts: document.getElementById('toasts'),
  badgeModal: document.getElementById('badgeModal'),
  badgeModalTxt: document.getElementById('badgeModalTxt'),
};
const toneBtns = Array.from(document.querySelectorAll('[data-tone]'));

/* ====== Data ====== */
let settings = Object.assign({}, defSettings, load(LS.settings, {}));
let entries = load(LS.entries, []);
let meta = Object.assign({ xp:0, level:1, unlocked:[] }, load(LS.meta, {}));

/* ====== Helpers ====== */
function toast(msg, cls='alert-info'){
  const div = document.createElement('div');
  div.className = `alert ${cls}`;
  div.innerHTML = `<span>${msg}</span>`;
  el.toasts.appendChild(div);
  setTimeout(()=>div.remove(), 3200);
}
function confettiBurst(){
  try { confetti({ particleCount: 90, spread: 70, origin: { y: 0.6 } }); } catch(e){}
}
function minutesBetween(a,b){ return Math.abs(a-b)/60000; }
function isSameDay(tsA, tsB){
  const a = new Date(tsA), b = new Date(tsB);
  return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
}
function dayKey(ts){ const d=new Date(ts); return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`; }

/* ====== OCR Parsing ====== */
function addThumb(file){
  const url = URL.createObjectURL(file);
  const img = document.createElement('img');
  img.src = url; img.className = 'thumb';
  el.thumbs.appendChild(img);
}
function plaus(n,min,max){ return typeof n==='number' && isFinite(n) && n>=min && n<=max; }

function parseOCRText(text){
  const t = text.replace(/\s+/g,' ').toLowerCase();
  let hr=null, dur=null, speed=null, watt=null, distance=null;

  const hrRe = [/(\d{2,3})\s?(?:bpm|bmp)\b/, /avg[^0-9]{0,3}hr[^0-9]{0,3}(\d{2,3})\b/, /(puls|pulse|herz)[^0-9]{0,4}(\d{2,3})\b/];
  for(const re of hrRe){ const m=t.match(re); if(m){ const v=parseInt(m[1]??m[2],10); if(plaus(v,60,200)){ hr=v; break; } } }

  const hms=t.match(/\b(\d{1,2}):(\d{2}):(\d{2})\b/);
  const ms=t.match(/\b(\d{1,2}):(\d{2})\b/);
  const min=t.match(/(\d{1,3})\s?(min|minute|minutes)\b/);
  const cands=[];
  if(hms){ cands.push(parseInt(hms[1])*60 + parseInt(hms[2]) + parseInt(hms[3])/60); }
  if(ms && parseInt(ms[2])<60){ cands.push(parseInt(ms[1]) + parseInt(ms[2])/60); }
  if(min){ cands.push(parseInt(min[1])); }
  const c = cands.filter(v=>plaus(v,8,120)).sort((a,b)=>a-b);
  if(c.length) dur = c[Math.floor(c.length/2)];

  const mSpd = t.match(/(\d{1,2}(?:[\.,]\d)?)\s?(km\/h|kmh|kph)\b/);
  if(mSpd){ speed = parseFloat(mSpd[1].replace(',','.')); if(!plaus(speed,3,25)) speed=null; }

  const mW = t.match(/(\d{2,4})\s?w\b/);
  if(mW){ watt = parseInt(mW[1],10); if(!plaus(watt,30,800)) watt=null; }

  const mDist = t.match(/(\d+(?:[\.,]\d+)?)\s?km\b/);
  if(mDist){ distance = parseFloat(mDist[1].replace(',','.')); if(!plaus(distance,0.2,100)) distance=null; }
  if(distance!=null && dur!=null && speed==null){
    const kmh = distance/(dur/60); if(plaus(kmh,3,25)) speed=kmh;
  }
  return { hr, dur, speed:speed!=null?Number(speed.toFixed(2)):null, watt, raw:text };
}

/* ====== Render Badges ====== */
const BADGE_DEF = [
  { id:'first', name:'First Step', cond:(s)=>s.total>=1, desc:'Erster Eintrag gespeichert.' },
  { id:'streak3', name:'Tiny Streak', cond:(s)=>s.streak>=3, desc:'3 Tage am St√ºck.' },
  { id:'streak7', name:'Weekly Flame', cond:(s)=>s.streak>=7, desc:'7 Tage am St√ºck.' },
  { id:'streak14', name:'Fortnight Fire', cond:(s)=>s.streak>=14, desc:'14 Tage am St√ºck.' },
  { id:'streak30', name:'Iron Habit', cond:(s)=>s.streak>=30, desc:'30 Tage am St√ºck.' },
  { id:'hrPro', name:'HR Sniper', cond:(s)=>s.hrHits>=10, desc:'10√ó im Sweetspot (113‚Äì117 bpm).' },
  { id:'pb', name:'PB Hunter', cond:(s)=>s.pbCount>=3, desc:'3 Personal Bests.' },
  { id:'vol140', name:'Weekly 140', cond:(s)=>s.weekMin>=140, desc:'‚â•140 Minuten in 7 Tagen.' },
  { id:'vol210', name:'Weekly 210', cond:(s)=>s.weekMin>=210, desc:'‚â•210 Minuten in 7 Tagen.' }
];

function renderBadges(stats){
  const unlocked = new Set(meta.unlocked||[]);
  el.badges.innerHTML='';
  for(const b of BADGE_DEF){
    const isOn = unlocked.has(b.id) || b.cond(stats);
    if(isOn && !unlocked.has(b.id)){ // unlock now
      unlocked.add(b.id);
      meta.unlocked = Array.from(unlocked);
      save(LS.meta, meta);
      el.badgeModalTxt.textContent = `üèÖ ${b.name} ‚Äî ${b.desc}`;
      el.badgeModal.showModal?.();
      confettiBurst();
    }
    const node = document.createElement('div');
    node.className = `badge ${isOn?'badge-primary':'badge-ghost'} gap-1`;
    node.textContent = isOn ? `üèÖ ${b.name}` : `üîí ${b.name}`;
    node.title = b.desc;
    el.badges.appendChild(node);
  }
}

/* ====== Stats / XP / Streak ====== */
function computeStats(){
  const now = nowTS();
  const last7 = entries.filter(e => (now - e.ts) <= 7*86400000);
  const weekMin = Math.round(last7.reduce((a,e)=>a + (Number(e.dur)||0), 0));
  const byDay = new Map();
  for(const e of entries){
    const k = dayKey(e.ts);
    byDay.set(k, (byDay.get(k)||0) + 1);
  }
  // streak
  let streak=0; let d = new Date(); d.setHours(0,0,0,0);
  while(byDay.has(dayKey(d.getTime()))){ streak++; d = new Date(d.getTime()-86400000); }
  // hr hits (113‚Äì117)
  const hrHits = entries.filter(e=>Number(e.hr)>=113 && Number(e.hr)<=117).length;
  // PB counter (count how many times Speed/Watt beat previous best at HR band 112‚Äì118)
  let pbCount=0;
  let bestSpeed=null, bestWatt=null;
  for(const e of entries.slice().sort((a,b)=>a.ts-b.ts)){
    const inBand = Number(e.hr)>=112 && Number(e.hr)<=118;
    const s = Number(e.speed)||null, w = Number(e.watt)||null;
    let pb=false;
    if(inBand && s!=null){ if(bestSpeed==null || s>bestSpeed){ if(bestSpeed!=null) pb=true; bestSpeed=s; } }
    if(inBand && w!=null){ if(bestWatt==null || w>bestWatt){ if(bestWatt!=null) pb=true; bestWatt=w; } }
    if(pb) pbCount++;
  }
  return { weekMin, streak, hrHits, pbCount, total: entries.length };
}

function updateXP(entry){
  // XP: minutes (capped 30) + 5 if hr in 113‚Äì117 + 10 if PB in band
  let xp = Math.min(Number(entry.dur)||0, 30);
  if(Number(entry.hr)>=113 && Number(entry.hr)<=117) xp += 5;

  // Check PB after insert
  const band = entries.filter(e=>Number(e.hr)>=112 && Number(e.hr)<=118);
  const prev = band.slice(1); // after push
  const s = Number(entry.speed)||null, w = Number(entry.watt)||null;
  let prevBestS = null, prevBestW = null;
  for(const e of prev){ if(e.speed!=null) prevBestS = Math.max(prevBestS??e.speed, e.speed);
                        if(e.watt!=null) prevBestW = Math.max(prevBestW??e.watt, e.watt); }
  if(s!=null && (prevBestS==null || s>prevBestS)) xp += 10;
  if(w!=null && (prevBestW==null || w>prevBestW)) xp += 10;

  meta.xp = (meta.xp||0) + xp;
  while(meta.xp >= 100){ meta.level = (meta.level||1) + 1; meta.xp -= 100; confettiBurst(); }
  save(LS.meta, meta);
}

function applyStats(){
  const stats = computeStats();
  // Weekly
  const target = Number(settings.weeklyTarget)||140;
  const pct = Math.max(0, Math.min(100, Math.round(stats.weekMin/target*100)));
  el.wkMin.textContent = `${stats.weekMin}/${target}`;
  el.wkProg.value = pct;
  const tone = TONES[settings.tone]||TONES.cheeky;
  const msgIdx = pct>=100?4 : pct>=75?3 : pct>=50?2 : pct>=25?1 : 0;
  el.wkMsg.textContent = tone.wk[msgIdx];

  // Streak
  el.streak.textContent = `${stats.streak}üî•`;
  const next = stats.streak<3?3 : stats.streak<7?7 : stats.streak<14?14 : stats.streak<30?30 : '‚àû';
  el.nextBadge.textContent = next==='‚àû' ? 'alle Streak-Badges unlocked' : `n√§chster Badge bei ${next} üî•`;

  // XP / Level
  el.level.textContent = `Lv ${meta.level||1}`;
  el.xpLbl.textContent = `${meta.xp||0} / 100 XP`;
  el.xpProg.value = meta.xp||0;
  el.xpMsg.textContent = (TONES[settings.tone]?.progress[msgIdx]) || 'Keep going';

  // Badges
  renderBadges({ weekMin:stats.weekMin, streak:stats.streak, hrHits:stats.hrHits, pbCount:stats.pbCount, total:stats.total });
}

/* ====== Render Table ====== */
function renderTable(){
  el.rows.innerHTML='';
  for(const [i,e] of entries.entries()){
    const d = new Date(e.ts);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="mono">${d.toLocaleDateString()}</td>
      <td class="mono">${d.toLocaleTimeString()}</td>
      <td class="mono">${e.hr??'‚Äî'}</td>
      <td class="mono">${e.dur??'‚Äî'}</td>
      <td class="mono">${e.speed??'‚Äî'}</td>
      <td class="mono">${e.watt??'‚Äî'}</td>
      <td class="wrap">${e.notes??'‚Äî'}</td>
      <td><button data-i="${i}" class="btn btn-xs btn-ghost text-error">l√∂schen</button></td>
    `;
    el.rows.appendChild(tr);
  }
  el.rows.querySelectorAll('button[data-i]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const idx = Number(btn.getAttribute('data-i'));
      if(confirm('Eintrag wirklich l√∂schen?')){ entries.splice(idx,1); save(LS.entries, entries); renderTable(); applyStats(); }
    });
  });
}

/* ====== Save Entry ====== */
function saveEntry(obj){
  const e = {
    ts: nowTS(),
    hr: obj.hr!=null? Number(obj.hr):null,
    dur: obj.dur!=null? Number(obj.dur):null,
    speed: obj.speed!=null? Number(obj.speed):null,
    watt: obj.watt!=null? Number(obj.watt):null,
    notes: obj.notes||null
  };
  // minimal requirement: at least HR or duration
  if(e.hr==null && e.dur==null && e.speed==null && e.watt==null){
    toast('Bitte mind. Puls oder Dauer angeben.', 'alert-warning'); return;
  }
  entries.unshift(e);
  save(LS.entries, entries);
  renderTable();
  updateXP(e);
  applyStats();
  const t = TONES[settings.tone]||TONES.cheeky;
  toast(pick(t.save), 'alert-success');
}

/* ====== OCR Flow ====== */
el.fileInput.addEventListener('change', ()=>{
  el.thumbs.innerHTML=''; el.rawText.textContent=''; el.ocrProg.classList.add('hidden'); el.ocrStatus.textContent='';
  const files = Array.from(el.fileInput.files||[]);
  files.slice(0,6).forEach(addThumb);
});
el.btnOcr.addEventListener('click', async ()=>{
  const files = Array.from(el.fileInput.files||[]);
  if(!files.length){ toast('Bitte zuerst 2‚Äì3 Fotos w√§hlen.', 'alert-warning'); return; }
  el.ocrProg.classList.remove('hidden'); el.ocrProg.value=0; el.ocrStatus.textContent='OCR l√§uft‚Ä¶';
  let merged = { hr:null, dur:null, speed:null, watt:null, raw:'' };
  for(let i=0;i<files.length;i++){
    const f = files[i];
    const res = await Tesseract.recognize(f, 'eng', {
      logger: m => { if(m.status==='recognizing text' && m.progress!=null){ el.ocrProg.value = Math.round(((i+m.progress)/files.length)*100); } }
    });
    const text = res?.data?.text || '';
    merged.raw += (merged.raw?'\n----\n':'') + text;
    const p = parseOCRText(text);
    merged.hr = merged.hr ?? p.hr;
    merged.dur = merged.dur ?? p.dur;
    merged.speed = merged.speed ?? p.speed;
    merged.watt = merged.watt ?? p.watt;
  }
  el.ocrStatus.textContent='OCR fertig. Werte pr√ºfen & speichern.';
  el.rawText.textContent = merged.raw.trim();
  if(merged.hr!=null) el.f_hr.value = merged.hr;
  if(merged.dur!=null) el.f_dur.value = Number(merged.dur.toFixed(1));
  if(merged.speed!=null) el.f_speed.value = merged.speed;
  if(merged.watt!=null) el.f_watt.value = merged.watt;
});

/* ====== Settings / Theme ====== */
function applySettingsUI(){
  el.weeklyTarget.value = settings.weeklyTarget;
  el.themeSel.value = settings.theme || 'winter';
  document.documentElement.setAttribute('data-theme', el.themeSel.value);
  toneBtns.forEach(b=>{
    b.classList.toggle('btn-active', b.dataset.tone===settings.tone);
  });
}
toneBtns.forEach(b=>b.addEventListener('click', ()=>{
  settings.tone = b.dataset.tone;
  applySettingsUI();
}));
el.btnSaveSettings.addEventListener('click', ()=>{
  settings.weeklyTarget = Math.max(20, Number(el.weeklyTarget.value)||140);
  settings.theme = el.themeSel.value;
  save(LS.settings, settings);
  toast('Einstellungen gespeichert.', 'alert-info');
  applyStats();
});
el.themeSel.addEventListener('change', ()=>{
  document.documentElement.setAttribute('data-theme', el.themeSel.value);
});

/* ====== Export / Import / Clear ====== */
el.btnExport.addEventListener('click', ()=>{
  const payload = { version:1, settings, entries, meta };
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='z2_project.json'; a.click(); URL.revokeObjectURL(url);
});
el.importFile.addEventListener('change', ()=>{
  const f = el.importFile.files?.[0]; if(!f) return;
  const r = new FileReader();
  r.onload = ()=> {
    try{
      const obj = JSON.parse(r.result);
      if(!obj || !Array.isArray(obj.entries)) throw new Error('Ung√ºltiges Projekt');
      settings = Object.assign({}, defSettings, obj.settings||{});
      entries = obj.entries||[];
      meta = Object.assign({ xp:0, level:1, unlocked:[] }, obj.meta||{});
      save(LS.settings, settings); save(LS.entries, entries); save(LS.meta, meta);
      applySettingsUI(); renderTable(); applyStats();
      toast('Projekt importiert.', 'alert-success'); confettiBurst();
    }catch(e){ toast('Import fehlgeschlagen: '+e.message, 'alert-error'); }
  };
  r.readAsText(f);
});
el.btnClear.addEventListener('click', ()=>{
  if(!confirm('Wirklich alles l√∂schen?')) return;
  entries = []; meta = { xp:0, level:1, unlocked:[] };
  save(LS.entries, entries); save(LS.meta, meta);
  renderTable(); applyStats();
  toast('Alles gel√∂scht.', 'alert-warning');
});

/* ====== Quick Fill & Save ====== */
el.btnQuick115.addEventListener('click', ()=>{
  el.f_hr.value = 115; el.f_dur.value = 20;
});
el.btnSave.addEventListener('click', ()=>{
  saveEntry({
    hr: el.f_hr.value || null,
    dur: el.f_dur.value || null,
    speed: el.f_speed.value || null,
    watt: el.f_watt.value || null,
    notes: el.f_notes.value || null
  });
});

/* ====== INIT ====== */
applySettingsUI();
renderTable();
applyStats();
</script>
</body>
</html>
