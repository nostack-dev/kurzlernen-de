<!DOCTYPE html>
<html lang="de" data-theme="winter">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Z2 Mobile Log</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.3/dist/tesseract.min.js"></script>
<style>
  :root{ --font: Inter, ui-sans-serif, system-ui }
  body{ font-family: var(--font) }
  .mono{ font-variant-numeric: tabular-nums }
  .thumb{ width:100%; max-width:240px; border-radius:1rem; display:block }
  .wrap{ white-space:pre-wrap; word-break:break-word }
</style>
</head>
<body class="bg-base-200 min-h-screen">

<!-- Top Bar -->
<div class="navbar bg-base-100 shadow-sm sticky top-0 z-30">
  <div class="flex-1">
    <span class="btn btn-ghost text-lg font-extrabold">Z2 Log ðŸ“¸</span>
  </div>
  <div class="flex-none">
    <select id="themeSel" class="select select-bordered select-xs mr-2">
      <option>winter</option><option>cupcake</option><option>emerald</option><option>corporate</option><option>dracula</option><option>night</option>
    </select>
    <button id="btnExport" class="btn btn-xs">Export</button>
  </div>
</div>

<!-- Main -->
<div class="max-w-md mx-auto px-3 py-4 space-y-4">

  <!-- Capture -->
  <section class="card bg-base-100 shadow">
    <div class="card-body gap-3">
      <h2 class="card-title text-base">1) Foto aufnehmen</h2>
      <input id="camera" type="file" accept="image/*" capture="environment" class="file-input file-input-bordered w-full" />
      <img id="preview" class="thumb mt-2 hidden" alt="Vorschau" />
      <button id="btnOcr" class="btn btn-primary w-full">OCR starten</button>
      <div id="ocrStatus" class="text-sm opacity-70"></div>
      <progress id="ocrProg" class="progress w-full hidden"></progress>
      <details class="mt-1">
        <summary class="text-sm cursor-pointer">OCR-Text anzeigen</summary>
        <pre id="rawText" class="wrap text-xs opacity-80 p-2 bg-base-200 rounded"></pre>
      </details>
    </div>
  </section>

  <!-- Form -->
  <section class="card bg-base-100 shadow">
    <div class="card-body gap-3">
      <h2 class="card-title text-base">2) Werte prÃ¼fen</h2>
      <div class="form-control">
        <label class="label"><span class="label-text">Ã˜ Puls (bpm)</span></label>
        <input id="f_hr" type="number" inputmode="numeric" class="input input-bordered" placeholder="115" />
      </div>
      <div class="form-control">
        <label class="label"><span class="label-text">Dauer (Minuten)</span></label>
        <input id="f_dur" type="number" step="0.1" inputmode="decimal" class="input input-bordered" placeholder="20" />
      </div>
      <div class="grid grid-cols-2 gap-2">
        <div class="form-control">
          <label class="label"><span class="label-text">Speed (km/h)</span></label>
          <input id="f_speed" type="number" step="0.1" inputmode="decimal" class="input input-bordered" />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text">Watt</span></label>
          <input id="f_watt" type="number" step="1" inputmode="numeric" class="input input-bordered" />
        </div>
      </div>
      <input id="f_notes" type="text" class="input input-bordered" placeholder="Notiz (optional)" />
      <div class="flex gap-2">
        <button id="btnQuick" class="btn btn-outline w-1/2">Quick 115/20</button>
        <button id="btnSave" class="btn btn-success w-1/2">Speichern</button>
      </div>
      <div id="saveMsg" class="text-sm opacity-70"></div>
    </div>
  </section>

  <!-- Log -->
  <section class="card bg-base-100 shadow">
    <div class="card-body gap-2">
      <div class="flex items-center justify-between">
        <h2 class="card-title text-base">3) EintrÃ¤ge</h2>
        <label class="btn btn-sm">
          Import
          <input id="importFile" type="file" accept="application/json" class="hidden">
        </label>
      </div>
      <div id="emptyHint" class="text-sm opacity-70">Noch keine EintrÃ¤ge.</div>
      <div id="list" class="space-y-2"></div>
      <button id="btnClear" class="btn btn-sm btn-error">Alles lÃ¶schen</button>
    </div>
  </section>

</div>

<!-- Toasts -->
<div class="toast toast-center z-40" id="toasts" style="inset:auto 0.75rem 0.75rem 0.75rem"></div>

<script>
  /* ========= Helpers / Storage ========= */
  const $ = sel => document.querySelector(sel);
  const LS_KEY = 'z2_mobile_entries_v1';
  const THEME_KEY = 'z2_mobile_theme';
  const load = () => { try { return JSON.parse(localStorage.getItem(LS_KEY) || '[]'); } catch(e){ return []; } };
  const save = (arr) => localStorage.setItem(LS_KEY, JSON.stringify(arr));
  const toast = (msg, cls='alert-info') => {
    const div = document.createElement('div');
    div.className = `alert ${cls}`; div.innerHTML = `<span>${msg}</span>`;
    $('#toasts').appendChild(div); setTimeout(()=>div.remove(), 2200);
  };

  /* ========= Minimal OCR Parsing ========= */
  function plaus(n,min,max){ return typeof n==='number' && isFinite(n) && n>=min && n<=max; }
  function parseOCRText(txt){
    const t = txt.replace(/\s+/g,' ').toLowerCase();
    let hr=null, dur=null, speed=null, watt=null;

    // HR
    const hrRe = [/(\d{2,3})\s?(?:bpm|bmp)\b/, /avg[^0-9]{0,3}hr[^0-9]{0,3}(\d{2,3})\b/, /(puls|pulse|herz)[^0-9]{0,3}(\d{2,3})\b/];
    for(const re of hrRe){ const m=t.match(re); if(m){ const v=parseInt(m[1]||m[2],10); if(plaus(v,60,200)){ hr=v; break; } } }

    // Dauer (H:MM:SS | MM:SS | "20 min")
    const cands=[];
    const mHMS=t.match(/\b(\d{1,2}):(\d{2}):(\d{2})\b/);
    if(mHMS){ cands.push(parseInt(mHMS[1])*60 + parseInt(mHMS[2]) + parseInt(mHMS[3])/60); }
    const mMS=t.match(/\b(\d{1,2}):(\d{2})\b/);
    if(mMS && parseInt(mMS[2])<60){ cands.push(parseInt(mMS[1]) + parseInt(mMS[2])/60); }
    const mMin=t.match(/(\d{1,3})\s?(?:min|minute|minutes)\b/);
    if(mMin){ cands.push(parseInt(mMin[1])); }
    const dlist=cands.filter(v=>plaus(v,8,120)).sort((a,b)=>a-b);
    if(dlist.length) dur = dlist[Math.floor(dlist.length/2)];

    // Speed km/h
    const mSpd=t.match(/(\d{1,2}(?:[\.,]\d)?)\s?(?:km\/h|kmh|kph)\b/);
    if(mSpd){ let v=parseFloat(mSpd[1].replace(',','.')); if(plaus(v,3,25)) speed=Number(v.toFixed(2)); }

    // Watt
    const mW=t.match(/(\d{2,4})\s?w\b/);
    if(mW){ let v=parseInt(mW[1],10); if(plaus(v,30,800)) watt=v; }

    return {hr, dur, speed, watt, raw:txt};
  }

  /* ========= UI Bindings ========= */
  const entries = load();

  function renderList(){
    const list = $('#list'); list.innerHTML='';
    $('#emptyHint').classList.toggle('hidden', entries.length>0);
    for(const [i,e] of entries.entries()){
      const d = new Date(e.ts);
      const card = document.createElement('div');
      card.className = 'rounded-box p-3 bg-base-200';
      card.innerHTML = `
        <div class="text-sm mono">${d.toLocaleDateString()} â€¢ ${d.toLocaleTimeString()}</div>
        <div class="text-base font-semibold">${e.hr??'â€”'} bpm Â· ${e.dur??'â€”'} min</div>
        <div class="text-sm opacity-80">Speed: ${e.speed??'â€”'} km/h Â· Watt: ${e.watt??'â€”'}</div>
        <div class="text-sm">${e.notes?e.notes:' '}</div>
        <div class="mt-2"><button class="btn btn-xs btn-ghost text-error" data-i="${i}">lÃ¶schen</button></div>
      `;
      list.appendChild(card);
    }
    list.querySelectorAll('[data-i]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const idx = Number(btn.getAttribute('data-i'));
        if(confirm('Eintrag lÃ¶schen?')){ entries.splice(idx,1); save(entries); renderList(); toast('GelÃ¶scht.','alert-warning'); }
      });
    });
  }

  // Theme
  const savedTheme = localStorage.getItem(THEME_KEY);
  if(savedTheme) { document.documentElement.setAttribute('data-theme', savedTheme); $('#themeSel').value = savedTheme; }
  $('#themeSel').addEventListener('change', ()=>{
    const th = $('#themeSel').value;
    document.documentElement.setAttribute('data-theme', th);
    localStorage.setItem(THEME_KEY, th);
  });

  // Camera preview
  $('#camera').addEventListener('change', ()=>{
    const f = $('#camera').files?.[0];
    if(!f){ $('#preview').classList.add('hidden'); return; }
    const url = URL.createObjectURL(f);
    $('#preview').src = url; $('#preview').classList.remove('hidden');
    $('#ocrStatus').textContent = 'Bereit fÃ¼r OCR.';
  });

  // OCR
  $('#btnOcr').addEventListener('click', async ()=>{
    const f = $('#camera').files?.[0];
    if(!f){ toast('Erst ein Foto aufnehmen.', 'alert-warning'); return; }
    $('#ocrProg').classList.remove('hidden'); $('#ocrProg').value = 0;
    $('#ocrStatus').textContent = 'Erkenne Textâ€¦';
    const res = await Tesseract.recognize(f, 'eng', { logger: m => {
      if(m.status==='recognizing text' && m.progress!=null){ $('#ocrProg').value = Math.round(m.progress*100); }
    }});
    $('#ocrProg').classList.add('hidden');
    const text = res?.data?.text || '';
    $('#rawText').textContent = text.trim();
    const p = parseOCRText(text);
    if(p.hr!=null) $('#f_hr').value = p.hr;
    if(p.dur!=null) $('#f_dur').value = Number(p.dur.toFixed(1));
    if(p.speed!=null) $('#f_speed').value = p.speed;
    if(p.watt!=null) $('#f_watt').value = p.watt;
    $('#ocrStatus').textContent = 'OCR fertig. Werte ggf. anpassen & speichern.';
  });

  // Quick 115/20
  $('#btnQuick').addEventListener('click', ()=>{
    $('#f_hr').value = 115; $('#f_dur').value = 20;
    toast('Quick-Fill gesetzt.','alert-info');
  });

  // Save
  $('#btnSave').addEventListener('click', ()=>{
    const e = {
      ts: Date.now(),
      hr: $('#f_hr').value ? Number($('#f_hr').value) : null,
      dur: $('#f_dur').value ? Number($('#f_dur').value) : null,
      speed: $('#f_speed').value ? Number($('#f_speed').value) : null,
      watt: $('#f_watt').value ? Number($('#f_watt').value) : null,
      notes: $('#f_notes').value || null
    };
    if(e.hr==null && e.dur==null && e.speed==null && e.watt==null){ toast('Mind. Puls oder Dauer angeben.','alert-warning'); return; }
    entries.unshift(e); save(entries); renderList();
    $('#saveMsg').textContent = 'Gespeichert. Good job.';
    setTimeout(()=>$('#saveMsg').textContent='', 1500);
    toast('Logged. Keep stacking.','alert-success');
  });

  // Export / Import / Clear
  $('#btnExport').addEventListener('click', ()=>{
    const payload = { version:1, entries };
    const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='z2_mobile_project.json'; a.click(); URL.revokeObjectURL(url);
  });
  $('#importFile').addEventListener('change', ()=>{
    const f = $('#importFile').files?.[0]; if(!f) return;
    const r = new FileReader();
    r.onload = ()=>{
      try{
        const obj = JSON.parse(r.result);
        if(!obj || !Array.isArray(obj.entries)) throw new Error('UngÃ¼ltiges Projekt');
        entries.splice(0, entries.length, ...obj.entries);
        save(entries); renderList(); toast('Import ok.','alert-success');
      }catch(e){ toast('Import fehlgeschlagen.','alert-error'); }
    };
    r.readAsText(f);
  });
  $('#btnClear').addEventListener('click', ()=>{
    if(!confirm('Wirklich alles lÃ¶schen?')) return;
    entries.splice(0, entries.length); save(entries); renderList(); toast('Alles gelÃ¶scht.','alert-warning');
  });

  // First render
  renderList();
</script>
</body>
</html>
