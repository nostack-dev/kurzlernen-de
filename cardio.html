<!DOCTYPE html>
<html lang="de" data-theme="winter">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Z2 Log</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.3/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  :root { --font: Inter, ui-sans-serif, system-ui; }
  body { font-family: var(--font); }
  .mono { font-variant-numeric: tabular-nums; }
  .thumb { width: 6rem; height: 6rem; object-fit: cover; border-radius: 0.75rem; border: 1px solid oklch(var(--n) / 0.1); }
  .wrap { word-break: break-word; white-space: pre-wrap; }
  .btn-active-tone { @apply !bg-primary !text-primary-content; }
</style>
</head>
<body class="bg-base-200 min-h-screen pb-16">

<!-- Nav & Header -->
<div class="navbar bg-base-100 shadow-lg sticky top-0 z-30 px-4 sm:px-8 py-3">
  <div class="flex-1">
    <div class="flex items-center space-x-2">
      <span class="text-2xl font-extrabold text-primary">Z2 Log</span>
      <span class="badge badge-lg font-semibold badge-outline text-xs sm:text-sm">V4.3</span>
    </div>
  </div>
  <div class="flex-none gap-2">
    <!-- Dropdown f√ºr Einstellungen -->
    <div class="dropdown dropdown-end">
      <div tabindex="0" role="button" class="btn btn-ghost btn-circle">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37-2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.527.32.956.638 1.407 1.056z" />
        </svg>
      </div>
      <ul tabindex="0" class="menu menu-sm dropdown-content mt-3 z-[1] p-4 shadow bg-base-100 rounded-box w-64">
        <li class="menu-title">Einstellungen</li>
        <li class="p-2">
          <label class="label"><span class="label-text">Theme</span></label>
          <select id="themeSel" class="select select-bordered select-sm w-full">
            <option>winter</option><option>cupcake</option><option>emerald</option>
            <option>corporate</option><option>dracula</option><option>night</option>
          </select>
        </li>
        <li class="p-2">
          <label class="label"><span class="label-text">Ton (Motivation)</span></label>
          <div class="join w-full">
            <button class="join-item btn btn-sm" data-tone="gentle">gentle</button>
            <button class="join-item btn btn-sm" data-tone="cheeky">cheeky</button>
            <button class="join-item btn btn-sm" data-tone="spicy">spicy</button>
          </div>
        </li>
        <li class="p-2">
          <label class="label"><span class="label-text">Wochenziel (Minuten)</span></label>
          <input id="weeklyTarget" type="number" class="input input-sm input-bordered w-full" value="140" />
        </li>
        <li><button id="btnSaveSettings" class="btn btn-sm btn-primary mt-2 w-full">Speichern</button></li>
      </ul>
    </div>
  </div>
</div>

<!-- Hauptinhalt -->
<div class="container mx-auto px-4 py-8 md:max-w-4xl">

  <!-- Nutzerinfo & Hero -->
  <div class="mb-8">
    <div class="p-6 bg-gradient-to-br from-base-100 to-base-200 rounded-2xl shadow-xl border border-base-300">
      <div class="flex items-center space-x-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-primary" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.38 0 2.5 1.12 2.5 2.5S13.38 10.5 12 10.5 9.5 9.38 9.5 8 10.62 5.5 12 5.5zm-2 14.24v-1.74c0-1.66 1.34-3 3-3h2.36c1.66 0 3 1.34 3 3v1.74c-1.37.95-3.04 1.5-4.86 1.5s-3.49-.55-4.86-1.5z"/></svg>
        <div class="flex-1">
          <h1 class="text-xl sm:text-2xl font-bold">Hallo, Christian Heinrich Hohlfeld</h1>
          <p class="text-sm opacity-70">Konstanz, Deutschland | 05.04.1983</p>
          <p class="mt-2 text-sm italic opacity-80">Dein Weg zu besserer Mitochondrienfunktion. üî•</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Statistik-√úbersicht -->
  <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <div class="card bg-base-100 shadow-lg border border-base-300 transform transition-transform hover:scale-[1.01]">
      <div class="card-body p-5">
        <h2 class="card-title text-sm opacity-80">Wochenminuten</h2>
        <div id="wkMin" class="text-3xl font-extrabold mono text-primary">0</div>
        <progress id="wkProg" class="progress progress-primary w-full" value="0" max="100"></progress>
        <div id="wkMsg" class="text-xs opacity-70 mt-1">Los geht's.</div>
      </div>
    </div>
    <div class="card bg-base-100 shadow-lg border border-base-300 transform transition-transform hover:scale-[1.01]">
      <div class="card-body p-5">
        <h2 class="card-title text-sm opacity-80">Streak</h2>
        <div id="streak" class="text-3xl font-extrabold mono text-secondary">0 üî•</div>
        <div class="text-xs opacity-70">Konsekutive Tage</div>
        <div id="nextBadge" class="badge badge-outline mt-2 text-xs">N√§chster: 3 üî•</div>
      </div>
    </div>
    <div class="card bg-base-100 shadow-lg border border-base-300 transform transition-transform hover:scale-[1.01]">
      <div class="card-body p-5">
        <h2 class="card-title text-sm opacity-80">Level</h2>
        <div id="level" class="text-3xl font-extrabold mono text-accent">Lv 1</div>
        <progress id="xpProg" class="progress progress-secondary w-full" value="0" max="100"></progress>
        <div id="xpLbl" class="text-xs opacity-70 mt-1">0 / 100 XP</div>
      </div>
    </div>
    <div class="card bg-base-100 shadow-lg border border-base-300 transform transition-transform hover:scale-[1.01]">
      <div class="card-body p-5">
        <h2 class="card-title text-sm opacity-80">Eintr√§ge insgesamt</h2>
        <div id="totalSessions" class="text-3xl font-extrabold mono text-info">0</div>
        <div class="text-xs opacity-70">Gespeicherte Eintr√§ge</div>
      </div>
    </div>
  </section>

  <!-- Aktionspanel: Foto, OCR, Formular -->
  <section class="bg-base-100 rounded-2xl shadow-xl p-6 mb-8 border border-base-300">
    <h2 class="text-xl font-bold mb-4">1. Session erfassen</h2>

    <div class="flex flex-col sm:flex-row sm:items-center gap-4 mb-4">
      <!-- Input, der die Kamera direkt √∂ffnet -->
      <label class="btn btn-primary w-full sm:max-w-xs cursor-pointer">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 8c2.21 0 4 1.79 4 4s-1.79 4-4 4-4-1.79-4-4 1.79-4 4-4zm0 14c-5.52 0-10-4.48-10-10S6.48 2 12 2s10 4.48 10 10-4.48 10-10 10zM12 4c-4.41 0-8 3.59-8 8s3.59 8 8 8 8-3.59 8-8-3.59-8-8-8zM20 12c0-2.61-1.01-5-2.65-6.65L16 7.42V6h-1.42l-1.35-1.35C13 4.29 12.55 4 12 4s-1.35.29-1.42 1.35L9.65 6H8v1.42L6.65 9.35C5.01 11 4 13.39 4 16h2c0-1.89.65-3.6 1.7-4.95L8 9.94V9c.55 0 1-.45 1-1V7h6v1c0 .55.45 1 1 1v.94l.3 1.11C17.35 12.4 18 14.11 18 16h2c0-2.61-1.01-5-2.65-6.65z"/></svg>
        Foto machen
        <input id="fileInput" type="file" accept="image/*" multiple capture="environment" class="hidden" />
      </label>
      <button id="btnOcr" class="btn btn-primary w-full sm:w-auto">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M19 5v14H5V5h14m0-2H5a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2V5a2 2 0 00-2-2z"/><path d="M11.5 13.5v-1h-1v1H9.5V11h-1v1h-1v1.5h1v1h1v1.5h1v-1.5h1v-1.5zM15 16h-4v-1h4v1zm-4-4h4v-1h-4v1z"/></svg>
        Daten erkennen
      </button>
    </div>
    <div id="thumbs" class="mt-4 flex flex-wrap gap-3"></div>
    <progress id="ocrProg" class="progress progress-primary w-full mt-4 hidden" value="0" max="100"></progress>
    <div id="ocrStatus" class="text-sm opacity-70 mt-2"></div>

    <div class="divider my-4"></div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      <label class="form-control w-full">
        <div class="label"><span class="label-text">√ò Puls (bpm)</span></div>
        <input id="f_hr" type="number" inputmode="numeric" placeholder="z.B. 115" class="input input-bordered w-full" />
      </label>
      <label class="form-control w-full">
        <div class="label"><span class="label-text">Dauer (Minuten)</span></div>
        <input id="f_dur" type="number" step="0.1" inputmode="decimal" placeholder="z.B. 20" class="input input-bordered w-full" />
      </label>
      <label class="form-control w-full">
        <div class="label"><span class="label-text">Speed (km/h)</span></div>
        <input id="f_speed" type="number" step="0.1" inputmode="decimal" placeholder="optional" class="input input-bordered w-full" />
      </label>
      <label class="form-control w-full">
        <div class="label"><span class="label-text">Watt</span></div>
        <input id="f_watt" type="number" step="1" inputmode="numeric" placeholder="optional" class="input input-bordered w-full" />
      </label>
    </div>
    <label class="form-control w-full mt-4">
      <div class="label"><span class="label-text">Notizen (optional)</span></div>
      <input id="f_notes" type="text" placeholder="Hitze, Koffein, Medikinet‚Ä¶" class="input input-bordered w-full" />
    </label>
    <div class="mt-6 flex flex-col sm:flex-row gap-3">
      <button id="btnSave" class="btn btn-success flex-1">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M17 3H5a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2V7zM7 7h10v1H7V7zm0 2h10v1H7V9zm0 2h10v1H7v-1z"/></svg>
        Eintrag speichern
      </button>
      <button id="btnQuick115" class="btn btn-outline flex-1">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a10 10 0 1010 10A10 10 0 0012 2zm-1 15v-6h2v6zm2-8h-2v-2h2z"/></svg>
        Schnell-Ausf√ºllen: 115 / 20 min
      </button>
    </div>
  </section>

  <!-- Log-Tabelle & Badges -->
  <section class="bg-base-100 rounded-2xl shadow-xl p-6 border border-base-300">
    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-4">
      <h2 class="text-xl font-bold">2. Deine Sessions</h2>
      <div class="dropdown dropdown-end">
        <div tabindex="0" role="button" class="btn btn-ghost btn-sm">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M4 12c0 4.41 3.59 8 8 8s8-3.59 8-8-3.59-8-8-8-8 3.59-8 8zM12 20c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/><path d="M12 4v-2c-5.52 0-10 4.48-10 10s4.48 10 10 10v-2c-4.41 0-8-3.59-8-8s3.59-8 8-8zM17 11h-4V7h-2v4H7v2h4v4h2v-4h4z"/></svg>
          Daten-Tools
        </div>
        <ul tabindex="0" class="menu menu-sm dropdown-content mt-3 z-[1] p-2 shadow bg-base-100 rounded-box w-48">
          <li><button id="btnExport" class="btn btn-ghost btn-sm">Export (JSON)</button></li>
          <li>
            <label class="btn btn-ghost btn-sm cursor-pointer">
              Importieren
              <input id="importFile" type="file" accept="application/json" class="hidden">
            </label>
          </li>
          <li><button id="btnClear" class="btn btn-ghost btn-sm text-error">Alle Eintr√§ge l√∂schen</button></li>
        </ul>
      </div>
    </div>
    <div class="overflow-x-auto mt-2">
      <table class="table table-sm">
        <thead>
          <tr>
            <th>Datum</th><th>Min</th><th>√ò HR</th><th>Speed</th><th>Watt</th><th></th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
    <div class="mt-8">
      <h3 class="text-lg font-bold mb-2">Deine Achievements</h3>
      <div id="badges" class="flex flex-wrap gap-2"></div>
    </div>
  </section>
</div>

<!-- TOASTS -->
<div class="toast toast-end z-40" id="toasts"></div>

<!-- MODAL: Badge freigeschaltet -->
<dialog id="badgeModal" class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg">üéâ Neuer Badge!</h3>
    <p id="badgeModalTxt" class="py-2"></p>
    <div class="modal-action">
      <form method="dialog"><button class="btn">Super!</button></form>
    </div>
  </div>
</dialog>

<!-- MODAL: L√∂schen best√§tigen -->
<dialog id="deleteModal" class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg text-error">‚ö†Ô∏è Eintrag l√∂schen?</h3>
    <p class="py-2">M√∂chten Sie diesen Eintrag wirklich unwiderruflich l√∂schen?</p>
    <div class="modal-action">
      <button id="btnConfirmDelete" class="btn btn-error">L√∂schen</button>
      <form method="dialog"><button class="btn">Abbrechen</button></form>
    </div>
  </div>
</dialog>

<script>
/* ====== Status & Speicher ====== */
const LS = {
  entries: 'z2_fun_entries_v1',
  settings: 'z2_fun_settings_v1',
  meta: 'z2_fun_meta_v1'
};
const defSettings = { tone: 'cheeky', weeklyTarget: 140, theme: 'winter' };

// Diese Variablen m√ºssen global deklariert werden, bevor Funktionen sie verwenden.
let settings = load(LS.settings, defSettings);
let entries = load(LS.entries, []);
let meta = load(LS.meta, { xp: 0, level: 1, unlocked: [] });

function load(key, fallback) {
  try { return JSON.parse(localStorage.getItem(key)) ?? fallback; } catch(e){ return fallback; }
}
function save(key, val) { localStorage.setItem(key, JSON.stringify(val)); }
function nowTS(){ return Date.now(); }

/* ====== Benachrichtigungs-Texte ====== */
const TONES = {
  gentle: {
    wk: ["Lasst uns sanft starten.", "Ruhig starten ‚Äì best√§ndig bleiben.", "Guter Flow ‚Äì Zone-2 liebt Konstanz.", "Stark! Der Trend gef√§llt.", "On fire (auf leise Art). Weiter so!", "Dein K√∂rper dankt es dir. Wunderbar!", "Immer sch√∂n im Rhythmus bleiben."],
    save: ["Sch√∂ner Eintrag. Kleine Schritte, gro√üer Effekt.", "Konstant ist K√∂nig. Sauber erledigt.", "Fein dosiert, fein geliefert.", "Sehr gut ‚Äì die Mitochondrien sagen Danke.", "Wunderbar! Ein weiterer Schritt in die richtige Richtung.", "Ein Eintrag, der gut tut. Weiter so."],
    progress: ["Aufw√§rmphase","Du bist dabei","Kommt ins Rollen","Fast da","Goldene Konstanz!"]
  },
  cheeky: {
    wk: ["Ok, Anlasser gez√ºndet.", "Motor schnurrt. Mehr davon.", "Zone-2 Enjoyer detected.", "Cardio greift ‚Äì nice!", "Well well‚Ä¶ look who‚Äôs consistent üòé", "Nicht aufzuhalten, oder?", "Zeig, was in dir steckt!"],
    save: ["Logged. Clean like a whistle.", "Another brick in the aerobic wall.", "Chef‚Äôs kiss ‚Äì genau so.", "Mint. Keep stacking.", "Boom! Eingeloggt und bereit f√ºr mehr.", "Perfekt festgehalten. N√§chster bitte!"],
    progress: ["Low-key","Wird warm","Nice groove","Baller-mode light","Consistency beast!"]
  },
  spicy: {
    wk: ["Startschuss. Keine Ausreden.", "Okay, du bist auf der Bahn.", "Das brennt angenehm ‚Äì weiter.", "Stabiler Grind, Respekt.", "Well, well‚Ä¶ you‚Äôve got guts.", "Komm aus der Deckung, weiter so!", "Dein innerer K√§mpfer ist geweckt."],
    save: ["Logged. No fluff.", "Disziplin > Motivation. Good call.", "Werk getan. N√§chster.", "Solid. Keep the heat on.", "Ein gnadenloser Schritt. Top.", "Lass Taten sprechen. Eingetragen."],
    progress: ["Couch-escape","Wach werden","It‚Äôs cooking","Nearly there","Certified machine"]
  }
};
// Neue Toasts f√ºr allgemeine Meldungen
const TOASTS = {
  info: [
    "Einstellungen gespeichert. Du bist bestens vorbereitet.",
    "Daten wurden erfolgreich exportiert.",
    "Projekt erfolgreich importiert. Willkommen zur√ºck!",
    "Alles gel√∂scht. Ein Neustart ist manchmal gut.",
    "Schnell-Ausf√ºllen aktiviert. Effizienz pur!"
  ],
  warning: [
    "Bitte zuerst ein Foto ausw√§hlen.",
    "Bitte mind. Puls oder Dauer angeben. Warten auf Input...",
    "Import fehlgeschlagen. Bitte die Datei pr√ºfen.",
    "Keine verwertbaren Daten gefunden. Bitte manuell eingeben."
  ],
  success: [
    "Eintrag erfolgreich gespeichert. Weiter so!",
    "Neuer Eintrag gesichert. Deine Mitochondrien freuen sich.",
    "Daten erfasst. Der Fortschritt ist unaufhaltsam.",
    "Erfolgreich eingeloggt. Jeder Eintrag z√§hlt."
  ],
  error: [
    "OCR-Fehler. Konnte die Daten nicht lesen.",
    "Es gab ein Problem beim Speichern.",
    "Die Datei ist ung√ºltig. Import abgebrochen."
  ]
};

function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

/* ====== Elemente ====== */
const el = {
  themeSel: document.getElementById('themeSel'),
  weeklyTarget: document.getElementById('weeklyTarget'),
  btnSaveSettings: document.getElementById('btnSaveSettings'),
  wkMin: document.getElementById('wkMin'),
  wkProg: document.getElementById('wkProg'),
  wkMsg: document.getElementById('wkMsg'),
  streak: document.getElementById('streak'),
  nextBadge: document.getElementById('nextBadge'),
  level: document.getElementById('level'),
  xpLbl: document.getElementById('xpLbl'),
  xpProg: document.getElementById('xpProg'),
  totalSessions: document.getElementById('totalSessions'),
  fileInput: document.getElementById('fileInput'),
  thumbs: document.getElementById('thumbs'),
  btnOcr: document.getElementById('btnOcr'),
  ocrStatus: document.getElementById('ocrStatus'),
  ocrProg: document.getElementById('ocrProg'),
  f_hr: document.getElementById('f_hr'),
  f_dur: document.getElementById('f_dur'),
  f_speed: document.getElementById('f_speed'),
  f_watt: document.getElementById('f_watt'),
  f_notes: document.getElementById('f_notes'),
  btnSave: document.getElementById('btnSave'),
  btnQuick115: document.getElementById('btnQuick115'),
  rows: document.getElementById('rows'),
  btnExport: document.getElementById('btnExport'),
  importFile: document.getElementById('importFile'),
  btnClear: document.getElementById('btnClear'),
  badges: document.getElementById('badges'),
  toasts: document.getElementById('toasts'),
  badgeModal: document.getElementById('badgeModal'),
  badgeModalTxt: document.getElementById('badgeModalTxt'),
  deleteModal: document.getElementById('deleteModal'),
  btnConfirmDelete: document.getElementById('btnConfirmDelete'),
};
const toneBtns = Array.from(document.querySelectorAll('[data-tone]'));

/* ====== Hilfsfunktionen ====== */
function toast(msg, cls='alert-info'){
  const div = document.createElement('div');
  div.className = `alert ${cls}`;
  div.innerHTML = `<span>${msg}</span>`;
  el.toasts.appendChild(div);
  setTimeout(()=>div.remove(), 3200);
}
function confettiBurst(){
  try { confetti({ particleCount: 90, spread: 70, origin: { y: 0.6 } }); } catch(e){}
}
function isSameDay(tsA, tsB){
  const a = new Date(tsA), b = new Date(tsB);
  return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
}
function dayKey(ts){ const d=new Date(ts); return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`; }

/* ====== OCR-Parsing ====== */
function addThumb(file){
  const url = URL.createObjectURL(file);
  const img = document.createElement('img');
  img.src = url; img.className = 'thumb';
  el.thumbs.appendChild(img);
}
function plaus(n,min,max){ return typeof n==='number' && isFinite(n) && n>=min && n<=max; }

function parseOCRText(text){
  const t = text.replace(/\s+/g,' ').toLowerCase();
  let hr=null, dur=null, speed=null, watt=null, distance=null;

  const hrRe = [/(\d{2,3})\s?(?:bpm|bmp)\b/, /avg[^0-9]{0,3}hr[^0-9]{0,3}(\d{2,3})\b/, /(puls|pulse|herz)[^0-9]{0,4}(\d{2,3})\b/];
  for(const re of hrRe){ const m=t.match(re); if(m){ const v=parseInt(m[1]??m[2],10); if(plaus(v,60,200)){ hr=v; break; } } }

  const hms=t.match(/\b(\d{1,2}):(\d{2}):(\d{2})\b/);
  const ms=t.match(/\b(\d{1,2}):(\d{2})\b/);
  const min=t.match(/(\d{1,3})\s?(min|minute|minutes)\b/);
  const cands=[];
  if(hms){ cands.push(parseInt(hms[1])*60 + parseInt(hms[2]) + parseInt(hms[3])/60); }
  if(ms && parseInt(ms[2])<60){ cands.push(parseInt(ms[1]) + parseInt(ms[2])/60); }
  if(min){ cands.push(parseInt(min[1])); }
  const c = cands.filter(v=>plaus(v,8,120)).sort((a,b)=>a-b);
  if(c.length) dur = c[Math.floor(c.length/2)];

  const mSpd = t.match(/(\d{1,2}(?:[\.,]\d)?)\s?(km\/h|kmh|kph)\b/);
  if(mSpd){ speed = parseFloat(mSpd[1].replace(',','.')); if(!plaus(speed,3,25)) speed=null; }

  const mW = t.match(/(\d{2,4})\s?w\b/);
  if(mW){ watt = parseInt(mW[1],10); if(!plaus(watt,30,800)) watt=null; }

  const mDist = t.match(/(\d+(?:[\.,]\d+)?)\s?km\b/);
  if(mDist){ distance = parseFloat(mDist[1].replace(',','.')); if(!plaus(distance,0.2,100)) distance=null; }
  if(distance!=null && dur!=null && speed==null){
    const kmh = distance/(dur/60); if(plaus(kmh,3,25)) speed=kmh;
  }
  return { hr, dur, speed:speed!=null?Number(speed.toFixed(2)):null, watt, raw:t };
}

/* ====== Badges rendern ====== */
const BADGE_DEF = [
  { id:'first', name:'Erster Schritt', cond:(s)=>s.total>=1, desc:'Erster Eintrag gespeichert.' },
  { id:'streak3', name:'Kleiner Lauf', cond:(s)=>s.streak>=3, desc:'3 Tage am St√ºck.' },
  { id:'streak7', name:'Wochen-Feuer', cond:(s)=>s.streak>=7, desc:'7 Tage am St√ºck.' },
  { id:'streak14', name:'Vierzehn-Tage-Flamme', cond:(s)=>s.streak>=14, desc:'14 Tage am St√ºck.' },
  { id:'streak30', name:'Eiserne Gewohnheit', cond:(s)=>s.streak>=30, desc:'30 Tage am St√ºck.' },
  { id:'hrPro', name:'Puls-Scharfsch√ºtze', cond:(s)=>s.hrHits>=10, desc:'10√ó im Sweetspot (113‚Äì117 bpm).' },
  { id:'pb', name:'PB-J√§ger', cond:(s)=>s.pbCount>=3, desc:'3 pers√∂nliche Bestleistungen.' },
  { id:'vol140', name:'Woche 140', cond:(s)=>s.weekMin>=140, desc:'‚â•140 Minuten in 7 Tagen.' },
  { id:'vol210', name:'Woche 210', cond:(s)=>s.weekMin>=210, desc:'‚â•210 Minuten in 7 Tagen.' }
];

function renderBadges(stats){
  const currentlyUnlocked = new Set(BADGE_DEF.filter(b => b.cond(stats)).map(b => b.id));
  const previousUnlocked = new Set(meta.unlocked || []);

  el.badges.innerHTML='';
  for(const b of BADGE_DEF){
    const isNowUnlocked = currentlyUnlocked.has(b.id);
    const node = document.createElement('div');
    node.className = `badge ${isNowUnlocked?'badge-primary':'badge-ghost'} gap-1 cursor-pointer`;
    node.textContent = isNowUnlocked ? `üèÖ ${b.name}` : `üîí ${b.name}`;
    node.title = b.desc;
    el.badges.appendChild(node);

    // Auf neu freigeschaltete Badges pr√ºfen, um das Modal anzuzeigen
    if (isNowUnlocked && !previousUnlocked.has(b.id)) {
      el.badgeModalTxt.textContent = `üéâ Neuer Badge! üèÖ ${b.name} ‚Äî ${b.desc}`;
      el.badgeModal.showModal?.();
      confettiBurst();
    }
  }

  // meta.unlocked aktualisieren
  meta.unlocked = Array.from(currentlyUnlocked);
  save(LS.meta, meta);
}

/* ====== Statistiken / XP / Streak berechnen ====== */
function computeStats(){
  const now = nowTS();
  const last7 = entries.filter(e => (now - e.ts) <= 7*86400000);
  const weekMin = Math.round(last7.reduce((a,e)=>a + (Number(e.dur)||0), 0));
  const byDay = new Map();
  for(const e of entries){
    const k = dayKey(e.ts);
    byDay.set(k, (byDay.get(k)||0) + 1);
  }
  let streak=0; let d = new Date(); d.setHours(0,0,0,0);
  while(byDay.has(dayKey(d.getTime()))){ streak++; d = new Date(d.getTime()-86400000); }
  const hrHits = entries.filter(e=>Number(e.hr)>=113 && Number(e.hr)<=117).length;
  let pbCount=0;
  let bestSpeed=null, bestWatt=null;
  for(const e of entries.slice().sort((a,b)=>a.ts-b.ts)){
    const inBand = Number(e.hr)>=112 && Number(e.hr)<=118;
    const s = Number(e.speed)||null, w = Number(e.watt)||null;
    let pb=false;
    if(inBand && s!=null){ if(bestSpeed==null || s>bestSpeed){ if(bestSpeed!=null) pb=true; bestSpeed=s; } }
    if(inBand && w!=null){ if(bestWatt==null || w>bestWatt){ if(bestWatt!=null) pb=true; bestWatt=w; } }
    if(pb) pbCount++;
  }
  return { weekMin, streak, hrHits, pbCount, total: entries.length };
}

function updateXP(entry){
  let xp = Math.min(Number(entry.dur)||0, 30);
  if(Number(entry.hr)>=113 && Number(entry.hr)<=117) xp += 5;
  const band = entries.filter(e=>Number(e.hr)>=112 && Number(e.hr)<=118);
  const prev = band.slice(1);
  const s = Number(entry.speed)||null, w = Number(entry.watt)||null;
  let prevBestS = null, prevBestW = null;
  for(const e of prev){
    if(e.speed!=null) prevBestS = Math.max(prevBestS??e.speed, e.speed);
    if(e.watt!=null) prevBestW = Math.max(prevBestW??e.watt, e.watt);
  }
  if(s!=null && (prevBestS==null || s>prevBestS)) xp += 10;
  if(w!=null && (prevBestW==null || w>prevBestW)) xp += 10;

  meta.xp = (meta.xp||0) + xp;
  while(meta.xp >= 100){ meta.level = (meta.level||1) + 1; meta.xp -= 100; confettiBurst(); }
  save(LS.meta, meta);
}

function applyStats(){
  const stats = computeStats();
  const target = Number(settings.weeklyTarget)||140;
  const pct = Math.max(0, Math.min(100, Math.round(stats.weekMin/target*100)));
  el.wkMin.textContent = `${stats.weekMin} / ${target} min`;
  el.wkProg.value = pct;
  const tone = TONES[settings.tone]||TONES.gentle;
  const msgIdx = pct>=100?4 : pct>=75?3 : pct>=50?2 : pct>=25?1 : 0;
  el.wkMsg.textContent = tone.progress[msgIdx];

  el.streak.textContent = `${stats.streak}üî•`;
  const next = stats.streak<3?3 : stats.streak<7?7 : stats.streak<14?14 : stats.streak<30?30 : '‚àû';
  el.nextBadge.textContent = next==='‚àû' ? 'Alle Streak-Badges freigeschaltet' : `N√§chster: ${next} üî•`;

  el.level.textContent = `Lv ${meta.level||1}`;
  el.xpLbl.textContent = `${meta.xp||0} / 100 XP`;
  el.xpProg.value = meta.xp||0;
  el.totalSessions.textContent = entries.length;

  renderBadges(stats);
}

/* ====== Tabelle rendern ====== */
function renderTable(){
  el.rows.innerHTML='';
  // Nach Datum sortieren, neueste zuerst
  const sortedEntries = entries.slice().sort((a,b)=>b.ts-a.ts);
  for(const [i,e] of sortedEntries.entries()){
    const d = new Date(e.ts);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="mono">${d.toLocaleDateString()}</td>
      <td class="mono">${e.dur??'‚Äî'}</td>
      <td class="mono">${e.hr??'‚Äî'}</td>
      <td class="mono">${e.speed??'‚Äî'}</td>
      <td class="mono">${e.watt??'‚Äî'}</td>
      <td><button data-ts="${e.ts}" class="btn btn-xs btn-ghost text-error btn-delete">l√∂schen</button></td>
    `;
    el.rows.appendChild(tr);
  }
  el.rows.querySelectorAll('.btn-delete').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const ts = Number(btn.getAttribute('data-ts'));
      el.deleteModal.showModal();
      el.btnConfirmDelete.onclick = () => {
        entries = entries.filter(e => e.ts !== ts);
        save(LS.entries, entries);
        renderTable();
        applyStats();
        el.deleteModal.close();
      };
    });
  });
}

/* ====== Eintrag speichern ====== */
function saveEntry(obj){
  const e = {
    ts: nowTS(),
    hr: obj.hr!=null? Number(obj.hr):null,
    dur: obj.dur!=null? Number(obj.dur):null,
    speed: obj.speed!=null? Number(obj.speed):null,
    watt: obj.watt!=null? Number(obj.watt):null,
    notes: obj.notes||null
  };
  if(e.hr==null && e.dur==null && e.speed==null && e.watt==null){
    toast(pick(TOASTS.warning), 'alert-warning'); return;
  }
  entries.unshift(e);
  save(LS.entries, entries);
  renderTable();
  updateXP(e);
  applyStats();
  const t = TONES[settings.tone]||TONES.gentle;
  toast(pick(t.save), 'alert-success');
}

/* ====== OCR-Ablauf ====== */
el.fileInput.addEventListener('change', ()=>{
  el.thumbs.innerHTML=''; el.ocrProg.classList.add('hidden'); el.ocrStatus.textContent='';
  const files = Array.from(el.fileInput.files||[]);
  files.slice(0,6).forEach(addThumb);
  if(files.length > 0) el.btnOcr.disabled = false;
  else el.btnOcr.disabled = true;
});

el.btnOcr.addEventListener('click', async ()=>{
  const files = Array.from(el.fileInput.files||[]);
  if(!files.length){ toast(pick(TOASTS.warning), 'alert-warning'); return; }
  el.btnOcr.disabled = true;
  el.ocrProg.classList.remove('hidden'); el.ocrProg.value=0; el.ocrStatus.textContent='OCR l√§uft‚Ä¶';
  let merged = { hr:null, dur:null, speed:null, watt:null, raw:'' };
  for(let i=0;i<files.length;i++){
    const f = files[i];
    const res = await Tesseract.recognize(f, 'eng', {
      logger: m => { if(m.status==='recognizing text' && m.progress!=null){ el.ocrProg.value = Math.round(((i+m.progress)/files.length)*100); } }
    });
    const text = res?.data?.text || '';
    merged.raw += (merged.raw?'\n----\n':'') + text;
    const p = parseOCRText(text);
    merged.hr = merged.hr ?? p.hr;
    merged.dur = merged.dur ?? p.dur;
    merged.speed = merged.speed ?? p.speed;
    merged.watt = merged.watt ?? p.watt;
  }
  el.ocrStatus.textContent='OCR fertig. Werte pr√ºfen & speichern.';
  if(merged.hr!=null) el.f_hr.value = merged.hr;
  if(merged.dur!=null) el.f_dur.value = Number(merged.dur.toFixed(1));
  if(merged.speed!=null) el.f_speed.value = merged.speed;
  if(merged.watt!=null) el.f_watt.value = merged.watt;
  el.btnOcr.disabled = false;
});

/* ====== Einstellungen / Theme ====== */
function applySettingsUI(){
  el.weeklyTarget.value = settings.weeklyTarget;
  el.themeSel.value = settings.theme || 'winter';
  document.documentElement.setAttribute('data-theme', el.themeSel.value);
  toneBtns.forEach(b=>{
    b.classList.toggle('btn-active-tone', b.dataset.tone===settings.tone);
  });
}
toneBtns.forEach(b=>b.addEventListener('click', ()=>{
  settings.tone = b.dataset.tone;
  applySettingsUI();
}));
el.btnSaveSettings.addEventListener('click', ()=>{
  settings.weeklyTarget = Math.max(20, Number(el.weeklyTarget.value)||140);
  settings.theme = el.themeSel.value;
  save(LS.settings, settings);
  toast(pick(TOASTS.info), 'alert-info');
  applyStats();
});
el.themeSel.addEventListener('change', ()=>{
  settings.theme = el.themeSel.value;
  document.documentElement.setAttribute('data-theme', settings.theme);
  save(LS.settings, settings);
});

/* ====== Exportieren / Importieren / L√∂schen ====== */
el.btnExport.addEventListener('click', ()=>{
  const payload = { version:1, settings, entries, meta };
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='z2_projekt.json'; a.click(); URL.revokeObjectURL(url);
  toast(pick(TOASTS.info), 'alert-info');
});
el.importFile.addEventListener('change', ()=>{
  const f = el.importFile.files?.[0]; if(!f) return;
  const r = new FileReader();
  r.onload = ()=> {
    try{
      const obj = JSON.parse(r.result);
      if(!obj || !Array.isArray(obj.entries)) throw new Error('Ung√ºltiges Projekt');
      settings = Object.assign({}, defSettings, obj.settings||{});
      entries = obj.entries||[];
      meta = Object.assign({ xp:0, level:1, unlocked:[] }, obj.meta||{});
      save(LS.settings, settings); save(LS.entries, entries); save(LS.meta, meta);
      applySettingsUI(); renderTable(); applyStats();
      toast(pick(TOASTS.info), 'alert-success'); confettiBurst();
    }catch(e){ toast(pick(TOASTS.error), 'alert-error'); }
  };
  r.readAsText(f);
});
el.btnClear.addEventListener('click', ()=>{
  if(!el.deleteModal.open) { el.deleteModal.showModal(); }
  el.btnConfirmDelete.onclick = () => {
    entries = []; meta = { xp:0, level:1, unlocked:[] };
    save(LS.entries, entries); save(LS.meta, meta);
    renderTable(); applyStats();
    toast(pick(TOASTS.info), 'alert-warning');
    el.deleteModal.close();
  };
});

/* ====== Schnell-Ausf√ºllen & Speichern ====== */
el.btnQuick115.addEventListener('click', ()=>{
  el.f_hr.value = 115; el.f_dur.value = 20;
  toast(pick(TOASTS.info), 'alert-info');
});
el.btnSave.addEventListener('click', ()=>{
  saveEntry({
    hr: el.f_hr.value || null,
    dur: el.f_dur.value || null,
    speed: el.f_speed.value || null,
    watt: el.f_watt.value || null,
    notes: el.f_notes.value || null
  });
});

/* ====== Initialisierung ====== */
applySettingsUI();
renderTable();
applyStats();
el.btnOcr.disabled = true;
</script>
</body>
</html>
