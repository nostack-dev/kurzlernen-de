<!DOCTYPE html>
<html lang="de" data-theme="winter">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Z2 Log – Cardio Log (Gamified)</title>
    <!-- Tailwind + DaisyUI via CDN für schnelles Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet">
    <!-- Font Awesome für Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <style>
        /* Grundstile für ein sauberes, mobil-orientiertes Design */
        .container { max-width: 980px; }
        .tap-big button, .tap-big .btn { min-height: 3rem; }
        .thumb { width: 48px; height: 48px; object-fit: cover; border-radius: .375rem; }
        .row-note { max-width: 220px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* Animationen für Gamification-Feedback */
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .pop-animation { animation: pop 0.3s ease-in-out; }
        
        /* Animation für den neuen Tabelleneintrag */
        @keyframes highlight-fade {
            0% { background-color: oklch(var(--a)); }
            50% { background-color: oklch(var(--a) / 0.5); }
            100% { background-color: transparent; }
        }
        .new-entry-highlight {
            animation: highlight-fade 2s ease-out forwards;
        }

        /* Stile für den Konfetti-Effekt (bleibt für die Erfolgs-Dialoge) */
        #confetti-container, #confetti-container-success {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 100;
        }
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: var(--fallback-p);
            animation-name: confetti-fall;
            animation-timing-function: linear;
            animation-fill-mode: forwards;
        }
        @keyframes confetti-fall {
            0% { transform: translate(0, -100vh) rotate(0deg); opacity: 1; }
            100% { transform: translate(0, 100vh) rotate(720deg); opacity: 0; }
        }
        
        /* Verbesserungen für die mobile Ansicht */
        @media (max-width: 420px){
            .hide-xs { display: none; }
            table th, table td { white-space: nowrap; }
            .stat { margin-bottom: 0.5rem; }
            .stats { flex-wrap: wrap; }
        }
    </style>
</head>
<body class="bg-base-100">
    <div class="container mx-auto p-4 md:p-6">

        <!-- Header / Theme / Benutzer -->
        <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
            <div>
                <h1 class="text-2xl font-bold">Z2 Log – Cardio</h1>
                <p class="text-sm opacity-70">Schnelle Eingabe mit Gamification.</p>
            </div>
            <div class="flex items-center gap-2">
                <label class="label text-sm">Theme</label>
                <select id="themeSelect" class="select select-bordered select-sm">
                    <option>winter</option><option>cupcake</option><option>emerald</option>
                    <option>corporate</option><option>dracula</option><option>night</option>
                </select>
            </div>
        </div>

        <div class="flex flex-wrap items-center gap-2 mb-3">
            <label class="label text-sm whitespace-nowrap">Benutzer</label>
            <select id="userSelect" class="select select-bordered select-sm"></select>
            <button id="btnNewUser" class="btn btn-sm">Neuer Benutzer</button>
            <div class="ml-auto flex flex-wrap items-center gap-2">
                <label class="label text-sm whitespace-nowrap">Körpergewicht (kg)</label>
                <input id="bodyWeight" type="number" min="0" class="input input-bordered input-sm w-24" placeholder="z.B. 75" />
                <label class="label text-sm">Wochenziel (Min)</label>
                <input id="weeklyTarget" type="number" min="0" class="input input-bordered input-sm w-24" />
                <button id="btnSaveSettings" class="btn btn-sm">Speichern</button>
            </div>
        </div>
        
        <!-- NEUER ABSCHNITT: Schnell-Eingabe-Einstellungen -->
        <div class="mt-6 mb-4 p-4 bg-base-200 rounded-lg">
            <h2 class="text-lg font-semibold mb-2">Schnell-Eingabe-Einstellungen</h2>
            <div class="flex flex-wrap items-center gap-4">
                <label class="form-control w-full sm:w-auto">
                    <div class="label"><span class="label-text">Watt-Stufe</span></div>
                    <div class="flex items-center gap-2">
                        <input id="quickLevel" type="range" min="1" max="8" value="1" step="1" class="range range-xs" />
                        <span id="wattValue" class="text-sm font-bold w-12 text-center">1</span>
                    </div>
                </label>
                <label class="form-control w-full sm:w-auto">
                    <div class="label"><span class="label-text">Dauer (Min)</span></div>
                    <input id="quickDuration" type="number" min="1" class="input input-bordered input-sm w-full sm:w-20" />
                </label>
                <label class="form-control w-full sm:w-auto">
                    <div class="label"><span class="label-text">Puls (bpm)</span></div>
                    <input id="quickHr" type="number" min="0" class="input input-bordered input-sm w-full sm:w-20" />
                </label>
            </div>
        </div>

        <!-- KPIs -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
            <div class="stat shadow">
                <div class="stat-title">Wochenminuten</div><div id="kpiWeekMin" class="stat-value">0</div>
            </div>
            <div class="stat shadow">
                <div class="stat-title">Streak</div><div id="kpiStreak" class="stat-value transition-all duration-300">0</div>
                <div class="stat-desc">Tage am Stück</div>
            </div>
            <div class="stat shadow">
                <div class="stat-title">Level</div><div class="stat-value">Lv <span id="kpiLevel" class="transition-all duration-300">1</span></div>
                <div class="stat-desc"><span id="kpiXp" class="transition-all duration-300">0</span> / 100 XP</div>
            </div>
            <div class="stat shadow">
                <div class="stat-title">Einträge</div><div id="kpiEntries" class="stat-value transition-all duration-300">0</div>
            </div>
        </div>

        <!-- CTA: Schnell-Eingabe öffnen -->
        <div class="tap-big mb-4">
            <button id="btnQuickSession" class="btn btn-primary w-full text-lg">✨ Training eintragen (schnell)</button>
        </div>

        <!-- Daten-Tools -->
        <div class="flex items-center justify-between mb-2">
            <h2 class="text-lg font-semibold">Deine Sessions</h2>
            <div class="join">
                <button id="btnExport" class="btn btn-sm join-item">Export</button>
                <input id="fileImport" class="hidden" type="file" accept="application/json">
                <button id="btnImport" class="btn btn-sm join-item">Importieren</button>
                <button id="btnWipeAll" class="btn btn-error btn-sm join-item">Sessions löschen</button>
            </div>
        </div>

        <!-- Tabelle -->
        <div class="overflow-x-auto">
            <table class="table w-full table-zebra">
                <thead>
                    <tr>
                        <th class="text-xs md:text-sm">Datum</th>
                        <th class="text-xs md:text-sm">Min</th>
                        <th class="text-xs md:text-sm">Ø Puls</th>
                        <th class="hide-xs text-xs md:text-sm">Watt</th>
                        <th class="hide-xs text-xs md:text-sm">Distanz (km)</th>
                        <th class="hide-xs text-xs md:text-sm">Kcal</th>
                        <th class="text-xs md:text-sm">Notizen</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="tbodySessions"></tbody>
            </table>
        </div>
        
        <!-- Belohnungen Section -->
        <h2 class="text-lg font-semibold mt-6 mb-2">Deine Belohnungen</h2>
        <div id="rewardsGrid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-4 mb-6">
            <!-- Belohnungen werden hier durch JS gerendert -->
        </div>

    </div>
    
    <!-- Modals -->
    <dialog id="dlgNewSession" class="modal">
        <div class="modal-box w-11/12 max-w-lg p-6">
            <form method="dialog">
                <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
            </form>
            <h3 id="sessionModalTitle" class="font-bold text-lg mb-4">Training eintragen (Manuell)</h3>
            
            <div class="form-control mb-4">
                <label class="label"><span class="label-text">Datum</span></label>
                <input id="sessionDate" type="date" class="input input-bordered" required />
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="form-control">
                    <label class="label"><span class="label-text">Dauer (Minuten)</span></label>
                    <input id="sessionDuration" type="number" min="1" class="input input-bordered" required />
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text">Durchschnittlicher Puls (bpm)</span></label>
                    <input id="sessionHr" type="number" min="0" class="input input-bordered" />
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text">Durchschnittliche Watt</span></label>
                    <input id="sessionWatt" type="number" min="0" class="input input-bordered" />
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text">Distanz (km)</span></label>
                    <input id="sessionDistance" type="number" step="0.1" class="input input-bordered" />
                </div>
            </div>
            
            <div class="form-control mt-4">
                <label class="label"><span class="label-text">Notizen</span></label>
                <textarea id="sessionNote" class="textarea textarea-bordered" placeholder="Notizen..."></textarea>
            </div>

            <div class="modal-action mt-6">
                <button id="btnSaveSession" class="btn btn-primary w-full text-lg">Eintrag speichern</button>
            </div>
        </div>
    </dialog>

    <!-- Neues Benutzer-Modal -->
    <dialog id="dlgNewUser" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Neuen Benutzer erstellen</h3>
            <label class="form-control mt-3">
                <span class="label-text">Name</span>
                <input id="newUserName" class="input input-bordered" placeholder="z. B. Christian">
            </label>
            <div class="modal-action">
                <form method="dialog"><button class="btn">Abbrechen</button></form>
                <button id="btnCreateUser" class="btn btn-primary">Erstellen</button>
            </div>
        </div>
    </dialog>
    
    <!-- Bild-Viewer -->
    <dialog id="dlgImage" class="modal">
        <div class="modal-box p-2 max-w-2xl">
            <img id="viewImg" class="w-full h-auto rounded-md" alt="Bild" />
            <form method="dialog" class="mt-2"><button class="btn w-full">Schließen</button></form>
        </div>
    </dialog>

    <!-- Bestätigungsdialog -->
    <dialog id="dlgConfirm" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg" id="confirmTitle"></h3>
            <p class="py-4" id="confirmText"></p>
            <div class="modal-action">
                <button class="btn" id="confirmCancel">Abbrechen</button>
                <button class="btn btn-primary" id="confirmOk">Bestätigen</button>
            </div>
        </div>
    </dialog>

    <!-- Erfolgs-/Erreichungs-Dialog -->
    <dialog id="dlgSuccess" class="modal">
        <div id="confetti-container-success"></div>
        <div class="modal-box text-center relative z-10">
            <h3 class="text-3xl font-bold mb-4" id="successTitle"></h3>
            <p class="text-xl mb-6" id="successText"></p>
            <i id="successIcon" class="text-6xl text-primary mb-6 animate-pulse"></i>
            <div class="modal-action justify-center mt-6">
                <form method="dialog"><button class="btn btn-primary">Super!</button></form>
            </div>
        </div>
    </dialog>

    <script type="module">
        // Christian Heinrich Hohlfeld, Konstanz Germany, 05.04.1983
        // Dieses Skript wurde komplett von Grund auf neu geschrieben, um eine 
        // robuste und gut kommentierte Version der App zu erstellen.
        // Es implementiert die Persistenz, die Gamification-Logik und die 
        // Interaktionen mit der Benutzeroberfläche.
        //
        // Wichtigste Änderungen in dieser Version:
        // - Möglichkeit zum Bearbeiten von Sessions hinzugefügt.
        // - Zentrale Funktion zur Aktualisierung aller UI-Elemente und Metriken nach jeder Änderung.
        // - Vereinfachtes manuelles Eingabemodal für Hinzufügen und Bearbeiten.

        // ========= Globale Variablen und Konstanten =========
        const STORAGE_KEY = 'z2log_v9_rebuilt_edited'; // Aktualisierter Version-Schlüssel
        const nowISO = () => new Date().toISOString();
        const uid = () => Math.random().toString(36).slice(2, 10);
        
        const DEFAULT_STATE = {
            activeUserId: 'default',
            users: {
                default: {
                    id: 'default', name: 'Christian', createdAt: nowISO(),
                    settings: { 
                        weeklyTarget: 140, theme: 'dracula', 
                        bodyWeight: 100,
                        quickLevel: 1, quickDuration: 20, quickHr: 115 
                    }, 
                    metrics: { level: 1, xp: 0, streakCount: 0, totalEntries: 0, lastDay: null },
                    sessions: [],
                    rewards: [] 
                }
            }
        };

        // Zustand der Anwendung. Wird beim Start geladen und bei Änderungen gespeichert.
        let state;
        let sessionBeingEdited = null; // Speichert die ID der Session, die gerade bearbeitet wird

        // ========= Persistenz =========
        /**
         * Lädt den Zustand aus dem Local Storage.
         * Stellt sicher, dass die Datenstruktur intakt ist.
         * @returns {object} Der geladene oder der Standardzustand.
         */
        function loadState() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                let loadedState = raw ? JSON.parse(raw) : structuredClone(DEFAULT_STATE);
                
                // Sicherstellen, dass die grundlegenden Strukturen existieren
                if (!loadedState.users || Object.keys(loadedState.users).length === 0) {
                    loadedState.users = structuredClone(DEFAULT_STATE.users);
                }
                if (!loadedState.activeUserId || !loadedState.users[loadedState.activeUserId]) {
                    loadedState.activeUserId = Object.keys(loadedState.users)[0];
                }

                // Sicherstellen, dass die neuen Standardwerte für jeden Benutzer vorhanden sind
                for (const userId in loadedState.users) {
                    if (!loadedState.users[userId].rewards) { loadedState.users[userId].rewards = []; }
                    const defaultSettings = DEFAULT_STATE.users.default.settings;
                    Object.keys(defaultSettings).forEach(key => {
                        if (loadedState.users[userId].settings[key] === undefined) {
                             loadedState.users[userId].settings[key] = defaultSettings[key];
                        }
                    });
                }
                
                return loadedState;
            } catch (e) {
                console.error("Fehler beim Laden des Zustands:", e);
                return structuredClone(DEFAULT_STATE);
            }
        }

        /**
         * Speichert den aktuellen Zustand im Local Storage.
         */
        function saveState() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        }

        // ========= UI-Hilfsfunktionen =========
        /**
         * Zeigt ein benutzerdefiniertes Bestätigungs-Dialogfeld an.
         * @param {string} title Der Titel des Dialogs.
         * @param {string} text Der Text des Dialogs.
         * @returns {Promise<boolean>} Resolves mit true bei Bestätigung, false bei Abbruch.
         */
        function showConfirmDialog(title, text) {
            return new Promise(resolve => {
                const dlg = document.getElementById('dlgConfirm');
                document.getElementById('confirmTitle').textContent = title;
                document.getElementById('confirmText').textContent = text;
                const confirmCancel = document.getElementById('confirmCancel');
                const confirmOk = document.getElementById('confirmOk');

                const handleConfirm = () => {
                    dlg.close();
                    confirmOk.removeEventListener('click', handleConfirm);
                    confirmCancel.removeEventListener('click', handleCancel);
                    resolve(true);
                };

                const handleCancel = () => {
                    dlg.close();
                    confirmOk.removeEventListener('click', handleConfirm);
                    confirmCancel.removeEventListener('click', handleCancel);
                    resolve(false);
                };

                confirmOk.addEventListener('click', handleConfirm);
                confirmCancel.addEventListener('click', handleCancel);
                dlg.showModal();
            });
        }

        /**
         * Zeigt ein benutzerdefiniertes Erfolgs-Dialogfeld für Errungenschaften an.
         * @param {string} title Der Titel des Dialogs.
         * @param {string} text Der Text des Dialogs.
         * @param {string} iconClass Die Font Awesome CSS-Klasse für das Icon.
         */
        function showSuccessDialog(title, text, iconClass) {
            const dlg = document.getElementById('dlgSuccess');
            document.getElementById('successTitle').textContent = title;
            document.getElementById('successText').textContent = text;
            const icon = document.getElementById('successIcon');
            icon.className = `text-6xl text-primary mb-6 animate-pulse ${iconClass}`;
            
            // Konfetti für Errungenschaften starten
            for(let i = 0; i < 50; i++) setTimeout(() => createConfetti('confetti-container-success'), i * 20);

            dlg.showModal();
        }

        /**
         * Erstellt einen Konfetti-Partikel.
         * @param {string} containerId ID des Konfetti-Containers.
         */
        function createConfetti(containerId) {
            const container = document.getElementById(containerId);
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = `${Math.random() * 100}vw`;
            confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
            confetti.style.animationDuration = `${Math.random() * 2 + 3}s`; // 3-5s
            confetti.style.transform = `translateY(-100vh) rotate(${Math.random() * 360}deg)`;
            container.appendChild(confetti);
            confetti.addEventListener('animationend', () => confetti.remove());
        }

        // ========= Gamification & Logik =========
        // Belohnungen (Rewards)
        const REWARDS = [
            { id: 'first_session', title: 'Erster Eintrag', desc: 'Absolviere deine erste Trainingseinheit.', icon: 'fas fa-medal', condition: (user) => user.metrics.totalEntries >= 1 },
            { id: 'weekly_target_hit', title: 'Wochenziel', desc: 'Erreiche dein Wochenziel von 75 Minuten.', icon: 'fas fa-trophy', condition: (user) => user.sessions.filter(s => isSameWeek(new Date(s.date), new Date())).reduce((sum, s) => sum + s.duration, 0) >= (user.settings.weeklyTarget || 75) },
            { id: '10_sessions', title: 'Zehn Sessions', desc: 'Absolviere 10 Trainingseinheiten.', icon: 'fas fa-fire-extinguisher', condition: (user) => user.metrics.totalEntries >= 10 },
            { id: 'first_streak', title: 'Erster Streak', desc: 'Trainiere an zwei aufeinanderfolgenden Tagen.', icon: 'fas fa-bolt', condition: (user) => user.metrics.streakCount >= 2 },
            { id: 'level_5', title: 'Level 5', desc: 'Erreiche Level 5.', icon: 'fas fa-star', condition: (user) => user.metrics.level >= 5 },
            { id: '10_streak', title: 'Zehn-Tage-Streak', desc: 'Trainiere an 10 aufeinanderfolgenden Tagen.', icon: 'fas fa-crown', condition: (user) => user.metrics.streakCount >= 10 },
            { id: '100_entries', title: 'Hundert Sessions', desc: 'Absolviere 100 Trainingseinheiten.', icon: 'fas fa-dumbbell', condition: (user) => user.metrics.totalEntries >= 100 },
            { id: 'max_level', title: 'Max Level!', desc: 'Erreiche Level 10.', icon: 'fas fa-gem', condition: (user) => user.metrics.level >= 10 },
        ];

        // Konstanten für Watt-Berechnung
        const WATT_BASE = 50;
        const WATT_STEP = 25;

        /**
         * Berechnet den Wattwert basierend auf der Stufe.
         * @param {number} level Die Stufe von 1 bis 8.
         * @returns {number} Der entsprechende Wattwert.
         */
        function getWattValue(level) {
            return WATT_BASE + (level - 1) * WATT_STEP;
        }

        /**
         * Berechnet die XP basierend auf der Session.
         * @param {object} session Die Session-Daten.
         * @returns {number} Die berechneten XP.
         */
        function calculateXp(session) {
            // Beispiel: XP = Minuten + (Watt * 0.5) + (Puls > 140 ? 10 : 0) + (Distanz * 2)
            let xp = session.duration;
            if (session.watt) xp += session.watt * 0.5;
            if (session.hr > 140) xp += 10;
            if (session.distance) xp += session.distance * 2;
            return Math.floor(xp);
        }

        /**
         * Zentralisierte Funktion, die den gesamten Zustand neu berechnet
         * und die UI aktualisiert. Dies stellt sicher, dass alle Daten konsistent sind.
         * @param {string | null} highlightId Die ID des Eintrags, der hervorgehoben werden soll.
         */
        function handleDataChange(highlightId = null) {
            const user = state.users[state.activeUserId];
            
            // 1. Metriken neu berechnen
            let totalEntries = user.sessions.length;
            let totalXp = 0;
            let streakCount = 0;
            let lastDay = null;

            // Sessions nach Datum sortieren, um Streak korrekt zu berechnen
            const sortedSessions = [...user.sessions].sort((a, b) => new Date(a.date) - new Date(b.date));
            sortedSessions.forEach(session => {
                totalXp += calculateXp(session);
                const sessionDate = new Date(session.date).toDateString();
                
                if (lastDay === null) {
                    streakCount = 1;
                } else {
                    const yesterday = new Date(new Date(lastDay).setDate(new Date(lastDay).getDate() + 1)).toDateString();
                    if (sessionDate === lastDay) {
                        // Eintrag am selben Tag, Streak bleibt
                    } else if (sessionDate === yesterday) {
                        streakCount++;
                    } else {
                        // Tag übersprungen, Streak zurücksetzen
                        streakCount = 1;
                    }
                }
                lastDay = sessionDate;
            });

            user.metrics.totalEntries = totalEntries;
            user.metrics.xp = totalXp;
            user.metrics.streakCount = streakCount;
            user.metrics.lastDay = lastDay;

            // Level basierend auf XP berechnen
            const newLevel = Math.floor(totalXp / 100) + 1;
            if (newLevel > user.metrics.level) {
                user.metrics.level = newLevel;
                showSuccessDialog(`Level ${newLevel} erreicht!`, `Du hast Level ${newLevel} erreicht. Weiter so!`, 'fas fa-level-up-alt');
            }

            // 2. Belohnungen überprüfen und freischalten
            REWARDS.forEach(reward => {
                // Nur Belohnungen überprüfen, die der Benutzer noch nicht hat
                if (!user.rewards.some(r => r.id === reward.id)) {
                    if (reward.condition(user)) {
                        user.rewards.push(reward);
                        showSuccessDialog(`Neue Belohnung freigeschaltet!`, `${reward.title}: ${reward.desc}`, reward.icon);
                    }
                }
            });

            // 3. UI rendern
            renderAll(highlightId);
            saveState();
        }

        // ========= Rendering-Funktionen =========
        /**
         * Rendert die Benutzer-Dropdown-Liste.
         */
        function renderUsers() {
            const userSelect = document.getElementById('userSelect');
            userSelect.innerHTML = '';
            for (const userId in state.users) {
                const user = state.users[userId];
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.name;
                userSelect.appendChild(option);
            }
            userSelect.value = state.activeUserId;
        }

        /**
         * Rendert die Benutzereinstellungen (Theme, Gewicht, Wochenziel).
         */
        function renderSettings() {
            const user = state.users[state.activeUserId];
            document.body.setAttribute('data-theme', user.settings.theme);
            document.getElementById('themeSelect').value = user.settings.theme;
            document.getElementById('bodyWeight').value = user.settings.bodyWeight;
            document.getElementById('weeklyTarget').value = user.settings.weeklyTarget;
            document.getElementById('quickDuration').value = user.settings.quickDuration;
            document.getElementById('quickHr').value = user.settings.quickHr;
            document.getElementById('quickLevel').value = user.settings.quickLevel;
            document.getElementById('wattValue').textContent = document.getElementById('quickLevel').value;
        }

        /**
         * Rendert die Liste der Sessions in der Tabelle.
         * @param {string | null} highlightId Die ID der Session, die hervorgehoben werden soll.
         */
        function renderSessions(highlightId = null) {
            const tbody = document.getElementById('tbodySessions');
            tbody.innerHTML = '';
            const user = state.users[state.activeUserId];
            
            // Sessions in absteigender Reihenfolge sortieren
            const sortedSessions = [...user.sessions].sort((a, b) => new Date(b.date) - new Date(a.date));

            sortedSessions.forEach(session => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-base-300 transition-colors duration-200 cursor-pointer';
                if (session.id === highlightId) {
                    tr.classList.add('new-entry-highlight');
                }
                tr.dataset.sessionId = session.id;

                const date = new Date(session.date);
                const dateStr = `${date.getDate().toString().padStart(2, '0')}.${(date.getMonth() + 1).toString().padStart(2, '0')}.`;

                tr.innerHTML = `
                    <td class="text-xs md:text-sm">${dateStr}</td>
                    <td class="text-xs md:text-sm">${session.duration} min</td>
                    <td class="text-xs md:text-sm">${session.hr || '-'} bpm</td>
                    <td class="hide-xs text-xs md:text-sm">${session.watt || '-'} W</td>
                    <td class="hide-xs text-xs md:text-sm">${session.distance ? session.distance.toFixed(1) : '-'} km</td>
                    <td class="hide-xs text-xs md:text-sm">${session.calories ? Math.round(session.calories) : '-'} Kcal</td>
                    <td class="text-xs md:text-sm row-note">${session.note || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-ghost btn-square btn-edit" data-id="${session.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        /**
         * Rendert die KPIs in den Statistiken-Karten.
         */
        function calculateAndRenderKPIs() {
            const user = state.users[state.activeUserId];
            const sessionsThisWeek = user.sessions.filter(s => isSameWeek(new Date(s.date), new Date()));
            const totalMinutesThisWeek = sessionsThisWeek.reduce((sum, s) => sum + s.duration, 0);
            
            document.getElementById('kpiWeekMin').textContent = totalMinutesThisWeek;
            document.getElementById('kpiStreak').textContent = user.metrics.streakCount;
            document.getElementById('kpiLevel').textContent = user.metrics.level;
            document.getElementById('kpiXp').textContent = user.metrics.xp % 100;
            document.getElementById('kpiEntries').textContent = user.metrics.totalEntries;
        }

        /**
         * Rendert die freigeschalteten und gesperrten Belohnungen.
         */
        function renderRewards() {
            const rewardsGrid = document.getElementById('rewardsGrid');
            rewardsGrid.innerHTML = '';
            const user = state.users[state.activeUserId];

            REWARDS.forEach(reward => {
                const isUnlocked = user.rewards.some(r => r.id === reward.id);
                const card = document.createElement('div');
                card.className = `card bg-base-100 shadow-xl ${isUnlocked ? '' : 'opacity-40'}`;
                card.innerHTML = `
                    <div class="card-body p-4 text-center">
                        <i class="card-icon text-4xl text-primary mx-auto mb-2 ${reward.icon}"></i>
                        <h3 class="font-bold text-sm">${reward.title}</h3>
                        <p class="text-xs opacity-70">${reward.desc}</p>
                    </div>
                `;
                rewardsGrid.appendChild(card);
            });
        }

        // ========= Event-Handler =========
        /**
         * Behandelt das Speichern einer neuen Session aus dem Modal.
         * @param {Event} e Das Klick-Event.
         */
        function saveSessionFromModal(e) {
            e.preventDefault();
            const date = document.getElementById('sessionDate').value;
            const duration = document.getElementById('sessionDuration').value;
            const hr = document.getElementById('sessionHr').value;
            const watt = document.getElementById('sessionWatt').value;
            const distance = document.getElementById('sessionDistance').value;
            const note = document.getElementById('sessionNote').value;

            const user = state.users[state.activeUserId];
            let session = {
                date: date || nowISO().split('T')[0],
                duration: parseInt(duration),
                hr: hr ? parseInt(hr) : null,
                watt: watt ? parseInt(watt) : null,
                distance: distance ? parseFloat(distance) : null,
                note: note
            };

            const bodyWeight = user.settings.bodyWeight || 75;
            // Einfache Kalorienformel: Kcal = (Dauer in Min) * (Watt-Äquivalent) * (Körpergewicht in kg)
            // Dies ist eine sehr grobe Schätzung
            if (session.watt) {
                session.calories = (session.duration / 60) * session.watt * bodyWeight * 0.001;
            } else if (session.distance) {
                // Schätzung basierend auf Distanz und Gewicht
                session.calories = session.distance * bodyWeight * 1.03;
            }

            if (sessionBeingEdited) {
                // Session bearbeiten
                const existingSessionIndex = user.sessions.findIndex(s => s.id === sessionBeingEdited);
                if (existingSessionIndex !== -1) {
                    session = { ...user.sessions[existingSessionIndex], ...session };
                    user.sessions[existingSessionIndex] = session;
                }
            } else {
                // Neue Session hinzufügen
                session.id = uid();
                session.createdAt = nowISO();
                user.sessions.push(session);
            }

            handleDataChange(session.id);
            document.getElementById('dlgNewSession').close();
            sessionBeingEdited = null;
        }

        /**
         * Behandelt die Schnell-Eingabe.
         */
        function handleQuickSession() {
            const user = state.users[state.activeUserId];
            const quickLevel = parseInt(document.getElementById('quickLevel').value);
            const quickDuration = parseInt(document.getElementById('quickDuration').value);
            const quickHr = parseInt(document.getElementById('quickHr').value);
            
            if (isNaN(quickDuration) || quickDuration <= 0) {
                // Keine Meldung, da das Modal geöffnet wird und die validierung dort stattfindet.
                // Stattdessen öffnen wir einfach das Modal für manuelle Eingabe
                openSessionModal();
                return;
            }

            // Wattwert aus Stufe berechnen
            const watt = getWattValue(quickLevel);

            const session = {
                id: uid(),
                createdAt: nowISO(),
                date: nowISO().split('T')[0],
                duration: quickDuration,
                hr: quickHr || null,
                watt: watt,
                distance: null, // Keine Distanz bei Schnell-Eingabe
                note: `Schnell-Eintrag (Stufe ${quickLevel})`
            };
            
            const bodyWeight = user.settings.bodyWeight || 75;
            session.calories = (session.duration / 60) * session.watt * bodyWeight * 0.001;

            user.sessions.push(session);
            
            // Einstellungen für den nächsten Schnell-Eintrag speichern
            user.settings.quickLevel = quickLevel;
            user.settings.quickDuration = quickDuration;
            user.settings.quickHr = quickHr;

            handleDataChange(session.id);
        }

        /**
         * Behandelt das Exportieren der Daten.
         */
        function exportData() {
            const dataStr = JSON.stringify(state, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `z2log_export_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        /**
         * Behandelt das Importieren der Daten.
         * @param {File} file Die zu importierende Datei.
         */
        function importData(file) {
            const reader = new FileReader();
            reader.onload = async (e) => {
                const content = e.target.result;
                try {
                    const importedState = JSON.parse(content);
                    if (await showConfirmDialog('Daten importieren?', 'Alle aktuellen Daten werden überschrieben. Bist du sicher?')) {
                        state = importedState;
                        saveState();
                        renderAll();
                    }
                } catch (err) {
                    showConfirmDialog('Import-Fehler', 'Ungültiges Dateiformat.');
                }
            };
            reader.readAsText(file);
        }

        /**
         * Löscht alle Daten nach Bestätigung.
         */
        async function wipeAllData() {
            if (await showConfirmDialog('Alle Daten löschen?', 'Dieser Vorgang kann nicht rückgängig gemacht werden. Möchtest du wirklich alle Sessions und Benutzerdaten unwiederbringlich löschen?')) {
                localStorage.removeItem(STORAGE_KEY);
                state = structuredClone(DEFAULT_STATE);
                renderAll();
            }
        }
        
        /**
         * Öffnet das Modal zum Hinzufügen oder Bearbeiten einer Session.
         * @param {object} session Die Session-Daten, falls eine Session bearbeitet wird.
         */
        function openSessionModal(session = null) {
            const dlg = document.getElementById('dlgNewSession');
            const title = document.getElementById('sessionModalTitle');
            const saveBtn = document.getElementById('btnSaveSession');
            
            // Setzt das Formular zurück
            const form = dlg.querySelector('form');
            form.reset();
            sessionBeingEdited = null;

            if (session) {
                // Bearbeiten-Modus
                title.textContent = 'Training bearbeiten';
                document.getElementById('sessionDate').value = session.date;
                document.getElementById('sessionDuration').value = session.duration;
                document.getElementById('sessionHr').value = session.hr || '';
                document.getElementById('sessionWatt').value = session.watt || '';
                document.getElementById('sessionDistance').value = session.distance || '';
                document.getElementById('sessionNote').value = session.note || '';
                sessionBeingEdited = session.id;
            } else {
                // Neu-Erstellen-Modus
                title.textContent = 'Training eintragen (Manuell)';
                document.getElementById('sessionDate').value = nowISO().split('T')[0];
                document.getElementById('sessionWatt').value = '';
                document.getElementById('sessionDistance').value = '';
                document.getElementById('sessionHr').value = '';
                document.getElementById('sessionDuration').value = '';
                document.getElementById('sessionNote').value = '';
            }
            
            dlg.showModal();
        }

        /**
         * Hilfsfunktion zum Vergleichen von Daten für Wochenziele.
         * @param {Date} d1 Datum 1.
         * @param {Date} d2 Datum 2.
         * @returns {boolean} True, wenn die Daten in der gleichen Kalenderwoche sind.
         */
        function isSameWeek(d1, d2) {
            const onejan = new Date(d1.getFullYear(), 0, 1);
            const d1Week = Math.ceil((((d1 - onejan) / 86400000) + onejan.getDay() + 1) / 7);
            const onejan2 = new Date(d2.getFullYear(), 0, 1);
            const d2Week = Math.ceil((((d2 - onejan2) / 86400000) + onejan2.getDay() + 1) / 7);
            return d1Week === d2Week && d1.getFullYear() === d2.getFullYear();
        }

        /**
         * Richtet alle Event-Listener der Anwendung ein.
         */
        function setupEventListeners() {
            // UI-Steuerungen
            document.getElementById('themeSelect').addEventListener('change', (e) => {
                state.users[state.activeUserId].settings.theme = e.target.value;
                document.body.setAttribute('data-theme', e.target.value);
                saveState();
            });

            document.getElementById('userSelect').addEventListener('change', (e) => {
                state.activeUserId = e.target.value;
                renderAll();
            });
            
            document.getElementById('btnNewUser').addEventListener('click', () => {
                const dlg = document.getElementById('dlgNewUser');
                dlg.showModal();
                document.getElementById('newUserName').focus();
            });

            document.getElementById('btnCreateUser').addEventListener('click', () => {
                const nameInput = document.getElementById('newUserName');
                const name = nameInput.value.trim();
                if (name) {
                    const newId = uid();
                    state.users[newId] = structuredClone(DEFAULT_STATE.users.default);
                    state.users[newId].id = newId;
                    state.users[newId].name = name;
                    state.activeUserId = newId;
                    renderAll();
                    document.getElementById('dlgNewUser').close();
                }
            });

            document.getElementById('btnSaveSettings').addEventListener('click', () => {
                const user = state.users[state.activeUserId];
                user.settings.bodyWeight = parseInt(document.getElementById('bodyWeight').value) || user.settings.bodyWeight;
                user.settings.weeklyTarget = parseInt(document.getElementById('weeklyTarget').value) || user.settings.weeklyTarget;
                saveState();
            });

            // Watt-Slider Event-Listener
            const quickLevelSlider = document.getElementById('quickLevel');
            const wattValueSpan = document.getElementById('wattValue');
            quickLevelSlider.addEventListener('input', (e) => {
                wattValueSpan.textContent = e.target.value;
            });

            // Session-Eingabe
            document.getElementById('btnQuickSession').addEventListener('click', handleQuickSession);

            // Event-Listener für das manuelle Hinzufügen einer Session
            document.getElementById('btnNewSession').addEventListener('click', () => {
                openSessionModal();
            });

            // Event-Delegation für die Tabelle
            document.getElementById('tbodySessions').addEventListener('click', (e) => {
                const editBtn = e.target.closest('.btn-edit');
                if (editBtn) {
                    const sessionId = editBtn.dataset.id;
                    const user = state.users[state.activeUserId];
                    const session = user.sessions.find(s => s.id === sessionId);
                    if (session) {
                        openSessionModal(session);
                    }
                }
            });

            // Event-Listener für Speichern aus dem Modal
            btnSaveSession.addEventListener('click', saveSessionFromModal);

            // Import/Export/Löschen
            btnExport.addEventListener('click', exportData);
            btnImport.addEventListener('click', () => fileImport.click());
            fileImport.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    importData(e.target.files[0]);
                }
            });
            btnWipeAll.addEventListener('click', wipeAllData);
        }

        /**
         * Rendert alle UI-Elemente neu.
         * @param {string} highlightId ID des Eintrags, der hervorgehoben werden soll.
         */
        function renderAll(highlightId = null) {
            renderUsers();
            renderSettings();
            renderSessions(highlightId);
            calculateAndRenderKPIs();
            renderRewards();
        }

        // ========= Initialisierung der Anwendung =========
        window.addEventListener('load', () => {
            state = loadState();
            setupEventListeners();
            renderAll();
        });
    </script>
</body>
</html>
